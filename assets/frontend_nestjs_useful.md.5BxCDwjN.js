import{_ as p,c as o,J as s,V as e,o as t,G as n}from"./chunks/framework.SV1ROkXV.js";const A=JSON.parse('{"title":"Nest实用手册","description":"使用nest解决通用的前端服务能力","frontmatter":{"title":"Nest实用手册","description":"使用nest解决通用的前端服务能力","keywords":"NestJS教程,node框架,Ioc架构,spring,NestJS MVC,NestJS优势,NestJS原理,装饰器原理","logo":"https://ihengshuai-demo1.oss-cn-beijing.aliyuncs.com/icon-nestjs.png"},"headers":[],"relativePath":"frontend/nestjs/useful.md","filePath":"frontend/nestjs/useful.md","lastUpdated":1709440279000}'),r={name:"frontend/nestjs/useful.md"},c=e(`<h1 id="nest实用手册" tabindex="-1">Nest实用手册 <a class="header-anchor" href="#nest实用手册" aria-label="Permalink to &quot;Nest实用手册&quot;">​</a></h1><p>NodeJS对于前端工程师来说是必不可少的技能，掌握node可以提高自己对前端的视野、架构能力和部署能力；通常在服务端node都需要做一些相关的配置，不限于跨域、日志、路由、静态资源压缩、部署等等，这里就来谈谈常见的配置</p><h2 id="跨域" tabindex="-1">跨域 <a class="header-anchor" href="#跨域" aria-label="Permalink to &quot;跨域&quot;">​</a></h2><p>浏览器端为提高资源请求的安全性提出了同源策略机制，即：非同源(域名、端口、协议)的请求会被视为跨域请求，将会被浏览器拦截。然后不同域名的请求越来越多，如何解决跨域请求</p><p>解决跨域可以使用代理服务器(如nginx)或服务端的支持，这里介绍下nest中如何配置跨域请求（<a href="https://blog.usword.cn/frontend/nginx/base.html#%E9%85%8D%E7%BD%AE%E8%B7%A8%E5%9F%9F" target="_blank" rel="noreferrer">nginx配置跨域传送门</a>）。在nest中其实和express配置跨域是一致的，底层都是使用了<code>cors</code>第三方库，这里介绍使用中间件和nest提供的方法</p><h3 id="基本配置" tabindex="-1">基本配置 <a class="header-anchor" href="#基本配置" aria-label="Permalink to &quot;基本配置&quot;">​</a></h3><ul><li><p>自定义中间件：</p><p>其实搞懂跨域本质配置跨域请求就很简单了，跨域会先进行<code>options</code>请求，浏览器根据相应的后<code>Access-Control-Allow-Origin</code>等头部信息进行判断是不是允许跨域。所以只要在options请求时快速返回且设置客户端的请求域名和端口时，浏览器就会判断已经允许跨域</p><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#C792EA;">async</span><span style="color:#C792EA;"> function</span><span style="color:#82AAFF;"> bootstrap</span><span style="color:#89DDFF;">()</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#C792EA;">  const</span><span style="color:#BABED8;"> app</span><span style="color:#89DDFF;"> =</span><span style="color:#89DDFF;font-style:italic;"> await</span><span style="color:#BABED8;"> NestFactory</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">create</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">NestExpressApplication</span><span style="color:#89DDFF;">&gt;</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">AppModule</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">  </span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  // 配置跨域</span></span>
<span class="line"><span style="color:#BABED8;">  app</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">use</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">req</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> Request</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;font-style:italic;"> res</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> Response</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;font-style:italic;"> next</span><span style="color:#89DDFF;">)</span><span style="color:#C792EA;"> =&gt;</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // 谁请求就设置 允许的源</span></span>
<span class="line"><span style="color:#BABED8;">    res</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setHeader</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">Access-Control-Allow-Origin</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> req</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">headers</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">origin</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // 设置请求允许的头</span></span>
<span class="line"><span style="color:#BABED8;">    res</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setHeader</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">Access-Control-Allow-Headers</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">X-Locale</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // 设置请求允许的方法</span></span>
<span class="line"><span style="color:#BABED8;">    res</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">header</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">Access-Control-Allow-Methods</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">PUT, POST, GET, DELETE, OPTIONS</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // options请求快速返回</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">    if</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">req</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">method</span><span style="color:#89DDFF;">?.</span><span style="color:#82AAFF;">toLowerCase</span><span style="color:#F07178;">() </span><span style="color:#89DDFF;">===</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">options</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">      res</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">sendStatus</span><span style="color:#F07178;">(</span><span style="color:#F78C6C;">200</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">      return</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">    }</span></span>
<span class="line"><span style="color:#82AAFF;">    next</span><span style="color:#F07178;">()</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div></li><li><p>nest的enableCors</p><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#BABED8;">app</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">enableCors</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">req</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> Request</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;font-style:italic;"> cb</span><span style="color:#89DDFF;">)</span><span style="color:#C792EA;"> =&gt;</span></span>
<span class="line"><span style="color:#82AAFF;">    cb</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">null,</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#F07178;">      origin</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> req</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">headers</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">origin</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">      methods</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> [</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">PUT, POST, GET, DELETE, OPTIONS</span><span style="color:#89DDFF;">&#39;</span><span style="color:#BABED8;">]</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">      allowedHeaders</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> [</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">x-locale</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">authorization</span><span style="color:#89DDFF;">&#39;</span><span style="color:#BABED8;">]</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">    }</span><span style="color:#BABED8;">)</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#BABED8;">)</span><span style="color:#89DDFF;">;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div></li></ul><h3 id="参考文档" tabindex="-1">参考文档 <a class="header-anchor" href="#参考文档" aria-label="Permalink to &quot;参考文档&quot;">​</a></h3><p><a href="https://docs.nestjs.com/security/cors" target="_blank" rel="noreferrer">https://docs.nestjs.com/security/cors</a></p><p><a href="https://github.com/expressjs/cors#configuration-options" target="_blank" rel="noreferrer">https://github.com/expressjs/cors#configuration-options</a></p><h2 id="静态资源" tabindex="-1">静态资源 <a class="header-anchor" href="#静态资源" aria-label="Permalink to &quot;静态资源&quot;">​</a></h2><p>nestjs默认底层框架使用express，可以使用<code>useStaticAssets</code>处理静态资源，也可以参考express的使用方式，其底层都是使用<a href="https://github.com/expressjs/serve-static" target="_blank" rel="noreferrer"><code>express/serve-static</code></a></p><h3 id="基本使用" tabindex="-1">基本使用 <a class="header-anchor" href="#基本使用" aria-label="Permalink to &quot;基本使用&quot;">​</a></h3><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#BABED8;">app</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">useStaticAssets</span><span style="color:#BABED8;">(</span><span style="color:#82AAFF;">join</span><span style="color:#BABED8;">(__dirname</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">..</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">public</span><span style="color:#89DDFF;">&#39;</span><span style="color:#BABED8;">))</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// more...</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>使用expressAPI处理和这个是一样的：</p><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#BABED8;">app</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">use</span><span style="color:#BABED8;">(express</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">static</span><span style="color:#BABED8;">(</span><span style="color:#82AAFF;">resolve</span><span style="color:#BABED8;">(__dirname</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">../public</span><span style="color:#89DDFF;">&#39;</span><span style="color:#BABED8;">)))</span><span style="color:#89DDFF;">;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>此方法也提供了可选的参数：</p><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#82AAFF;">useStaticAssets</span><span style="color:#BABED8;">(path: string</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> options</span><span style="color:#89DDFF;">?:</span><span style="color:#BABED8;"> ServeStaticOptions): </span><span style="color:#89DDFF;">this;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#C792EA;"> interface</span><span style="color:#FFCB6B;"> ServeStaticOptions</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#F07178;">    dotfiles</span><span style="color:#89DDFF;">?:</span><span style="color:#FFCB6B;"> string</span><span style="color:#89DDFF;">;</span><span style="color:#676E95;font-style:italic;"> // 点文件 ignore|deny|allow</span></span>
<span class="line"><span style="color:#F07178;">    etag</span><span style="color:#89DDFF;">?:</span><span style="color:#FFCB6B;"> boolean</span><span style="color:#89DDFF;">;</span><span style="color:#676E95;font-style:italic;"> // 默认true</span></span>
<span class="line"><span style="color:#F07178;">    extensions</span><span style="color:#89DDFF;">?:</span><span style="color:#FFCB6B;"> string</span><span style="color:#BABED8;">[]</span><span style="color:#89DDFF;">;</span><span style="color:#676E95;font-style:italic;"> // 文件扩展</span></span>
<span class="line"><span style="color:#F07178;">    fallthrough</span><span style="color:#89DDFF;">?:</span><span style="color:#FFCB6B;"> boolean</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    immutable</span><span style="color:#89DDFF;">?:</span><span style="color:#FFCB6B;"> boolean</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    index</span><span style="color:#89DDFF;">?:</span><span style="color:#FFCB6B;"> boolean</span><span style="color:#89DDFF;"> |</span><span style="color:#FFCB6B;"> string</span><span style="color:#89DDFF;"> |</span><span style="color:#FFCB6B;"> string</span><span style="color:#BABED8;">[]</span><span style="color:#89DDFF;">;</span><span style="color:#676E95;font-style:italic;"> // 路径访问 html</span></span>
<span class="line"><span style="color:#F07178;">    lastModified</span><span style="color:#89DDFF;">?:</span><span style="color:#FFCB6B;"> boolean</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    maxAge</span><span style="color:#89DDFF;">?:</span><span style="color:#FFCB6B;"> number</span><span style="color:#89DDFF;"> |</span><span style="color:#FFCB6B;"> string</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    setHeaders</span><span style="color:#89DDFF;">?:</span><span style="color:#89DDFF;"> (</span><span style="color:#BABED8;font-style:italic;">res</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> any</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;font-style:italic;"> path</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> string</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;font-style:italic;"> stat</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> any</span><span style="color:#89DDFF;">)</span><span style="color:#C792EA;"> =&gt;</span><span style="color:#FFCB6B;"> any</span><span style="color:#89DDFF;">;</span><span style="color:#676E95;font-style:italic;"> // 设置头信息</span></span>
<span class="line"><span style="color:#F07178;">    prefix</span><span style="color:#89DDFF;">?:</span><span style="color:#FFCB6B;"> string</span><span style="color:#89DDFF;">;</span><span style="color:#676E95;font-style:italic;"> // 路径前缀</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>可根据实际情况进行配置</p><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#BABED8;">app</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">useStaticAssets</span><span style="color:#BABED8;">(</span><span style="color:#82AAFF;">resolve</span><span style="color:#BABED8;">(__dirname</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">../public</span><span style="color:#89DDFF;">&#39;</span><span style="color:#BABED8;">)</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  // ...</span></span>
<span class="line"><span style="color:#F07178;">  setHeaders</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">res</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> Response</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;font-style:italic;"> path</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> string</span><span style="color:#89DDFF;">)</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">    if</span><span style="color:#F07178;"> (</span><span style="color:#89DDFF;">/</span><span style="color:#C3E88D;">.</span><span style="color:#89DDFF;">*</span><span style="color:#BABED8;">\\.</span><span style="color:#C3E88D;">html</span><span style="color:#89DDFF;">?</span><span style="color:#BABED8;">\\?</span><span style="color:#89DDFF;">?</span><span style="color:#C3E88D;">.</span><span style="color:#89DDFF;">*/</span><span style="color:#F78C6C;">i</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">test</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">path</span><span style="color:#F07178;">)) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">      res</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setHeader</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">Cache-Control</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">public, max-age=0</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">    }</span></span>
<span class="line"><span style="color:#89DDFF;">  },</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#BABED8;">)</span><span style="color:#89DDFF;">;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="资源压缩" tabindex="-1">资源压缩 <a class="header-anchor" href="#资源压缩" aria-label="Permalink to &quot;资源压缩&quot;">​</a></h3><p>使用压缩可以更好的减小响应内容的体积，但在生产环境高并发、nginx代理情况下不要使用</p><p>使用<code>compression</code>提供资源压缩功能：</p><div class="language-sh line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#FFCB6B;">➜</span><span style="color:#C3E88D;"> yarn add compression</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>使用：</p><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#BABED8;">app</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">use</span><span style="color:#BABED8;">(</span></span>
<span class="line"><span style="color:#82AAFF;">  compression</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#82AAFF;">    filter</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> (</span><span style="color:#BABED8;font-style:italic;">req</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> Request</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;font-style:italic;"> res</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> Response</span><span style="color:#89DDFF;">)</span><span style="color:#C792EA;"> =&gt;</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">      // 这些文件跳过不需要压缩</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">      if</span><span style="color:#F07178;"> (</span><span style="color:#89DDFF;">/</span><span style="color:#BABED8;">\\.</span><span style="color:#89DDFF;">(</span><span style="color:#C3E88D;">woff2</span><span style="color:#89DDFF;">|</span><span style="color:#C3E88D;">gz</span><span style="color:#89DDFF;">|</span><span style="color:#C3E88D;">robots</span><span style="color:#BABED8;">\\.</span><span style="color:#C3E88D;">txt</span><span style="color:#89DDFF;">?)/</span><span style="color:#F78C6C;">i</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">test</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">req</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">path</span><span style="color:#F07178;">)) </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#FF9CAC;"> false</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">      return</span><span style="color:#BABED8;"> compression</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">filter</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">req</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> res</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">    },</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span><span style="color:#BABED8;">)</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#BABED8;">)</span><span style="color:#89DDFF;">;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="gzip" tabindex="-1">Gzip <a class="header-anchor" href="#gzip" aria-label="Permalink to &quot;Gzip&quot;">​</a></h3><p>对于生产环境可以将资源打包成<code>.gz</code>格式的压缩文件，直接使用gz静态服务器，这样就可以减少压缩消耗的时间</p><p>生成gz压缩文件，这里介绍webpack中使用<code>compression-webpack-plugin</code>插件打包</p><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#BABED8;"> CompressionWebpackPlugin </span><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#89DDFF;"> &quot;</span><span style="color:#C3E88D;">compression-webpack-plugin</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// 使用插件</span></span>
<span class="line"><span style="color:#89DDFF;">new</span><span style="color:#82AAFF;"> CompressionWebpackPlugin</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  algorithm</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> &quot;</span><span style="color:#C3E88D;">gzip</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">  test</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> new</span><span style="color:#82AAFF;"> RegExp</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#BABED8;">\\\\</span><span style="color:#C3E88D;">.(js|css)$</span><span style="color:#89DDFF;">&quot;</span><span style="color:#BABED8;">)</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">  minRatio</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;"> 0.8</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#BABED8;">)</span><span style="color:#89DDFF;">;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>在node端使用gzip静态资源服务器：</p><div class="language-sh line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#FFCB6B;">➜</span><span style="color:#C3E88D;"> yarn add express-static-gzip</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>使用：</p><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#BABED8;">app</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">use</span><span style="color:#BABED8;">(</span></span>
<span class="line"><span style="color:#82AAFF;">  expressStaticGzip</span><span style="color:#BABED8;">(</span><span style="color:#82AAFF;">resolve</span><span style="color:#BABED8;">(__dirname</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">../public</span><span style="color:#89DDFF;">&#39;</span><span style="color:#BABED8;">)</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#F07178;">    index</span><span style="color:#89DDFF;">:</span><span style="color:#FF9CAC;"> false</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span><span style="color:#BABED8;">)</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#BABED8;">)</span><span style="color:#89DDFF;">;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="参考文档-1" tabindex="-1">参考文档 <a class="header-anchor" href="#参考文档-1" aria-label="Permalink to &quot;参考文档&quot;">​</a></h3><ul><li><a href="https://docs.nestjs.com/techniques/mvc" target="_blank" rel="noreferrer">https://docs.nestjs.com/techniques/mvc</a></li><li><a href="https://docs.nestjs.com/techniques/compression" target="_blank" rel="noreferrer">https://docs.nestjs.com/techniques/compression</a></li><li><a href="https://github.com/expressjs/compression" target="_blank" rel="noreferrer">https://github.com/expressjs/compression</a></li><li><a href="https://github.com/expressjs/serve-static" target="_blank" rel="noreferrer">https://github.com/expressjs/serve-static</a></li><li><a href="https://github.com/tkoenig89/express-static-gzip" target="_blank" rel="noreferrer">https://github.com/tkoenig89/express-static-gzip</a></li></ul><h2 id="文件上传与下载" tabindex="-1">文件上传与下载 <a class="header-anchor" href="#文件上传与下载" aria-label="Permalink to &quot;文件上传与下载&quot;">​</a></h2><p>nest提供了http传输的<code>multipart/form-data</code>文件进行获取的中间件，以及处理流内容的方式</p><h3 id="流文件" tabindex="-1">流文件 <a class="header-anchor" href="#流文件" aria-label="Permalink to &quot;流文件&quot;">​</a></h3><p>通常服务端返回流内容都是直接返回文件或者使用流对象pipe到响应对象，使用nest的<a href="https://docs.nestjs.com/techniques/streaming-files" target="_blank" rel="noreferrer">StreamableFile</a>方法可以快速的对流内容响应</p><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#89DDFF;"> {</span><span style="color:#BABED8;"> Controller</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> Get</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> StreamableFile</span><span style="color:#89DDFF;"> }</span><span style="color:#89DDFF;font-style:italic;"> from</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">@nestjs/common</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#89DDFF;"> {</span><span style="color:#BABED8;"> createReadStream</span><span style="color:#89DDFF;"> }</span><span style="color:#89DDFF;font-style:italic;"> from</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">fs</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#89DDFF;"> {</span><span style="color:#BABED8;"> join</span><span style="color:#89DDFF;"> }</span><span style="color:#89DDFF;font-style:italic;"> from</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">path</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">@</span><span style="color:#82AAFF;">Controller</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">file</span><span style="color:#89DDFF;">&#39;</span><span style="color:#BABED8;">)</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#C792EA;"> class</span><span style="color:#FFCB6B;"> FileController</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#89DDFF;">  @</span><span style="color:#82AAFF;">Get</span><span style="color:#BABED8;">()</span></span>
<span class="line"><span style="color:#F07178;">  getFile</span><span style="color:#89DDFF;">(@</span><span style="color:#82AAFF;">Res</span><span style="color:#BABED8;">() </span><span style="color:#BABED8;font-style:italic;">res</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> Response</span><span style="color:#89DDFF;">)</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#C792EA;">    const</span><span style="color:#BABED8;"> file</span><span style="color:#89DDFF;"> =</span><span style="color:#82AAFF;"> createReadStream</span><span style="color:#F07178;">(</span><span style="color:#82AAFF;">join</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">process</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">cwd</span><span style="color:#F07178;">()</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">package.json</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">))</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">    return</span><span style="color:#89DDFF;"> new</span><span style="color:#82AAFF;"> StreamableFile</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">file</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>以上代码使用原声写法如下：</p><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#89DDFF;">@</span><span style="color:#82AAFF;">Controller</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">file</span><span style="color:#89DDFF;">&#39;</span><span style="color:#BABED8;">)</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#C792EA;"> class</span><span style="color:#FFCB6B;"> FileController</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#89DDFF;">  @</span><span style="color:#82AAFF;">Get</span><span style="color:#BABED8;">()</span></span>
<span class="line"><span style="color:#F07178;">  getFile</span><span style="color:#89DDFF;">(@</span><span style="color:#82AAFF;">Res</span><span style="color:#BABED8;">() </span><span style="color:#BABED8;font-style:italic;">res</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> Response</span><span style="color:#89DDFF;">)</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#C792EA;">    const</span><span style="color:#BABED8;"> file</span><span style="color:#89DDFF;"> =</span><span style="color:#82AAFF;"> createReadStream</span><span style="color:#F07178;">(</span><span style="color:#82AAFF;">join</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">process</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">cwd</span><span style="color:#F07178;">()</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">package.json</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">))</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#BABED8;">    file</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">pipe</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">res</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="文件上传" tabindex="-1">文件上传 <a class="header-anchor" href="#文件上传" aria-label="Permalink to &quot;文件上传&quot;">​</a></h3><p>nest提供了<a href="https://docs.nestjs.com/techniques/file-upload" target="_blank" rel="noreferrer">FileInterceptor</a>对文件类型进行处理，以及<code>@UploadedFile</code>装饰器对文件参数的注入</p><p>安装模块类型文件：</p><div class="language-sh line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#FFCB6B;">➜</span><span style="color:#C3E88D;"> npm i -D @types/multer</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>模拟场景使用：</p><ol><li><p>假如前端使用formdata上传文件：</p><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#C792EA;">const</span><span style="color:#BABED8;"> formData </span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;"> new</span><span style="color:#82AAFF;"> FormData</span><span style="color:#BABED8;">()</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#BABED8;">formData</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">append</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">file</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> file)</span><span style="color:#89DDFF;">;</span><span style="color:#676E95;font-style:italic;"> // 假设这个是文件</span></span>
<span class="line"><span style="color:#BABED8;">formData</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">append</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">name</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">sky.png</span><span style="color:#89DDFF;">&#39;</span><span style="color:#BABED8;">)</span><span style="color:#89DDFF;">;</span><span style="color:#676E95;font-style:italic;"> // 文件名</span></span>
<span class="line"><span style="color:#BABED8;">formData</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">append</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">type</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">image</span><span style="color:#89DDFF;">&#39;</span><span style="color:#BABED8;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// 上传</span></span>
<span class="line"><span style="color:#82AAFF;">fetch</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">/上传接口</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;"> {</span><span style="color:#F07178;"> data</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> formData </span><span style="color:#89DDFF;">}</span><span style="color:#BABED8;">)</span><span style="color:#89DDFF;">;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div></li><li><p>后端获取文件和其他信息：</p></li></ol><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#89DDFF;">@</span><span style="color:#82AAFF;">Post</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">upload</span><span style="color:#89DDFF;">&#39;</span><span style="color:#BABED8;">)</span></span>
<span class="line"><span style="color:#89DDFF;">@</span><span style="color:#82AAFF;">UseInterceptors</span><span style="color:#BABED8;">(</span><span style="color:#82AAFF;">FileInterceptor</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">file</span><span style="color:#89DDFF;">&#39;</span><span style="color:#BABED8;">)) </span><span style="color:#676E95;font-style:italic;">// 文件转换要对应传过来的key</span></span>
<span class="line"><span style="color:#82AAFF;">uploadFile</span><span style="color:#BABED8;">(@</span><span style="color:#82AAFF;">Body</span><span style="color:#BABED8;">() body:any</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> @</span><span style="color:#82AAFF;">UploadedFile</span><span style="color:#BABED8;">() file: Express</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">Multer</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">File) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">  console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">file</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span><span style="color:#676E95;font-style:italic;"> // 这里可以获取到formdata中的 file字段的文件</span></span>
<span class="line"><span style="color:#BABED8;">  console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">body</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span><span style="color:#676E95;font-style:italic;"> // 获取formdata中其他的字段</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h2 id="websocket" tabindex="-1">websocket <a class="header-anchor" href="#websocket" aria-label="Permalink to &quot;websocket&quot;">​</a></h2><p>nest封装了<a href="https://docs.nestjs.com/websockets/gateways" target="_blank" rel="noreferrer">websocket</a>功能，使用<code>@WebSocketGateway</code>装饰的类就拥有了websocket能力，它和使用具体的库没有关系，如ws、socketio，每一种库都可以适配WebSocketGateway</p><p>这里使用ws作用底层的库使用</p><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#89DDFF;"> {</span><span style="color:#BABED8;"> Module</span><span style="color:#89DDFF;"> }</span><span style="color:#89DDFF;font-style:italic;"> from</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">@nestjs/common</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#89DDFF;"> {</span><span style="color:#BABED8;"> SocketController</span><span style="color:#89DDFF;"> }</span><span style="color:#89DDFF;font-style:italic;"> from</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">./socket.controller</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">@</span><span style="color:#82AAFF;">Module</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  providers</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> [SocketController]</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#BABED8;">)</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#C792EA;"> class</span><span style="color:#FFCB6B;"> SocketModule</span><span style="color:#89DDFF;"> {}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// 定义网关</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#BABED8;">  MessageBody</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#BABED8;">  SubscribeMessage</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#BABED8;">  WebSocketGateway</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#BABED8;">  WebSocketServer</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#89DDFF;font-style:italic;"> from</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">@nestjs/websockets</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#89DDFF;"> {</span><span style="color:#BABED8;"> IncomingMessage</span><span style="color:#89DDFF;"> }</span><span style="color:#89DDFF;font-style:italic;"> from</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">http</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// import { Server } from &#39;socket.io&#39;;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#89DDFF;"> {</span><span style="color:#BABED8;"> GlobalConfiguration</span><span style="color:#89DDFF;"> }</span><span style="color:#89DDFF;font-style:italic;"> from</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">src/config</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#89DDFF;"> {</span><span style="color:#BABED8;"> Server</span><span style="color:#89DDFF;"> }</span><span style="color:#89DDFF;font-style:italic;"> from</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">ws</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#BABED8;"> globalConfig </span><span style="color:#89DDFF;">=</span><span style="color:#82AAFF;"> GlobalConfiguration</span><span style="color:#BABED8;">()</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">@</span><span style="color:#82AAFF;">WebSocketGateway</span><span style="color:#BABED8;">(globalConfig</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">PORT)</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#C792EA;"> class</span><span style="color:#FFCB6B;"> SocketController</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#89DDFF;">  @</span><span style="color:#82AAFF;">WebSocketServer</span><span style="color:#BABED8;">()</span></span>
<span class="line"><span style="color:#F07178;">  server</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> Server</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  // 连接</span></span>
<span class="line"><span style="color:#C792EA;">  async</span><span style="color:#F07178;"> handleConnection</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">client</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> WebSocket</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;font-style:italic;"> request</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> IncomingMessage</span><span style="color:#89DDFF;">)</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // console.log(request.url);</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  @</span><span style="color:#82AAFF;">SubscribeMessage</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">people</span><span style="color:#89DDFF;">&#39;</span><span style="color:#BABED8;">)</span></span>
<span class="line"><span style="color:#F07178;">  sendMessage</span><span style="color:#89DDFF;">()</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">    return</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#F07178;">      name</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">socket</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">      date</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> +new</span><span style="color:#82AAFF;"> Date</span><span style="color:#F07178;">()</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">    };</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  @</span><span style="color:#82AAFF;">SubscribeMessage</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">message</span><span style="color:#89DDFF;">&#39;</span><span style="color:#BABED8;">)</span></span>
<span class="line"><span style="color:#C792EA;">  async</span><span style="color:#F07178;"> transferMessage</span><span style="color:#89DDFF;">(@</span><span style="color:#82AAFF;">MessageBody</span><span style="color:#BABED8;">() </span><span style="color:#BABED8;font-style:italic;">body</span><span style="color:#89DDFF;">)</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#BABED8;">    console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#F07178;">(</span><span style="color:#F78C6C;">1111</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> body</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // await new Promise((resolve) =&gt; setTimeout(resolve, 1500));</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">    return</span><span style="color:#F78C6C;"> 2</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br></div></div><h2 id="部署" tabindex="-1">部署 <a class="header-anchor" href="#部署" aria-label="Permalink to &quot;部署&quot;">​</a></h2><p>nodejs通常都是使用<a href="https://pm2.keymetrics.io/docs/usage/pm2-doc-single-page/" target="_blank" rel="noreferrer">pm2</a>进行托管，部署通常都会使用docker+pm2+k8s形式进行配置</p><p>配置pm2：</p><div class="language-json line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#89DDFF;">	&quot;</span><span style="color:#C792EA;">apps</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> [</span></span>
<span class="line"><span style="color:#89DDFF;">		{</span></span>
<span class="line"><span style="color:#89DDFF;">			&quot;</span><span style="color:#FFCB6B;">name</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> &quot;</span><span style="color:#C3E88D;">nest-web</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">			&quot;</span><span style="color:#FFCB6B;">script</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> &quot;</span><span style="color:#C3E88D;">dist/main.js</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">			&quot;</span><span style="color:#FFCB6B;">watch</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> false,</span></span>
<span class="line"><span style="color:#89DDFF;">			&quot;</span><span style="color:#FFCB6B;">instance</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;"> 2</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">			&quot;</span><span style="color:#FFCB6B;">autorestart</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> true,</span></span>
<span class="line"><span style="color:#89DDFF;">			&quot;</span><span style="color:#FFCB6B;">max_memory_restart</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> &quot;</span><span style="color:#C3E88D;">1G</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">			&quot;</span><span style="color:#FFCB6B;">env</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#89DDFF;">				&quot;</span><span style="color:#F78C6C;">NODE_ENV</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> &quot;</span><span style="color:#C3E88D;">development</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#89DDFF;">			},</span></span>
<span class="line"><span style="color:#89DDFF;">			&quot;</span><span style="color:#FFCB6B;">env_production</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#89DDFF;">				&quot;</span><span style="color:#F78C6C;">NODE_ENV</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> &quot;</span><span style="color:#C3E88D;">production</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#89DDFF;">			}</span></span>
<span class="line"><span style="color:#89DDFF;">		}</span></span>
<span class="line"><span style="color:#89DDFF;">	]</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>配置docker：</p><div class="language-dockerfile line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">dockerfile</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#F78C6C;">FROM</span><span style="color:#BABED8;"> node:16-alpine3.18 </span><span style="color:#F78C6C;">AS</span><span style="color:#BABED8;"> base</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">ENV</span><span style="color:#BABED8;"> TZ=Asia/Shanghai</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">WORKDIR</span><span style="color:#BABED8;"> /app</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 需与配置文件中的SERVER_PORT对应</span></span>
<span class="line"><span style="color:#F78C6C;">EXPOSE</span><span style="color:#BABED8;"> 9999</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># COPY public .</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># COPY src .</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># COPY package.json .</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># COPY pm2.json .</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># COPY nest-cli.json /app/nest-cli.json</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># COPY tsconfig.json /app/tsconfig.json</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># COPY tsconfig.build.json /app/tsconfig.build.json</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># RUN echo pwd</span></span>
<span class="line"><span style="color:#F78C6C;">COPY</span><span style="color:#BABED8;"> . .</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">RUN</span><span style="color:#BABED8;"> yarn</span></span>
<span class="line"><span style="color:#F78C6C;">RUN</span><span style="color:#BABED8;"> yarn build</span></span>
<span class="line"><span style="color:#F78C6C;">RUN</span><span style="color:#BABED8;"> yarn global add pm2</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">ENTRYPOINT</span><span style="color:#BABED8;"> [</span><span style="color:#C3E88D;">&quot;pm2-runtime&quot;</span><span style="color:#BABED8;">, </span><span style="color:#C3E88D;">&quot;start&quot;</span><span style="color:#BABED8;">, </span><span style="color:#C3E88D;">&quot;pm2.json&quot;</span><span style="color:#BABED8;">, </span><span style="color:#C3E88D;">&quot;--env&quot;</span><span style="color:#BABED8;">, </span><span style="color:#C3E88D;">&quot;production&quot;</span><span style="color:#BABED8;">]</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>打包镜像：</p><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#BABED8;">➜ general</span><span style="color:#89DDFF;">-</span><span style="color:#BABED8;">mac nestjs</span><span style="color:#89DDFF;">-</span><span style="color:#BABED8;">practive </span><span style="color:#FFCB6B;">git</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;">(dev) ✗ docker build </span><span style="color:#89DDFF;">-</span><span style="color:#BABED8;">t nest</span><span style="color:#89DDFF;">-</span><span style="color:#BABED8;">template </span><span style="color:#89DDFF;">.</span></span>
<span class="line"><span style="color:#BABED8;">[</span><span style="color:#89DDFF;">+</span><span style="color:#BABED8;">] Building 177</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">5</span><span style="color:#82AAFF;">s</span><span style="color:#BABED8;"> (</span><span style="color:#F78C6C;">11</span><span style="color:#89DDFF;">/</span><span style="color:#F78C6C;">11</span><span style="color:#BABED8;">) FINISHED                                                                                                  </span><span style="color:#FFCB6B;">docker</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;font-style:italic;">default</span></span>
<span class="line"><span style="color:#C792EA;"> =&gt;</span><span style="color:#BABED8;"> [internal] load build definition from Dockerfile                                                                                            0</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">0s</span></span>
<span class="line"><span style="color:#C792EA;"> =&gt;</span><span style="color:#C792EA;"> =&gt;</span><span style="color:#BABED8;"> transferring </span><span style="color:#FFCB6B;">dockerfile</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> 772B                                                                                                            0</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">0s</span></span>
<span class="line"><span style="color:#C792EA;"> =&gt;</span><span style="color:#BABED8;"> [internal] load </span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">dockerignore                                                                                                               0</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">0s</span></span>
<span class="line"><span style="color:#C792EA;"> =&gt;</span><span style="color:#C792EA;"> =&gt;</span><span style="color:#BABED8;"> transferring </span><span style="color:#FFCB6B;">context</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> 177B                                                                                                               0</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">0s</span></span>
<span class="line"><span style="color:#C792EA;"> =&gt;</span><span style="color:#BABED8;"> [internal] load metadata for docker</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">io</span><span style="color:#89DDFF;">/</span><span style="color:#BABED8;">library</span><span style="color:#89DDFF;">/</span><span style="color:#FFCB6B;">node</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">16</span><span style="color:#89DDFF;">-</span><span style="color:#BABED8;">alpine3</span><span style="color:#89DDFF;">.</span><span style="color:#F78C6C;">18</span><span style="color:#BABED8;">                                                                          17</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">6s</span></span>
<span class="line"><span style="color:#C792EA;"> =&gt;</span><span style="color:#BABED8;"> [</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">/</span><span style="color:#F78C6C;">6</span><span style="color:#BABED8;">] FROM docker</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">io</span><span style="color:#89DDFF;">/</span><span style="color:#BABED8;">library</span><span style="color:#89DDFF;">/</span><span style="color:#FFCB6B;">node</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;">16</span><span style="color:#89DDFF;">-</span><span style="color:#BABED8;">alpine3</span><span style="color:#89DDFF;">.</span><span style="color:#F78C6C;">18</span><span style="color:#BABED8;">@</span><span style="color:#FFCB6B;">sha256</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;">6c381d5dc2a11dcdb693f0301e8587e43f440c90cdb8933eaaaabb905d44cdb9                     0</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">0s</span></span>
<span class="line"><span style="color:#C792EA;"> =&gt;</span><span style="color:#BABED8;"> [internal] load build context                                                                                                               0</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">0s</span></span>
<span class="line"><span style="color:#C792EA;"> =&gt;</span><span style="color:#C792EA;"> =&gt;</span><span style="color:#BABED8;"> transferring </span><span style="color:#FFCB6B;">context</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> 2</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">78kB                                                                                                             0</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">0s</span></span>
<span class="line"><span style="color:#C792EA;"> =&gt;</span><span style="color:#BABED8;"> CACHED [</span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">/</span><span style="color:#F78C6C;">6</span><span style="color:#BABED8;">] WORKDIR </span><span style="color:#89DDFF;">/</span><span style="color:#BABED8;">app                                                                                                                   0</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">0s</span></span>
<span class="line"><span style="color:#C792EA;"> =&gt;</span><span style="color:#BABED8;"> CACHED [</span><span style="color:#F78C6C;">3</span><span style="color:#89DDFF;">/</span><span style="color:#F78C6C;">6</span><span style="color:#BABED8;">] COPY </span><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;"> .</span><span style="color:#BABED8;">                                                                                                                       0</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">0s</span></span>
<span class="line"><span style="color:#C792EA;"> =&gt;</span><span style="color:#BABED8;"> CACHED [</span><span style="color:#F78C6C;">4</span><span style="color:#89DDFF;">/</span><span style="color:#F78C6C;">6</span><span style="color:#BABED8;">] RUN yarn                                                                                                                       0</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">0s</span></span>
<span class="line"><span style="color:#C792EA;"> =&gt;</span><span style="color:#BABED8;"> CACHED [</span><span style="color:#F78C6C;">5</span><span style="color:#89DDFF;">/</span><span style="color:#F78C6C;">6</span><span style="color:#BABED8;">] RUN yarn build                                                                                                                 0</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">0s</span></span>
<span class="line"><span style="color:#C792EA;"> =&gt;</span><span style="color:#BABED8;"> [</span><span style="color:#F78C6C;">6</span><span style="color:#89DDFF;">/</span><span style="color:#F78C6C;">6</span><span style="color:#BABED8;">] RUN yarn global add pm2                                                                                                             153</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">8s</span></span>
<span class="line"><span style="color:#C792EA;"> =&gt;</span><span style="color:#BABED8;"> exporting to image                                                                                                                          6</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">0s</span></span>
<span class="line"><span style="color:#C792EA;"> =&gt;</span><span style="color:#C792EA;"> =&gt;</span><span style="color:#BABED8;"> exporting layers                                                                                                                         6</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">0s</span></span>
<span class="line"><span style="color:#C792EA;"> =&gt;</span><span style="color:#C792EA;"> =&gt;</span><span style="color:#BABED8;"> writing image </span><span style="color:#FFCB6B;">sha256</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;">ffb09b4da10527b212eda87e2b239bc6ae36748e769f203b21e384a66b349ff8                                                    0</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">0s</span></span>
<span class="line"><span style="color:#C792EA;"> =&gt;</span><span style="color:#C792EA;"> =&gt;</span><span style="color:#BABED8;"> naming to docker</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">io</span><span style="color:#89DDFF;">/</span><span style="color:#BABED8;">library</span><span style="color:#89DDFF;">/</span><span style="color:#BABED8;">nest</span><span style="color:#89DDFF;">-</span><span style="color:#BABED8;">template</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>项目中一般都会有<code>.gitlab.yml</code>配置，当提交代码时就会自动触发打包机制，最终根据不同环境部署到k8s集群</p><p>🎍后续会不断补充相关知识...</p>`,64);function F(D,y,i,b,B,u){const a=n("Reward"),l=n("Gitalk");return t(),o("div",null,[c,s(a),s(l)])}const d=p(r,[["render",F]]);export{A as __pageData,d as default};
