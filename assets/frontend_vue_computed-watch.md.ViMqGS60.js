import{_ as p,c as e,J as s,V as o,o as t,G as n}from"./chunks/framework.SV1ROkXV.js";const A=JSON.parse('{"title":"Vueæºç åˆ†æä¹‹è®¡ç®—å±æ€§ä¸ä¾¦å¬å‡½æ•°","description":"Vueåº”ç”¨ä¸­é™¤äº†ä½¿ç”¨dataæ¥å®ç°å“åº”å¼å¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨computedã€watchå®ç°å¯¹dataçš„ç›‘å¬å¹¶è§¦å‘å¯¹åº”çš„å›è°ƒå‡½æ•°ï¼Œé‚£å®ƒä»¬å†…éƒ¨åˆæ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿæ¥ä¸‹æ¥ä¸€èµ·æ¥æ¢ç´¢å®ç°åŸç†å§","frontmatter":{"title":"Vueæºç åˆ†æä¹‹è®¡ç®—å±æ€§ä¸ä¾¦å¬å‡½æ•°","description":"Vueåº”ç”¨ä¸­é™¤äº†ä½¿ç”¨dataæ¥å®ç°å“åº”å¼å¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨computedã€watchå®ç°å¯¹dataçš„ç›‘å¬å¹¶è§¦å‘å¯¹åº”çš„å›è°ƒå‡½æ•°ï¼Œé‚£å®ƒä»¬å†…éƒ¨åˆæ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿæ¥ä¸‹æ¥ä¸€èµ·æ¥æ¢ç´¢å®ç°åŸç†å§","keywords":"vueè®¡ç®—å±æ€§,vueä¾¦å¬å‡½æ•°,computed,watch,è®¡ç®—å±æ€§åŸç†,computedåŸç†,computedç¼“å­˜åŸç†,watchåŸç†","logo":"https://ihengshuai-demo1.oss-cn-beijing.aliyuncs.com/icon-vue.png"},"headers":[],"relativePath":"frontend/vue/computed-watch.md","filePath":"frontend/vue/computed-watch.md","lastUpdated":1709440279000}'),c={name:"frontend/vue/computed-watch.md"},r=o(`<h1 id="vueæºç åˆ†æä¹‹è®¡ç®—å±æ€§ä¸ä¾¦å¬å‡½æ•°" tabindex="-1">Vueæºç åˆ†æä¹‹è®¡ç®—å±æ€§ä¸ä¾¦å¬å‡½æ•° <a class="header-anchor" href="#vueæºç åˆ†æä¹‹è®¡ç®—å±æ€§ä¸ä¾¦å¬å‡½æ•°" aria-label="Permalink to &quot;Vueæºç åˆ†æä¹‹è®¡ç®—å±æ€§ä¸ä¾¦å¬å‡½æ•°&quot;">â€‹</a></h1><p>ä¸Šä¸€èŠ‚æˆ‘ä»¬ä»å¤´åˆ°å°¾åˆ†æäº†<a href="/frontend/vue/reactivity.html">vueçš„å“åº”å¼åŸç†</a>ï¼ˆåŒ…æ‹¬vue3ï¼‰ï¼Œæ¥ä¸‹æ¥è¶çƒ­æ‰“é“åˆ†æä¸‹computedã€watchçš„å®ç°åŸç†ã€‚å¦‚æœä½ å¯¹vueçš„å“åº”å¼åŸç†è¿˜å¾ˆæ¨¡ç³Šï¼Œå»ºè®®å…ˆé˜…è¯»ä¸Šä¸€ç¯‡ææ˜ç™½å“åº”å¼åŸç†å†æ¥çœ‹æœ¬ç¯‡æ–‡ç« ï¼Œå½“ç„¶computedã€watchæ˜¯å¯¹å“åº”å¼çš„æ‰©å±•ï¼Œå“åº”å¼æ‡‚äº†è¿™é‡Œæ‰ä¸ä¼šè¿·èŒ«</p><blockquote><p>è¿˜æ˜¯ä¸€æ ·å¦‚æœä½ å¯¹äºæŸäº›åŸç†ä¸æ˜¯å¾ˆæ˜ç™½æ—¶ï¼Œå­¦ä¼šè‡ªå·±æ‰“æ–­ç‚¹è°ƒè¯•ï¼Œç”¨æœ€ç®€å•çš„ä¾‹å­å¤šåˆ†æå‡ éæœ‰åŠ©äºç†è§£</p></blockquote><h2 id="è®¡ç®—å±æ€§" tabindex="-1">è®¡ç®—å±æ€§ <a class="header-anchor" href="#è®¡ç®—å±æ€§" aria-label="Permalink to &quot;è®¡ç®—å±æ€§&quot;">â€‹</a></h2><p>è®¡ç®—å±æ€§é¡¾åæ€ä¹‰å°±æ˜¯ç”±è®¡ç®—å¾—æ¥çš„å€¼ï¼Œåœ¨vueä¸­é€šå¸¸ç”¨æ¥ä½¿ç”¨éœ€è¦é€šè¿‡ç®€å•è®¡ç®—åçš„å±æ€§ï¼Œå¼•ç”¨vueå®˜æ–¹æè¿°ï¼š<em><u>æ¨¡æ¿å†…çš„è¡¨è¾¾å¼éå¸¸ä¾¿åˆ©ï¼Œä½†æ˜¯è®¾è®¡å®ƒä»¬çš„åˆè¡·æ˜¯ç”¨äºç®€å•è¿ç®—çš„ï¼Œåœ¨æ¨¡æ¿ä¸­æ”¾å…¥å¤ªå¤šçš„é€»è¾‘ä¼šè®©æ¨¡æ¿è¿‡é‡ä¸”éš¾ä»¥ç»´æŠ¤</u></em></p><h3 id="ç®€å•ä½¿ç”¨" tabindex="-1">ç®€å•ä½¿ç”¨ <a class="header-anchor" href="#ç®€å•ä½¿ç”¨" aria-label="Permalink to &quot;ç®€å•ä½¿ç”¨&quot;">â€‹</a></h3><div class="language-vue line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">vue</span><pre class="shiki material-theme-palenight has-diff vp-code"><code><span class="line"><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">template</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">  &lt;</span><span style="color:#F07178;">div</span><span style="color:#89DDFF;">&gt;{{</span><span style="color:#BABED8;"> name </span><span style="color:#89DDFF;">}}&lt;/</span><span style="color:#F07178;">div</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">  &lt;</span><span style="color:#F07178;">div</span><span style="color:#89DDFF;">&gt;{{</span><span style="color:#BABED8;"> age </span><span style="color:#89DDFF;">}}&lt;/</span><span style="color:#F07178;">div</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line diff remove"><span style="color:#89DDFF;">  &lt;</span><span style="color:#F07178;">div</span><span style="color:#89DDFF;">&gt;{{</span><span style="color:#89DDFF;"> \`</span><span style="color:#C3E88D;">æˆ‘çš„åå­—ï¼š</span><span style="color:#89DDFF;">\${</span><span style="color:#89DDFF;">this.</span><span style="color:#BABED8;">name</span><span style="color:#89DDFF;">}</span><span style="color:#C3E88D;">ï¼Œä»Šå¹´ </span><span style="color:#89DDFF;">\${</span><span style="color:#89DDFF;">this.</span><span style="color:#BABED8;">age</span><span style="color:#89DDFF;">}</span><span style="color:#C3E88D;"> å²</span><span style="color:#89DDFF;">\`</span><span style="color:#89DDFF;"> }}&lt;/</span><span style="color:#F07178;">div</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line diff add"><span style="color:#89DDFF;">  &lt;</span><span style="color:#F07178;">div</span><span style="color:#89DDFF;">&gt;{{</span><span style="color:#BABED8;"> intro </span><span style="color:#89DDFF;">}}&lt;/</span><span style="color:#F07178;">div</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">template</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">script</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#89DDFF;font-style:italic;"> default</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#82AAFF;">  data</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> ()</span><span style="color:#C792EA;"> =&gt;</span><span style="color:#BABED8;"> (</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    name</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> &quot;</span><span style="color:#C3E88D;">Jack</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    age</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;"> 10</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span><span style="color:#BABED8;">)</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">  computed</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#F07178;">    intro</span><span style="color:#89DDFF;">()</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">      return</span><span style="color:#89DDFF;"> \`</span><span style="color:#C3E88D;">æˆ‘çš„åå­—ï¼š</span><span style="color:#89DDFF;">\${</span><span style="color:#89DDFF;">this.</span><span style="color:#BABED8;">name</span><span style="color:#89DDFF;">}</span><span style="color:#C3E88D;">ï¼Œä»Šå¹´ </span><span style="color:#89DDFF;">\${</span><span style="color:#89DDFF;">this.</span><span style="color:#BABED8;">age</span><span style="color:#89DDFF;">}</span><span style="color:#C3E88D;"> å²</span><span style="color:#89DDFF;">\`</span></span>
<span class="line"><span style="color:#89DDFF;">    }</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">script</span><span style="color:#89DDFF;">&gt;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>ä¸Šé¢ä¾¿æ˜¯ä¸€ä¸ªæœ€ç®€å•çš„è®¡ç®—å±æ€§ä½¿ç”¨ä¾‹å­ï¼Œé€šè¿‡è®¡ç®—å¾—åˆ°çš„ä¸€ä¸ªå€¼ï¼Œä½¿ç”¨è®¡ç®—å±æ€§æ¨¡æ¿æ›´æ˜“ç»´æŠ¤ä¹Ÿæ–¹ä¾¿åç»­çš„æ‰©å±•</p><h3 id="è®¡ç®—å±æ€§ç¼“å­˜" tabindex="-1">è®¡ç®—å±æ€§ç¼“å­˜ <a class="header-anchor" href="#è®¡ç®—å±æ€§ç¼“å­˜" aria-label="Permalink to &quot;è®¡ç®—å±æ€§ç¼“å­˜&quot;">â€‹</a></h3><p>åº”è¯¥éƒ½å¬è¯´è¿‡è®¡ç®—å±æ€§æœ‰ç¼“å­˜å§ï¼Œä¹Ÿå°±æ˜¯å½“è®¡ç®—å±æ€§ä¾èµ–çš„dataå€¼æ²¡æœ‰å‘ç”Ÿå˜åŒ–æ—¶ï¼Œæ˜¯ä¸ä¼šé‡æ–°æ‰§è¡Œè®¡ç®—å±æ€§çš„å‡½æ•°çš„ï¼Œé‚£åœ¨é¡µé¢æ¸²æŸ“æ—¶ä¹Ÿå°±åªä¼šæ‰§è¡Œä¸€æ¬¡ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸Šé¢çš„ä¾‹å­ç®€å•æ¥éªŒè¯ä¸‹ï¼š</p><div class="language-vue line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">vue</span><pre class="shiki material-theme-palenight has-diff vp-code"><code><span class="line"><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">template</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  &lt;!-- æ¨¡æ¿ä¸­ä½¿ç”¨3ä¸ªè®¡ç®—å±æ€§ --&gt;</span></span>
<span class="line diff add"><span style="color:#89DDFF;">  &lt;</span><span style="color:#F07178;">div</span><span style="color:#89DDFF;">&gt;{{</span><span style="color:#BABED8;"> intro </span><span style="color:#89DDFF;">}}&lt;/</span><span style="color:#F07178;">div</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line diff add"><span style="color:#89DDFF;">  &lt;</span><span style="color:#F07178;">div</span><span style="color:#89DDFF;">&gt;{{</span><span style="color:#BABED8;"> intro </span><span style="color:#89DDFF;">}}&lt;/</span><span style="color:#F07178;">div</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line diff add"><span style="color:#89DDFF;">  &lt;</span><span style="color:#F07178;">div</span><span style="color:#89DDFF;">&gt;{{</span><span style="color:#BABED8;"> intro </span><span style="color:#89DDFF;">}}&lt;/</span><span style="color:#F07178;">div</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">template</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">script</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#89DDFF;font-style:italic;"> default</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  // çœç•¥...</span></span>
<span class="line"><span style="color:#F07178;">  computed</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#F07178;">    intro</span><span style="color:#89DDFF;">()</span><span style="color:#89DDFF;"> {</span></span>
<span class="line diff add"><span style="color:#BABED8;">      console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">æ‰§è¡Œäº†introå‡½æ•°</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span><span style="color:#676E95;font-style:italic;">// çœ‹è¿™é‡Œä¼šæ‰“å°å‡ æ¬¡</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">      return</span><span style="color:#89DDFF;"> \`</span><span style="color:#C3E88D;">æˆ‘çš„åå­—ï¼š</span><span style="color:#89DDFF;">\${</span><span style="color:#89DDFF;">this.</span><span style="color:#BABED8;">name</span><span style="color:#89DDFF;">}</span><span style="color:#C3E88D;">ï¼Œä»Šå¹´ </span><span style="color:#89DDFF;">\${</span><span style="color:#89DDFF;">this.</span><span style="color:#BABED8;">age</span><span style="color:#89DDFF;">}</span><span style="color:#C3E88D;"> å²</span><span style="color:#89DDFF;">\`</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">    }</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">script</span><span style="color:#89DDFF;">&gt;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p><img src="https://ihengshuai-demo1.oss-cn-beijing.aliyuncs.com/image-20230520110155472.png" alt=""></p><p>ä»ä»¥ä¸Šç»“æœå¯ä»¥çœ‹åˆ°<code>intro</code>å‡½æ•°åªæ‰“å°äº†ä¸€æ¬¡ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨æ¨¡æ¿æ¸²æŸ“ä¸­å¯¹introå‡½æ•°çš„æ‰§è¡Œåªè§¦å‘äº†ä¸€æ¬¡ï¼Œè¿™ä¹Ÿå°±æ˜¯æ‰€è°“çš„<code>è®¡ç®—å±æ€§ç¼“å­˜</code>ï¼Œå¦‚æœåŒæ ·çš„å‡½æ•°å®šä¹‰åœ¨æ–¹æ³•ä½“ä¸­å°±ä¼šæ‰§è¡Œå¤šéï¼Œä¸¥é‡å½±å“æ€§èƒ½</p><p>çœ‹ä¸Šå»è¿˜æŒºç¥å¥‡çš„ï¼Œæ¥ä¸‹æ¥å°±ä¸€æ¢ç©¶ç«ŸğŸ‘‡</p><h3 id="è®¡ç®—å±æ€§æœ¬è´¨" tabindex="-1">è®¡ç®—å±æ€§æœ¬è´¨ <a class="header-anchor" href="#è®¡ç®—å±æ€§æœ¬è´¨" aria-label="Permalink to &quot;è®¡ç®—å±æ€§æœ¬è´¨&quot;">â€‹</a></h3><p>æˆ‘ä»¬çŸ¥é“vueä¸­å­˜åœ¨3ç§watcheråˆ†åˆ«æ˜¯ï¼š<code>render watcher</code>ã€<code>computed watcher</code>ã€<code>user watcher</code>ï¼Œwatcherä¸»è¦ç”¨æ¥æ‰§è¡Œå¯¹åº”çš„è¡¨è¾¾å¼ï¼Œè€Œwatcheråˆæ˜¯è¢«depæ§åˆ¶çš„ï¼Œdepå¤§å®¶åº”è¯¥éƒ½çŸ¥é“åœ¨å¯¹dataè¿›è¡Œgetter/setteræ‹¦æˆªæ—¶æ‰€é™„åŠ çš„ä¸€ä¸ªå¯¹è±¡ï¼Œç”¨æ¥æ”¶é›†ç›¸å…³è”çš„watcherå¯¹è±¡ï¼Œå½“è§¦å‘setteræ—¶ä¾¿é€šçŸ¥watcherè¿›è¡Œæ›´æ–°ï¼Œwatcherä¹Ÿå°±ä¼šæ‰§è¡Œå¯¹åº”çš„è¡¨è¾¾å¼è¿›è¡Œæ›´æ–°ï¼Œè¿™å°±æ˜¯å“åº”å¼çš„è¿‡ç¨‹</p><p>é‚£ä¹ˆè®¡ç®—å±æ€§å…¶å®æœ¬è´¨å°±æ˜¯ä¸€ä¸ªwatcherï¼Œç”±äºå®šä¹‰åœ¨computedä¸­åˆè¢«ç§°ä¸º<code>è®¡ç®—wathcer</code>ã€‚å…¶å®é€šè¿‡å“åº”å¼è¿‡ç¨‹ä½ å¤§æ¦‚å·²ç»çŸ¥é“äº†è®¡ç®—å±æ€§ç¼“å­˜çš„åŸå› äº†ï¼Œå¤§æ¦‚å°±æ˜¯<u>watcherçš„æ›´æ–°åªè¢«depæ§åˆ¶ï¼Œåªè¦depæ‰€å±çš„å±æ€§å€¼æ²¡å˜å°±ä¸ä¼šé€šçŸ¥watcherè¿›è¡Œæ›´æ–°ï¼Œæ‰€ä»¥åœ¨æ¨¡æ¿æ¸²æŸ“æ—¶å¹¶ä¸ä¼šè§¦å‘è®¡ç®—å±æ€§çš„å¤šæ¬¡æ‰§è¡Œï¼Œå› ä¸ºcomputedå¯¹åº”çš„dataå€¼æ²¡å˜ï¼Œè¿™å°±æ˜¯åŸç†</u></p><p>vueå†…éƒ¨ä¼šç»Ÿä¸€æŠŠcomputedå˜æˆå¯¹è±¡å½¢å¼åŒ…å«get/setä¸¤ä¸ªå‡½æ•°ï¼Œå¦‚ä¸Šé¢çš„å†™æ³•å…¶å®å†…éƒ¨ä¼šå˜æˆï¼š</p><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#BABED8;">intro </span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#F07178;">  get</span><span style="color:#89DDFF;">()</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">    return</span><span style="color:#89DDFF;"> \`</span><span style="color:#C3E88D;">æˆ‘çš„åå­—ï¼š</span><span style="color:#89DDFF;">\${</span><span style="color:#89DDFF;">this.</span><span style="color:#BABED8;">name</span><span style="color:#89DDFF;">}</span><span style="color:#C3E88D;">ï¼Œä»Šå¹´ </span><span style="color:#89DDFF;">\${</span><span style="color:#89DDFF;">this.</span><span style="color:#BABED8;">age</span><span style="color:#89DDFF;">}</span><span style="color:#C3E88D;"> å²</span><span style="color:#89DDFF;">\`</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">  },</span></span>
<span class="line"><span style="color:#F07178;">  set</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> noop </span><span style="color:#676E95;font-style:italic;">// ç©ºå‡½æ•°</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>é€šå¸¸è®¡ç®—å±æ€§çš„setä½¿ç”¨ä¹Ÿä¸å¤šä¹Ÿä¸æ¨èä½¿ç”¨setï¼Œä¸€èˆ¬ä¸€ä¸ªè®¡ç®—å±æ€§ä¸€ä¸ªå‡½æ•°å°±è¡Œäº†</p><p>ä¸‹é¢é€šè¿‡ä¸€å¼ å›¾æ¥åŠ å¼ºç†è§£è®¡ç®—å±æ€§çš„å·¥ä½œè¿‡ç¨‹ï¼š <img src="https://ihengshuai-demo1.oss-cn-beijing.aliyuncs.com/vue-computed-202005202342.svg" alt=""></p><p>ä¸Šå›¾æ¸…æ™°çš„å±•ç¤ºäº†åªæœ‰dataæ”¹å˜æ—¶ä¾¿ä¼šé€šè¿‡depé€šçŸ¥è®¡ç®—watcherè¿›è¡Œæ›´æ–°ä¹Ÿå°±ä¼šæ‰§è¡Œè®¡ç®—å±æ€§çš„getå‡½æ•°ï¼Œæ¨¡æ¿æ¸²æŸ“æ—¶å¹¶ä¸ä¼šè§¦å‘è®¡ç®—å±æ€§çš„å¤šæ¬¡æ‰§è¡Œã€‚ä¸Šå›¾ä¹Ÿåæ˜ äº†ä¸€ä¸ªé—®é¢˜ï¼š<u>å½“dataæ”¹å˜æ—¶åªä¼šé€šçŸ¥è®¡ç®—watcherè¿›è¡Œæ›´æ–°ï¼Œè€Œè®¡ç®—watcherå¹¶ä¸ä¼šé€šçŸ¥æ¸²æŸ“watcheræ›´æ–°(åªæœ‰depä¼šæ”¶é›†watcherï¼Œwatcherä¸ä¼šæ”¶é›†watcher)ï¼Œé‚£ä¹ˆæ¸²æŸ“watcheråˆæ˜¯å¦‚ä½•çŸ¥é“éœ€è¦é‡æ–°æ¸²æŸ“çš„å‘¢</u>ï¼Ÿä½ æ˜¯å¦ä¹Ÿæœ‰ä¸€æ ·çš„ç–‘é—®å‘¢â“</p><p>é€šè¿‡è¿™ä¸ªç–‘é—®å¹¶æ ¹æ®å“åº”å¼åŸç†åº”è¯¥èƒ½æ¨å‡ºdepè‚¯å®šå’Œæ¸²æŸ“watcherä¹Ÿä¼šæœ‰å…³ç³»çš„ï¼Œå°±æ˜¯è¿™ä¸ªå…³ç³»æ˜¯æ€ä¹ˆå»ºç«‹èµ·æ¥çš„â“ä»å“åº”å¼åŸç†ä¸­æˆ‘ä»¬çŸ¥é“depä¼šé€šè¿‡<code>Dep.watcher</code>è¿™ä¸ªå±æ€§å€¼å’Œwatcheräº§ç”Ÿå…³ç³»ä¹Ÿå°±æ˜¯ä¾èµ–æ”¶é›†ï¼Œè€Œå½“è®¡ç®—watcherè¡¨è¾¾å¼æ‰§è¡Œæ—¶ï¼Œå½“å‰çš„<code>Dep.watcher</code>ä¹Ÿåªä¼šæ˜¯è®¡ç®—watcherçš„getå‡½æ•°ï¼Œå¹¶ä¸ä¼šæ˜¯æ¸²æŸ“watcherï¼Œdepä¹Ÿå°±ä¸ä¼šæ”¶é›†åˆ°æ¸²æŸ“watcherï¼Œé‚£ä¹ˆdepåˆ°åº•æ˜¯å¦‚ä½•æ”¶é›†åˆ°æ¸²æŸ“watcherçš„ï¼Œæ¥ä¸‹æ¥å¸¦ç€è¿™ä¸ªç–‘é—®è¿›ä¸€æ­¥äº†è§£ä¸‹</p><h3 id="åŸç†å®ç°" tabindex="-1">åŸç†å®ç° <a class="header-anchor" href="#åŸç†å®ç°" aria-label="Permalink to &quot;åŸç†å®ç°&quot;">â€‹</a></h3><ol><li>ç»„ä»¶åˆå§‹åŒ–æ—¶å¯¹computedå±æ€§è¿›è¡Œåˆå§‹åŒ–ï¼š</li></ol><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#676E95;font-style:italic;">// src/core/instance/state 58è¡Œ</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#C792EA;"> function</span><span style="color:#82AAFF;"> initState</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">vm</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> Component</span><span style="color:#89DDFF;">)</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#BABED8;">  vm</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">_watchers</span><span style="color:#89DDFF;"> =</span><span style="color:#F07178;"> []</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#C792EA;">  const</span><span style="color:#BABED8;"> opts</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> vm</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">$options</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  // åˆå§‹åŒ–computed</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">  if</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">opts</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">computed</span><span style="color:#F07178;">) </span><span style="color:#82AAFF;">initComputed</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">vm</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> opts</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">computed</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ol start="2"><li>éå†computedä¸ºæ¯ä¸€ä¸ªå±æ€§ç”Ÿæˆå¯¹åº”çš„watcherï¼ˆè®¡ç®—watcherï¼‰ï¼š</li></ol><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#676E95;font-style:italic;">// src/core/instance/state 137è¡Œ</span></span>
<span class="line"><span style="color:#C792EA;">function</span><span style="color:#82AAFF;"> initComputed</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">vm</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> Component</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;font-style:italic;"> computed</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> Object</span><span style="color:#89DDFF;">)</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	// ç»„ä»¶å®ä¾‹ä¸Šå®šä¹‰ _computedWatchers å±æ€§ç”¨æ¥å­˜æ”¾æ‰€æœ‰çš„computedwatcher</span></span>
<span class="line"><span style="color:#C792EA;">  const</span><span style="color:#BABED8;"> watchers</span><span style="color:#89DDFF;"> =</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">vm</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">_computedWatchers</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> Object</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">create</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">null</span><span style="color:#F07178;">))</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  // éå† computedï¼Œç”Ÿæˆå¯¹åº”çš„watcher</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">  for</span><span style="color:#F07178;"> (</span><span style="color:#C792EA;">const</span><span style="color:#BABED8;"> key</span><span style="color:#89DDFF;"> in</span><span style="color:#BABED8;"> computed</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#C792EA;">    const</span><span style="color:#BABED8;"> userDef</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> computed</span><span style="color:#F07178;">[</span><span style="color:#BABED8;">key</span><span style="color:#F07178;">]</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // å¦‚æœæ˜¯functionå°±ç›´æ¥å–å€¼ï¼Œåä¹‹å¯¹è±¡å– get å±æ€§</span></span>
<span class="line"><span style="color:#C792EA;">    const</span><span style="color:#BABED8;"> getter</span><span style="color:#89DDFF;"> =</span><span style="color:#89DDFF;"> typeof</span><span style="color:#BABED8;"> userDef</span><span style="color:#89DDFF;"> ===</span><span style="color:#89DDFF;"> &quot;</span><span style="color:#C3E88D;">function</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> ?</span><span style="color:#BABED8;"> userDef</span><span style="color:#89DDFF;"> :</span><span style="color:#BABED8;"> userDef</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">get</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // å®šä¹‰å½“å‰ key çš„watcherï¼Œ ä¹Ÿå°±æ˜¯è®¡ç®—å±æ€§watcher</span></span>
<span class="line"><span style="color:#BABED8;">    watchers</span><span style="color:#F07178;">[</span><span style="color:#BABED8;">key</span><span style="color:#F07178;">] </span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;"> new</span><span style="color:#82AAFF;"> Watcher</span><span style="color:#F07178;">(</span></span>
<span class="line"><span style="color:#BABED8;">      vm</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#BABED8;">      getter</span><span style="color:#89DDFF;"> ||</span><span style="color:#BABED8;"> noop</span><span style="color:#89DDFF;">,</span><span style="color:#676E95;font-style:italic;">  // è¿™é‡Œçœ‹åˆ° è¡¨è¾¾å¼å°±æ˜¯ æˆ‘ä»¬å®šä¹‰çš„å‡½æ•°æˆ–è€…getå‡½æ•°</span></span>
<span class="line"><span style="color:#BABED8;">      noop</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">      {</span><span style="color:#F07178;"> lazy</span><span style="color:#89DDFF;">:</span><span style="color:#FF9CAC;"> true</span><span style="color:#89DDFF;"> }</span><span style="color:#676E95;font-style:italic;">   // æ³¨æ„è¿™ä¸ªé€‰é¡¹å¾ˆé‡è¦ï¼Œç”¨æ¥æ ‡è¯†è¿™ä¸ªæ˜¯è®¡ç®—å±æ€§watcherï¼ˆè®°ä½è¿™ä¸ªï¼Œåé¢ä¼šç”¨åˆ°ï¼‰</span></span>
<span class="line"><span style="color:#F07178;">    )</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // ä»£ç†æ¯ä¸ªcomputedå±æ€§åˆ°å®ä¾‹ä¸Šï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆ thiså¯ä»¥è·å–åˆ°è®¡ç®—å±æ€§çš„åŸå› </span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">    if</span><span style="color:#F07178;"> (</span><span style="color:#89DDFF;">!</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">key</span><span style="color:#89DDFF;"> in</span><span style="color:#BABED8;"> vm</span><span style="color:#F07178;">)) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#82AAFF;">      defineComputed</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">vm</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> key</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> userDef</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">    }</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><ol start="3"><li>æ¥çœ‹çœ‹è®¡ç®—watcherå®ä¾‹åŒ–æ—¶ä¼šæ€ä¹ˆæ ·ï¼Œåˆå§‹åŒ–æ—¶ç”±äºoptsä¼ å…¥lazyï¼Œæ‰€ä»¥ä¸ä¼šç«‹å³æ‰§è¡Œå‡½æ•°ï¼š</li></ol><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#676E95;font-style:italic;">// src/core/observer/watcher</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#89DDFF;font-style:italic;"> default</span><span style="color:#C792EA;"> class</span><span style="color:#FFCB6B;"> Watcher</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#F07178;">  vm</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> Component</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">  lazy</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> boolean</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">  value</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> any</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  // è¿™é‡Œçš„expOrFnå°±æ˜¯è®¡ç®—å±æ€§çš„getter</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  // cbä¸ºç©ºï¼Œopts ä¸º {lazy: true}</span></span>
<span class="line"><span style="color:#C792EA;">  constructor</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">vm</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> Component</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;font-style:italic;"> expOrFn</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> string</span><span style="color:#89DDFF;"> |</span><span style="color:#FFCB6B;"> Function</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> cb</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> Function</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;font-style:italic;"> opts</span><span style="color:#89DDFF;">)</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#89DDFF;">    this.</span><span style="color:#BABED8;">vm</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> vm</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">    if</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">options</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    	// lazy: true</span></span>
<span class="line"><span style="color:#89DDFF;">      this.</span><span style="color:#BABED8;">lazy</span><span style="color:#89DDFF;"> =</span><span style="color:#89DDFF;"> !!</span><span style="color:#BABED8;">options</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">lazy</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">    }</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // æ³¨æ„è¿™ä¸ª dirty å¾ˆé‡è¦ï¼Œæ¥ç¼“å­˜è®¡ç®—å±æ€§çš„å€¼ï¼Œé¦–å…ˆè¿›æ¥ä¸º true</span></span>
<span class="line"><span style="color:#89DDFF;">    this.</span><span style="color:#BABED8;">dirty</span><span style="color:#89DDFF;"> =</span><span style="color:#89DDFF;"> this.</span><span style="color:#BABED8;">lazy</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">    if</span><span style="color:#F07178;"> (</span><span style="color:#89DDFF;">typeof</span><span style="color:#BABED8;"> expOrFn</span><span style="color:#89DDFF;"> ===</span><span style="color:#89DDFF;"> &quot;</span><span style="color:#C3E88D;">function</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">      // getter å˜æˆäº† è®¡ç®—å±æ€§çš„getå‡½æ•°</span></span>
<span class="line"><span style="color:#89DDFF;">      this.</span><span style="color:#BABED8;">getter</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> expOrFn</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">    }</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // ç”±äºlazyä¸ºtrueï¼Œå¤–é¢åˆå§‹åŒ–æ—¶ä¹Ÿå°±ä¸ä¼šæ‰§è¡Œå‡½æ•°</span></span>
<span class="line"><span style="color:#89DDFF;">    this.</span><span style="color:#BABED8;">value</span><span style="color:#89DDFF;"> =</span><span style="color:#89DDFF;"> this.</span><span style="color:#BABED8;">lazy</span><span style="color:#89DDFF;"> ?</span><span style="color:#89DDFF;"> undefined</span><span style="color:#89DDFF;"> :</span><span style="color:#89DDFF;"> this.</span><span style="color:#82AAFF;">get</span><span style="color:#F07178;">()</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><ol start="4"><li>æ¥ç€ç¬¬2æ­¥éª¤æœ€åä»£ç ï¼Œä»£ç†computedä¸­çš„æ¯ä¸ªkeyåˆ°thiså®ä¾‹ä¸Šï¼Œè¿™ä¸ªæ­¥éª¤å¾ˆå…³é”®ä¹Ÿæ˜¯é‡ç‚¹ã€‚ä¸Šä¸€æ­¥éª¤æˆ‘ä»¬çŸ¥é“äº†computedåœ¨åˆå§‹åŒ–watcheræ—¶å¹¶ä¸ä¼šç«‹é©¬æ‰§è¡Œï¼Œé‚£ä¹ˆå½“ç»„ä»¶æ‰§è¡Œrenderå‡½æ•°çš„è¿‡ç¨‹ä¸­å°±ä¼šè®¿é—®computedå±æ€§ï¼ˆå‡è®¾æ¨¡æ¿ä¸­ç”¨åˆ°äº†computedå±æ€§ï¼‰ï¼Œè¿™æ—¶å°±ä¼šè§¦å‘ä¸‹æ–¹çš„getterå‡½æ•°</li></ol><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#C792EA;">const</span><span style="color:#BABED8;"> sharedPropertyDefinition </span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#F07178;">  enumerable</span><span style="color:#89DDFF;">:</span><span style="color:#FF9CAC;"> true</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">  configurable</span><span style="color:#89DDFF;">:</span><span style="color:#FF9CAC;"> true</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">  get</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> noop</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">  set</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> noop</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">};</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#C792EA;"> function</span><span style="color:#82AAFF;"> defineComputed</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#BABED8;font-style:italic;">  target</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> any</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#BABED8;font-style:italic;">  key</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> string</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#BABED8;font-style:italic;">  userDef</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> Object</span><span style="color:#89DDFF;"> |</span><span style="color:#FFCB6B;"> Function</span></span>
<span class="line"><span style="color:#89DDFF;">)</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  // å€¼ä¸ºå‡½æ•°æ—¶</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">  if</span><span style="color:#F07178;"> (</span><span style="color:#89DDFF;">typeof</span><span style="color:#BABED8;"> userDef</span><span style="color:#89DDFF;"> ===</span><span style="color:#89DDFF;"> &quot;</span><span style="color:#C3E88D;">function</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">    sharedPropertyDefinition</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">get</span><span style="color:#89DDFF;"> =</span><span style="color:#82AAFF;"> createComputedGetter</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">key</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#BABED8;">    sharedPropertyDefinition</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">set</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> noop</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span><span style="color:#89DDFF;font-style:italic;"> else</span><span style="color:#89DDFF;"> {</span><span style="color:#676E95;font-style:italic;"> // å€¼ä¸ºå¯¹è±¡æ—¶</span></span>
<span class="line"><span style="color:#BABED8;">    sharedPropertyDefinition</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">get</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> userDef</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">get</span></span>
<span class="line"><span style="color:#89DDFF;">      ?</span><span style="color:#BABED8;"> userDef</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">cache</span><span style="color:#89DDFF;"> !==</span><span style="color:#FF9CAC;"> false</span></span>
<span class="line"><span style="color:#89DDFF;">        ?</span><span style="color:#82AAFF;"> createComputedGetter</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">key</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">        :</span><span style="color:#82AAFF;"> createGetterInvoker</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">userDef</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">get</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">      :</span><span style="color:#BABED8;"> noop</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // å¦‚æœæœ‰setå‡½æ•°ï¼Œæ²¡æœ‰è®¾ç½®noop ç©ºå‡½æ•°</span></span>
<span class="line"><span style="color:#BABED8;">    sharedPropertyDefinition</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">set</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> userDef</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">set</span><span style="color:#89DDFF;"> ||</span><span style="color:#BABED8;"> noop</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  // è®¾ç½®æè¿°å¯¹è±¡ï¼Œå¯¹keyè¿›è¡Œgetter/setteræ‹¦æˆªï¼Œä¹Ÿå°±æ˜¯è®¿é—® target[key] æ—¶ï¼Œå°±ä¼šè®¿é—®ä¸‹æ–¹çš„getterå‡½æ•°</span></span>
<span class="line"><span style="color:#BABED8;">  Object</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">defineProperty</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">target</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> key</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> sharedPropertyDefinition</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// thiså®ä¾‹ä¸Šè·å– computedæ—¶ï¼Œå°±ä¼šè§¦å‘è¿™é‡Œçš„get</span></span>
<span class="line"><span style="color:#C792EA;">function</span><span style="color:#82AAFF;"> createComputedGetter</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">key</span><span style="color:#89DDFF;">)</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">  return</span><span style="color:#C792EA;"> function</span><span style="color:#82AAFF;"> computedGetter</span><span style="color:#89DDFF;">()</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#C792EA;">    const</span><span style="color:#BABED8;"> watcher</span><span style="color:#89DDFF;"> =</span><span style="color:#89DDFF;"> this.</span><span style="color:#BABED8;">_computedWatchers</span><span style="color:#89DDFF;"> &amp;&amp;</span><span style="color:#89DDFF;"> this.</span><span style="color:#BABED8;">_computedWatchers</span><span style="color:#F07178;">[</span><span style="color:#BABED8;">key</span><span style="color:#F07178;">]</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">    if</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">watcher</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">      if</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">watcher</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">dirty</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">        watcher</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">evaluate</span><span style="color:#F07178;">()</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">      }</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">      if</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">Dep</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">target</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">        watcher</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">depend</span><span style="color:#F07178;">()</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">      }</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">      return</span><span style="color:#BABED8;"> watcher</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">value</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">    }</span></span>
<span class="line"><span style="color:#89DDFF;">  };</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><p>é¦–å…ˆé€šè¿‡thisæ‹¿åˆ°å½“å‰computedå±æ€§çš„watcherï¼Œåˆšå¼€å§‹<code>dirty</code>çš„å€¼æ—¶trueï¼Œé‚£ä¹ˆå°±ä¼šæ‰§è¡Œ<code>watcher.evaluate()</code>ï¼Œå†…éƒ¨ä¼šæ‰§è¡Œwatcherçš„getæ–¹æ³•ï¼Œgetä¸­åˆä¼šæ‰§è¡Œgetteræ–¹æ³•ï¼Œä»ç¬¬3æ­¥åº”è¯¥çŸ¥é“<code>this.getter</code>å°±æ˜¯è®¡ç®—å±æ€§çš„å‡½æ•°ã€‚åœ¨æ‰§è¡Œè®¡ç®—å±æ€§å‡½æ•°è¿‡ç¨‹ä¸­å°±ä¼šå¯¹dataè¿›è¡Œè®¿é—®è§¦å‘å“åº”å¼å¯¹è±¡å¯¹åº”çš„depçš„dependå¯¹å½“å‰watcherè¿›è¡Œæ”¶é›†ï¼Œä¹Ÿå°±æ˜¯ä¼šæ”¶é›†å½“å‰è®¡ç®—å±æ€§çš„watcherï¼Œæœ€åè®¡ç®—çš„å€¼èµ‹å€¼ç»™å½“å‰watcherçš„valueï¼Œè¿™æ—¶<u>å°†dirtyè®¾ç½®ä¸ºfalse</u>ã€‚ç„¶åä¸‹ä¸€æ­¥åˆ¤æ–­<code>Dep.target</code>ä¸ºtrueæ—¶æ‰§è¡Œ<code>watcher.depend</code>ï¼Œå½“å‰è®¡ç®—å±æ€§å‡½æ•°æ‰§è¡Œå®Œåå°±ä¼šå°†Dep.targetå˜æˆä¸Šä¸€ä¸ªwatcherï¼Œè¿™é‡Œå°±å‡è®¾ä¸ºæ¸²æŸ“watcherï¼Œé‚£ä¹ˆæ¥çœ‹çœ‹watcherçš„dependå¹²äº†å•¥</p><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#89DDFF;font-style:italic;"> default</span><span style="color:#C792EA;"> class</span><span style="color:#FFCB6B;"> Watcher</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#F07178;">  vm</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> Component</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">  lazy</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> boolean</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">  value</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> any</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  // çœç•¥éƒ¨åˆ†ä»£ç ...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  get</span><span style="color:#89DDFF;">()</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  	// è®¾ç½®Dep.targetä¸ºå½“å‰è®¡ç®—å±æ€§çš„watcher</span></span>
<span class="line"><span style="color:#82AAFF;">    pushTarget</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">this</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#C792EA;">    let</span><span style="color:#BABED8;"> value</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#C792EA;">    const</span><span style="color:#BABED8;"> vm</span><span style="color:#89DDFF;"> =</span><span style="color:#89DDFF;"> this.</span><span style="color:#BABED8;">vm</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // æ‰§è¡Œè®¡ç®—å±æ€§ å‡½æ•°ï¼Œæ­¤è¿‡ç¨‹ä¼šè®¿é—®å“åº”å¼å¯¹åº”ï¼Œå°±ä¼šè§¦å‘getè¿›è¡Œdepè¿›è¡Œdependå½“å‰watcherï¼ˆä¾èµ–æ”¶é›†ï¼‰</span></span>
<span class="line"><span style="color:#BABED8;">    value</span><span style="color:#89DDFF;"> =</span><span style="color:#89DDFF;"> this.</span><span style="color:#BABED8;">getter</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">call</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">vm</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> vm</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#82AAFF;">    popTarget</span><span style="color:#F07178;">()</span><span style="color:#89DDFF;">;</span><span style="color:#676E95;font-style:italic;"> // å‡ºæ ˆ</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">    return</span><span style="color:#BABED8;"> value</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  // dirtyä¸ºtrueæ—¶æ‰§è¡Œ</span></span>
<span class="line"><span style="color:#F07178;">  evaluate</span><span style="color:#89DDFF;">()</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#89DDFF;">    this.</span><span style="color:#BABED8;">value</span><span style="color:#89DDFF;"> =</span><span style="color:#89DDFF;"> this.</span><span style="color:#82AAFF;">get</span><span style="color:#F07178;">()</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">    this.</span><span style="color:#BABED8;">dirty</span><span style="color:#89DDFF;"> =</span><span style="color:#FF9CAC;"> false</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p><u>dependä¸­ä¼šéå†æ‰€æœ‰çš„depsï¼ˆä¹Ÿå°±æ˜¯æ”¶é›†äº†å½“å‰è®¡ç®—watcherçš„æ‰€æœ‰depï¼Œä¹Ÿå°±æ˜¯æŸäº›å¯¹è±¡ç­‰keyçš„depï¼‰ï¼Œæ‰§è¡Œæ¯ä¸ªdepçš„dependæ–¹æ³•ï¼Œä¸»åŠ¨è®©è¿™äº›å“åº”å¼å¯¹è±¡å¯¹å½“å‰çš„<code>Dep.target</code>è¿›è¡Œæ”¶é›†ï¼Œä¸Šé¢æˆ‘ä»¬è¯´äº†å½“å‰çš„targetä¸ºæ¸²æŸ“watcherï¼Œä¹Ÿå°±æ˜¯è¿™ä¸ªæ“ä½œä¼šè®©å“åº”å¼å¯¹è±¡å’Œæ¸²æŸ“watcheräº§ç”Ÿå…³ç³»ã€‚</u></p><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#89DDFF;font-style:italic;"> default</span><span style="color:#C792EA;"> class</span><span style="color:#FFCB6B;"> Watcher</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#F07178;">  vm</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> Component</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">  lazy</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> boolean</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">  value</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> any</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  // éå†æ‰€æœ‰æ”¶é›†äº†å½“å‰è®¡ç®—watcherçš„depï¼Œæ‰§è¡Œdepçš„dependæ–¹æ³•ä¸»åŠ¨è¿›è¡Œä¾èµ–æ”¶é›†</span></span>
<span class="line"><span style="color:#F07178;">  depend</span><span style="color:#89DDFF;">()</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#C792EA;">    let</span><span style="color:#BABED8;"> i</span><span style="color:#89DDFF;"> =</span><span style="color:#89DDFF;"> this.</span><span style="color:#BABED8;">deps</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">length</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">    while</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">i</span><span style="color:#89DDFF;">--</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">      this.</span><span style="color:#BABED8;">deps</span><span style="color:#F07178;">[</span><span style="color:#BABED8;">i</span><span style="color:#F07178;">]</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">depend</span><span style="color:#F07178;">()</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">    }</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>å†æ¥æƒ³æƒ³å¦‚æœrenderå‡½æ•°ä¸­æœ‰å¾ˆå¤šåœ°æ–¹ç”¨åˆ°äº†åŒä¸€ä¸ªè®¡ç®—å±æ€§ï¼Œé‚£ä¹ˆå°±ä¼šå†æ¬¡è®¿é—®å½“å‰å®ä¾‹çš„è®¡ç®—å±æ€§getterï¼Œé¦–å…ˆè¿˜æ˜¯è·å–åˆ°å½“å‰è®¡ç®—å±æ€§çš„watcherï¼Œ<u>è¿™æ—¶dirtyå€¼ä¸ºfalseï¼Œæ‰€ä»¥å°±ä¸ä¼šå†æ‰§è¡Œ<code>watcher.evaluate</code>ä¹Ÿå°±ä¸ä¼šå†æ‰§è¡Œè®¡ç®—å±æ€§çš„å‡½æ•°äº†ï¼Œç›´æ¥è¿”å›ä¸Šä¸€æ¬¡è®¡ç®—åçš„ç»“æœ<code>watcher.value</code>ï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆè®¡ç®—å±æ€§ä¼šç¼“å­˜çš„çœŸå®é¢ç›®</u></p><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#676E95;font-style:italic;">// çœç•¥éƒ¨åˆ†ä»£ç ...</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// dirtryä¸ºfalseæ—¶ï¼Œä¸ä¼šæ‰§è¡Œ</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#BABED8;"> (watcher</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">dirty) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">  watcher</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">evaluate</span><span style="color:#F07178;">()</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#BABED8;"> watcher</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">value</span><span style="color:#89DDFF;">;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ol start="5"><li>å½“å¯¹åº”çš„å“åº”å¼å¯¹è±¡æ›´æ–°æ—¶å°±ä¼šè§¦å‘è®¡ç®—å±æ€§çš„watcheræ›´æ–°ï¼Œæ‰§è¡Œupdateå‡½æ•°ï¼Œè¿™é‡Œlazyä¸ºtrueé¡¾å°†dirtyè®¾ç½®ä¸ºtrueï¼Œç„¶åå•¥éƒ½ä¸ç”¨åšã€‚æ¥ç€depä¼šé€šçŸ¥æ¸²æŸ“watcherè¿›è¡Œæ›´æ–°ï¼ˆä¸Šé¢è®²äº†depä¼šæ”¶é›†æ¸²æŸ“watcherï¼‰ï¼Œè¿™æ ·å°±ä¼šé‡æ–°æ‰§è¡Œrenderå‡½æ•°ï¼Œå†æ¬¡ä¼šè®¿é—®è®¡ç®—å±æ€§çš„getterï¼Œé‚£ä¹ˆå°±å’Œç¬¬ä¸€æ¬¡é¡µé¢æ¸²æŸ“è®¿é—®è®¡ç®—å±æ€§ä¸€æ ·çš„é€»è¾‘ï¼Œæ‰§è¡Œè®¡ç®—å±æ€§çš„å‡½æ•°å¾—åˆ°æœ€æ–°çš„å€¼ï¼Œè¿™é‡Œå°±ä¸å†é‡å¤äº†</li></ol><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#89DDFF;font-style:italic;"> default</span><span style="color:#C792EA;"> class</span><span style="color:#FFCB6B;"> Watcher</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#F07178;">  dirty</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> boolean</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  // çœç•¥éƒ¨åˆ†ä»£ç ...</span></span>
<span class="line"><span style="color:#F07178;">  update</span><span style="color:#89DDFF;">()</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">    if</span><span style="color:#F07178;"> (</span><span style="color:#89DDFF;">this.</span><span style="color:#BABED8;">lazy</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">      this.</span><span style="color:#BABED8;">dirty</span><span style="color:#89DDFF;"> =</span><span style="color:#FF9CAC;"> true</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">    }</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>åˆ°è¿™é‡Œè®¡ç®—å±æ€§çš„åŸç†å°±è®²çš„å·®ä¸å¤šäº†ï¼Œå…¶å®å¾ˆç®€å•ã€‚è®¡ç®—å±æ€§çš„æ‰§è¡Œçš„é‡æ–°æ‰§è¡Œæ˜¯ç”±å¯¹åº”çš„dataå±æ€§çš„depæ§åˆ¶çš„ï¼Œå¹¶ä¸”depä¹Ÿä¼šæ”¶é›†æ¸²æŸ“watcherã€‚åªæœ‰dataçš„å€¼æ”¹å˜æ—¶è®¡ç®—å±æ€§æ‰ä¼šæ‰§è¡Œï¼Œå¦åˆ™éƒ½ä¼šä½¿ç”¨ä¸Šæ¬¡çš„å€¼ï¼Œè¿™æ ·çš„é€»è¾‘ä¹Ÿåˆæƒ…åˆç†</p><div class="tip custom-block"><p class="custom-block-title">å°æç¤º</p><p>computedå¯ä»¥é€šè¿‡<code>cache:false</code>æ¥å–æ¶ˆç¼“å­˜ï¼Œé€šè¿‡å®ƒå¯ä»¥è®¾ç½®æˆä¸åŒçš„getterï¼Œè¿™æ ·åœ¨æ¯æ¬¡è®¿é—®è®¡ç®—å±æ€§æ—¶éƒ½ä¼šæ‰§è¡Œå®ƒçš„å‡½æ•°ï¼Œå½“ç„¶ä¸€èˆ¬ä¹Ÿç”¨ä¸åˆ°è¿™ä¸ªé€‰é¡¹ï¼Œå®˜æ–¹æ–‡æ¡£ä¹Ÿæ²¡æœ‰ç»™å‡ºè¿™ä¸ªé€‰é¡¹ï¼Œè¿™é‡Œå¯ä»¥ä»æºç ä¸­å®šä¹‰åˆå§‹åŒ–è®¡ç®—å±æ€§çš„getteræ—¶ä¼šè¿›è¡Œåˆ¤æ–­ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥çœ‹çœ‹</p></div><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#FFCB6B;">computed</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#FFCB6B;">  intro</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#82AAFF;">    get</span><span style="color:#F07178;">() </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">      console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">æ‰§è¡Œäº†introå‡½æ•°</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">      return</span><span style="color:#89DDFF;"> \`</span><span style="color:#C3E88D;">æˆ‘çš„åå­—ï¼š</span><span style="color:#89DDFF;">\${</span><span style="color:#89DDFF;">this.</span><span style="color:#BABED8;">name</span><span style="color:#89DDFF;">}</span><span style="color:#C3E88D;">ï¼Œä»Šå¹´ </span><span style="color:#89DDFF;">\${</span><span style="color:#89DDFF;">this.</span><span style="color:#BABED8;">age</span><span style="color:#89DDFF;">}</span><span style="color:#C3E88D;"> å²</span><span style="color:#89DDFF;">\`</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">    },</span></span>
<span class="line"><span style="color:#FFCB6B;">    cache</span><span style="color:#89DDFF;">:</span><span style="color:#FF9CAC;"> false</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>è¿™æ ·åœ¨æ¯æ¬¡è®¿é—®introéƒ½ä¼šæ‰§è¡Œï¼Œé‚£ä¹ˆå°±ä¼šæ‰“å°å¤šæ¬¡</p><h3 id="ä»£ç è°ƒè¯•" tabindex="-1">ä»£ç è°ƒè¯• <a class="header-anchor" href="#ä»£ç è°ƒè¯•" aria-label="Permalink to &quot;ä»£ç è°ƒè¯•&quot;">â€‹</a></h3><p>è¿™é‡Œæˆ‘ä»¬ç®€å•è°ƒè¯•ä¸‹ä¸Šé¢çš„ä»£ç ï¼Œæ¥è¯æ˜ä¸‹ä»¥ä¸Šçš„æƒ³æ³•ï¼Œé¦–å…ˆæ˜¯dataçš„depä¼šæ”¶é›†æ¸²æŸ“watcherï¼Œå¦ä¸€ä¸ªå°±æ˜¯å¤šæ¬¡ä½¿ç”¨åŒä¸€ä¸ªè®¡ç®—å±æ€§ä¸ä¼šå†æ‰§è¡Œ</p><p><img src="https://ihengshuai-demo1.oss-cn-beijing.aliyuncs.com/image-20230520170823927.png" alt=""></p><div class="img-title">renderå‡½æ•°ç¬¬ä¸€æ¬¡è®¿é—®è®¡ç®—å±æ€§</div><p><img src="https://ihengshuai-demo1.oss-cn-beijing.aliyuncs.com/image-20230520170902170.png" alt=""></p><div class="img-title">ç¬¬ä¸€æ¬¡ä¼šæ‰§è¡Œevaluateå‡½æ•°</div><p><img src="https://ihengshuai-demo1.oss-cn-beijing.aliyuncs.com/image-20230520171336826.png" alt=""></p><div class="img-title">æ‰§è¡Œè®¡ç®—å±æ€§å‡½æ•°è§¦å‘ä¾èµ–æ”¶é›†</div><p><img src="https://ihengshuai-demo1.oss-cn-beijing.aliyuncs.com/image-20230520171502357.png" alt=""></p><div class="img-title">è®¡ç®—å±æ€§ä¸­çš„å“åº”å¼å¯¹è±¡æ”¶é›†æ¸²æŸ“å‡½æ•°</div><p><img src="https://ihengshuai-demo1.oss-cn-beijing.aliyuncs.com/image-20230520171729187.png" alt=""></p><div class="img-title">renderå‡½æ•°åé¢è®¿é—®è®¡ç®—å±æ€§ä¸å†æ‰§è¡Œ</div><p><img src="https://ihengshuai-demo1.oss-cn-beijing.aliyuncs.com/image-20230520172147154.png" alt=""></p><div class="img-title">å“åº”å¼å¯¹è±¡ç¡®å®æ”¶é›†äº†è®¡ç®—watcherå’Œæ¸²æŸ“watcher</div><h3 id="vue3çš„computed" tabindex="-1">Vue3çš„computed <a class="header-anchor" href="#vue3çš„computed" aria-label="Permalink to &quot;Vue3çš„computed&quot;">â€‹</a></h3><p>Vue3ä¸­çš„computedå…¶å®å¯vue2å·®ä¸å¤šï¼Œå”¯ä¸€ä¸€å¤„ä¸ä¸€æ ·çš„å°±æ˜¯å“åº”å¼å¯¹è±¡ä¸ä¼šç›´æ¥æ”¶é›†renderå‡½æ•°ï¼Œä»–åªä¼šæ”¶é›†å¯¹åº”çš„computedå‡½æ•°ï¼Œè€Œcomputedå‡½æ•°ä¼šæ”¶é›†renderå‡½æ•°ï¼Œå› æ­¤å½“å“åº”å¼å¯¹è±¡çš„å€¼å‘ç”Ÿå˜åŒ–æ—¶æ›´æ–°éµå¾ªä»¥ä¸‹è§„åˆ™ï¼š<code>data =&gt; computed =&gt; render</code>ï¼Œå…¶å®è¿™æ ·è®¾è®¡èƒ½æ›´å¥½çš„åæ˜ å‡ºæ¯ä¸ªå¯¹è±¡çš„çœŸæ­£effect</p><p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªæœ€ç®€å•çš„vueçš„computedä½¿ç”¨ä¾‹å­ï¼š</p><div class="language-vue line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">vue</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">template</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">  &lt;</span><span style="color:#F07178;">button</span><span style="color:#89DDFF;"> @</span><span style="color:#C792EA;">click</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#BABED8;">number</span><span style="color:#89DDFF;">++</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">&gt;</span><span style="color:#BABED8;">æ”¹å˜number</span><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">button</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">  {{</span><span style="color:#BABED8;"> total </span><span style="color:#89DDFF;">}}</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">template</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">script</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#89DDFF;"> {</span><span style="color:#BABED8;"> ref</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> computed</span><span style="color:#89DDFF;"> }</span><span style="color:#89DDFF;font-style:italic;"> from</span><span style="color:#89DDFF;"> &quot;</span><span style="color:#C3E88D;">vue</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#89DDFF;font-style:italic;"> default</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#F07178;">  setup</span><span style="color:#89DDFF;">()</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#C792EA;">    const</span><span style="color:#BABED8;"> number</span><span style="color:#89DDFF;"> =</span><span style="color:#82AAFF;"> ref</span><span style="color:#F07178;">(</span><span style="color:#F78C6C;">1</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#C792EA;">    const</span><span style="color:#BABED8;"> total</span><span style="color:#89DDFF;"> =</span><span style="color:#82AAFF;"> computed</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">()</span><span style="color:#C792EA;"> =&gt;</span><span style="color:#BABED8;"> number</span><span style="color:#89DDFF;"> %</span><span style="color:#F78C6C;"> 5</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">    return</span><span style="color:#89DDFF;"> {</span><span style="color:#BABED8;"> total</span><span style="color:#89DDFF;"> }</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">script</span><span style="color:#89DDFF;">&gt;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>è¿™ä¸ªä¾‹å­å®šä¹‰äº†ä¸€ä¸ª<code>number</code>å“åº”å¼å¯¹è±¡ï¼Œç„¶åå®šä¹‰äº†ä¸€ä¸ªè®¡ç®—å±æ€§totalï¼Œå®ƒæ˜¯é€šè¿‡numberçš„å€¼å¹¶è¿›è¡Œè®¡ç®—å¾—åˆ°çš„ã€‚å› æ­¤åœ¨é¡µé¢renderæ—¶ä¼šè®¿é—®totalï¼Œtotalä¼šæ”¶é›†å½“å‰çš„<code>activeEffect</code>ä¹Ÿå°±æ˜¯renderå‡½æ•°ï¼Œç„¶åcomputedåˆæ¬¡æ‰§è¡Œä¼šè®¿é—®numberå±æ€§ï¼Œè§¦å‘numberçš„getè¿™æ ·numberå°±ä¼šæ”¶é›†å½“å‰çš„<code>activeEffect</code>ä¹Ÿå°±æ˜¯totalä¸­çš„å‡½æ•°ã€‚è¿™æ ·å½“åœ¨é¡µé¢ä¸­ç‚¹å‡»æŒ‰é’®æ”¹å˜numberçš„å€¼æ—¶ï¼Œnumberé¦–å…ˆä¼šé€šçŸ¥computedé‡æ–°è®¡ç®—ï¼Œcomputedåœ¨é€šçŸ¥renderå‡½æ•°é‡æ–°æ¸²æŸ“</p><p>å½“ç„¶computedä¹Ÿæ˜¯æœ‰ç¼“å­˜çš„åŠŸèƒ½ï¼Œä¹Ÿæ˜¯é€šè¿‡<code>dirty</code>æ¥æ§åˆ¶çš„ï¼Œåªè¦å¯¹åº”çš„å“åº”å¼å¯¹è±¡çš„å€¼ä¸å˜ï¼Œdirtyå°±ä¸ºfalseä¸ä¼šæ‰§è¡Œï¼Œç›´æ¥è¿”å›ä¸Šæ¬¡çš„å€¼ï¼ˆé¦–æ¬¡dirtyä¸ºtrueï¼‰ï¼›æ¥ä¸‹æ¥ç®€å•åˆ†æä¸‹æ•´ä¸ªæµç¨‹ğŸ‘‡ï¼š</p><ol><li>computedçš„å†…éƒ¨å®ç°è¿‡ç¨‹ï¼Œé¦–å…ˆä½†æˆ‘ä»¬ç”¨<code>computed(() =&gt; number.value % 5)</code>è¿™æ ·çš„ä»£ç æ—¶å…ˆæ‰§è¡Œcomputedå‡½æ•°ï¼Œå†…éƒ¨ä¼šå¯¹ä¼ å…¥çš„å‚æ•°åšç»Ÿä¸€å¤„ç†ï¼Œä½ å¯ä»¥ä¼ å‡½æ•°ä¹Ÿå¯ä»¥ä¼ å¯¹è±¡ï¼ˆ<code>{get(),set()}</code>ï¼‰ï¼Œæœ€åå®ä¾‹åŒ–<code>ComputedRefImpl</code>å¹¶è¿”å›ã€‚ComputedRefImplå®ä¾‹åŒ–é¦–å…ˆä¼šåˆ›å»º<code>ReactiveEffect</code>ï¼Œå¹¶æ ‡è¯†å½“å‰computedå±æ€§ï¼Œæ¥è¡¨ç¤ºæ˜¯è®¡ç®—å±æ€§</li></ol><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#676E95;font-style:italic;">// packages/reactivity/src/computed 112è¡Œ</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#C792EA;"> function</span><span style="color:#82AAFF;"> computed</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">T</span><span style="color:#89DDFF;">&gt;(</span></span>
<span class="line"><span style="color:#BABED8;font-style:italic;">  getterOrOptions</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> ComputedGetter</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">T</span><span style="color:#89DDFF;">&gt;</span><span style="color:#89DDFF;"> |</span><span style="color:#FFCB6B;"> WritableComputedOptions</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">T</span><span style="color:#89DDFF;">&gt;,</span></span>
<span class="line"><span style="color:#BABED8;font-style:italic;">  debugOptions</span><span style="color:#89DDFF;">?:</span><span style="color:#FFCB6B;"> DebuggerOptions</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#BABED8;font-style:italic;">  isSSR</span><span style="color:#89DDFF;"> =</span><span style="color:#FF9CAC;"> false</span></span>
<span class="line"><span style="color:#89DDFF;">)</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#C792EA;">  let</span><span style="color:#BABED8;"> getter</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> ComputedGetter</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">T</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#C792EA;">  let</span><span style="color:#BABED8;"> setter</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> ComputedSetter</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">T</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">  const</span><span style="color:#BABED8;"> onlyGetter</span><span style="color:#89DDFF;"> =</span><span style="color:#82AAFF;"> isFunction</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">getterOrOptions</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  // å‡½æ•°å½¢å¼</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">  if</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">onlyGetter</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">    getter</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> getterOrOptions</span></span>
<span class="line"><span style="color:#BABED8;">    setter</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> NOOP</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span><span style="color:#89DDFF;font-style:italic;"> else</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // å¯¹è±¡å½¢å¼å’Œvue2ä¸€æ ·</span></span>
<span class="line"><span style="color:#BABED8;">    getter</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> getterOrOptions</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">get</span></span>
<span class="line"><span style="color:#BABED8;">    setter</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> getterOrOptions</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">set</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">  const</span><span style="color:#BABED8;"> cRef</span><span style="color:#89DDFF;"> =</span><span style="color:#89DDFF;"> new</span><span style="color:#82AAFF;"> ComputedRefImpl</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">getter</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> setter</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> onlyGetter</span><span style="color:#89DDFF;"> ||</span><span style="color:#89DDFF;"> !</span><span style="color:#BABED8;">setter</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> isSSR</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  // è¿”å›å½“å‰ ComputedRefImpl å®ä¾‹</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">  return</span><span style="color:#BABED8;"> cRef</span><span style="color:#89DDFF;font-style:italic;"> as</span><span style="color:#FFCB6B;"> any</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// computedçœŸæ­£çš„å¯¹è±¡ï¼Œcomputed.value å°±æ˜¯è¿™ä¸ªç±»ä¸­çš„å±æ€§</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#C792EA;"> class</span><span style="color:#FFCB6B;"> ComputedRefImpl</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">T</span><span style="color:#89DDFF;">&gt;</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#C792EA;">  public</span><span style="color:#F07178;"> dep</span><span style="color:#89DDFF;">?:</span><span style="color:#FFCB6B;"> Dep</span><span style="color:#89DDFF;"> =</span><span style="color:#89DDFF;"> undefined</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">  private</span><span style="color:#F07178;"> _value</span><span style="color:#89DDFF;">!:</span><span style="color:#FFCB6B;"> T</span></span>
<span class="line"><span style="color:#C792EA;">  public</span><span style="color:#C792EA;"> readonly</span><span style="color:#F07178;"> effect</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> ReactiveEffect</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">T</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">  public</span><span style="color:#F07178;"> _dirty</span><span style="color:#89DDFF;"> =</span><span style="color:#FF9CAC;"> true</span></span>
<span class="line"><span style="color:#C792EA;">  public</span><span style="color:#F07178;"> _cacheable</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> boolean</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">  constructor</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">getter</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;font-style:italic;"> _setter</span><span style="color:#89DDFF;">)</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // åˆ›å»ºè‡ªå·±çš„ReactiveEffectå¯¹è±¡</span></span>
<span class="line highlighted"><span style="color:#89DDFF;">    this.</span><span style="color:#BABED8;">effect</span><span style="color:#89DDFF;"> =</span><span style="color:#89DDFF;"> new</span><span style="color:#82AAFF;"> ReactiveEffect</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">getter</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;"> ()</span><span style="color:#C792EA;"> =&gt;</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">      if</span><span style="color:#F07178;"> (</span><span style="color:#89DDFF;">!this.</span><span style="color:#BABED8;">_dirty</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">        this.</span><span style="color:#BABED8;">_dirty</span><span style="color:#89DDFF;"> =</span><span style="color:#FF9CAC;"> true</span></span>
<span class="line"><span style="color:#82AAFF;">        triggerRefValue</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">this</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">      }</span></span>
<span class="line"><span style="color:#89DDFF;">    }</span><span style="color:#F07178;">)</span></span>
<span class="line highlighted"><span style="color:#89DDFF;">    this.</span><span style="color:#BABED8;">effect</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">computed</span><span style="color:#89DDFF;"> =</span><span style="color:#89DDFF;"> this</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  // çœç•¥...</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br></div></div><ol start="2"><li>ç„¶åå½“ç»„ä»¶renderå‡½æ•°æ‰§è¡Œæ—¶ä¼šè·å–computedçš„valueå±æ€§ï¼Œé¦–å…ˆä¼šæ‰§è¡Œ<code>trackRefValue</code>å‡½æ•°å†…éƒ¨ä¼šè®©å½“å‰è®¡ç®—å±æ€§çš„<code>dep</code>å¯¹renderå‡½æ•°è¿›è¡Œæ”¶é›†ï¼Œç„¶åç”±äºåˆæ¬¡<code>_dirty</code>ä¸ºtrueï¼Œå°±ä¼šæ‰§è¡Œ<code>effect.run</code>ä¹Ÿå°±æ˜¯ReactiveEffectçš„runï¼Œæ­¤è¿‡ç¨‹ä¼šè®¾ç½®<code>activeEffect</code>ä¸ºå½“å‰computedï¼Œç„¶åæ‰§è¡Œcomputedä¸­æˆ‘ä»¬å®šä¹‰å‡½æ•°ã€‚å†…éƒ¨ä¼šè®¿é—®<code>number</code>è§¦å‘å®ƒçš„getç„¶åå¯¹computedçš„effectè¿›è¡Œæ”¶é›†ï¼Œæœ€åæ‰§è¡Œå®Œå<code>_dirty</code>å˜æˆfalseï¼Œè¿™æ ·å°±å®Œæˆäº†åˆæ¬¡çš„ä¾èµ–å›æ”¶è¿‡ç¨‹</li></ol><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#C792EA;"> class</span><span style="color:#FFCB6B;"> ComputedRefImpl</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">T</span><span style="color:#89DDFF;">&gt;</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#C792EA;">  public</span><span style="color:#F07178;"> dep</span><span style="color:#89DDFF;">?:</span><span style="color:#FFCB6B;"> Dep</span><span style="color:#89DDFF;"> =</span><span style="color:#89DDFF;"> undefined</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">  private</span><span style="color:#F07178;"> _value</span><span style="color:#89DDFF;">!:</span><span style="color:#FFCB6B;"> T</span></span>
<span class="line"><span style="color:#C792EA;">  public</span><span style="color:#C792EA;"> readonly</span><span style="color:#F07178;"> effect</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> ReactiveEffect</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">T</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">  public</span><span style="color:#F07178;"> _dirty</span><span style="color:#89DDFF;"> =</span><span style="color:#FF9CAC;"> true</span></span>
<span class="line"><span style="color:#C792EA;">  public</span><span style="color:#F07178;"> _cacheable</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> boolean</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  // çœç•¥...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  // renderè·å–è®¡ç®—å±æ€§å€¼æ—¶è§¦å‘</span></span>
<span class="line"><span style="color:#C792EA;">  get</span><span style="color:#F07178;"> value</span><span style="color:#89DDFF;">()</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#C792EA;">    const</span><span style="color:#BABED8;"> self</span><span style="color:#89DDFF;"> =</span><span style="color:#82AAFF;"> toRaw</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">this</span><span style="color:#F07178;">)</span></span>
<span class="line highlighted"><span style="color:#82AAFF;">    trackRefValue</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">self</span><span style="color:#F07178;">) </span><span style="color:#676E95;font-style:italic;">// æ­¤è¿‡ç¨‹ä¼šè®©computedå¯¹renderè¿›è¡Œæ”¶é›†</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">    if</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">self</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">_dirty</span><span style="color:#89DDFF;"> ||</span><span style="color:#89DDFF;"> !</span><span style="color:#BABED8;">self</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">_cacheable</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">      self</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">_dirty</span><span style="color:#89DDFF;"> =</span><span style="color:#FF9CAC;"> false</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">      // ç¬¬ä¸€æ¬¡ dirty ä¸ºtrueï¼Œä¼šæ‰§è¡Œrunä¹Ÿå°±æ˜¯æ‰§è¡Œcomputedå›è°ƒå‡½æ•°ï¼Œå†…éƒ¨ä¼šè®¿é—®å“åº”å¼å¯¹è±¡ä½¿computedè¢«å¯¹åº”çš„dataæ”¶é›†</span></span>
<span class="line"><span style="color:#BABED8;">      self</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">_value</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> self</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">effect</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">run</span><span style="color:#F07178;">()</span><span style="color:#89DDFF;">!</span></span>
<span class="line"><span style="color:#89DDFF;">    }</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">    return</span><span style="color:#BABED8;"> self</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">_value</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">  set</span><span style="color:#F07178;"> value</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">newValue</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> T</span><span style="color:#89DDFF;">)</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#89DDFF;">    this.</span><span style="color:#82AAFF;">_setter</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">newValue</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// packages/reactivity/src/effect 53è¡Œ</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#C792EA;"> class</span><span style="color:#FFCB6B;"> ReactiveEffect</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">T</span><span style="color:#89DDFF;"> =</span><span style="color:#FFCB6B;"> any</span><span style="color:#89DDFF;">&gt;</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#F07178;">  run</span><span style="color:#89DDFF;">()</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#C792EA;">    let</span><span style="color:#BABED8;"> parent</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> ReactiveEffect</span><span style="color:#89DDFF;"> |</span><span style="color:#FFCB6B;"> undefined</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> activeEffect</span></span>
<span class="line"><span style="color:#C792EA;">    let</span><span style="color:#BABED8;"> lastShouldTrack</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> shouldTrack</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">    while</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">parent</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">      if</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">parent</span><span style="color:#89DDFF;"> ===</span><span style="color:#89DDFF;"> this</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">        return</span></span>
<span class="line"><span style="color:#89DDFF;">      }</span></span>
<span class="line"><span style="color:#BABED8;">      parent</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> parent</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">parent</span></span>
<span class="line"><span style="color:#89DDFF;">    }</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">    try</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#89DDFF;">      this.</span><span style="color:#BABED8;">parent</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> activeEffect</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">      // æ”¹å˜å½“å‰activeEffectä¸º computedçš„Effect</span></span>
<span class="line"><span style="color:#BABED8;">      activeEffect</span><span style="color:#89DDFF;"> =</span><span style="color:#89DDFF;"> this</span></span>
<span class="line"><span style="color:#BABED8;">      shouldTrack</span><span style="color:#89DDFF;"> =</span><span style="color:#FF9CAC;"> true</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">      trackOpBit</span><span style="color:#89DDFF;"> =</span><span style="color:#F78C6C;"> 1</span><span style="color:#89DDFF;"> &lt;&lt;</span><span style="color:#89DDFF;"> ++</span><span style="color:#BABED8;">effectTrackDepth</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">      if</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">effectTrackDepth</span><span style="color:#89DDFF;"> &lt;=</span><span style="color:#BABED8;"> maxMarkerBits</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#82AAFF;">        initDepMarkers</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">this</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">      }</span><span style="color:#89DDFF;font-style:italic;"> else</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#82AAFF;">        cleanupEffect</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">this</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">      }</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">      // æ‰§è¡Œcomputed å›è°ƒå‡½æ•°ï¼Œå†…éƒ¨è®¿é—®numberå€¼ï¼Œè§¦å‘numberå¯¹computedçš„æ”¶é›†</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">      return</span><span style="color:#89DDFF;"> this.</span><span style="color:#82AAFF;">fn</span><span style="color:#F07178;">()</span></span>
<span class="line"><span style="color:#89DDFF;">    }</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br></div></div><ol start="3"><li>å½“æ”¹å˜numberçš„å€¼æ—¶ï¼Œä¼šæ´¾å‘æ›´æ–°é€šçŸ¥numberçš„depä¸­çš„æ‰€æœ‰effectè¿›è¡Œæ›´æ–°ï¼Œè¿™é‡Œå°±ä¼šé€šçŸ¥computed effectè¿›è¡Œæ›´æ–°ï¼Œä½†è¿™é‡Œä¸ä¼šæ‰§è¡Œ<code>ReactiveEffect</code>çš„runå‡½æ•°ï¼Œè€Œæ‰§è¡Œ<code>scheduler</code>å‡½æ•°ï¼Œschedulerä»…ä»…ä¼šå°†<code>_dirty</code>çš„å€¼æ”¹ä¸ºfalseï¼Œç„¶åé€šçŸ¥computedè‡ªå·±çš„depä¸­çš„æ‰€æœ‰effectè¿›è¡Œæ›´æ–°ï¼Œè¿™æ ·renderå‡½æ•°é‡æ–°æ‰§è¡Œæ—¶å°±å’Œç¬¬ä¸€æ¬¡æ‰§è¡Œä¸€è‡´äº†ï¼š</li></ol><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#676E95;font-style:italic;">// numberè§¦å‘è‡ªå·±çš„ä¾èµ–è¿›è¡Œæ›´æ–°</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#C792EA;"> function</span><span style="color:#82AAFF;"> triggerEffects</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">dep</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;font-style:italic;"> debuggerEventExtraInfo</span><span style="color:#89DDFF;">)</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#C792EA;">  const</span><span style="color:#BABED8;"> effects</span><span style="color:#89DDFF;"> =</span><span style="color:#82AAFF;"> isArray</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">dep</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">?</span><span style="color:#BABED8;"> dep</span><span style="color:#89DDFF;"> :</span><span style="color:#F07178;"> [</span><span style="color:#89DDFF;">...</span><span style="color:#BABED8;">dep</span><span style="color:#F07178;">]</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">  for</span><span style="color:#F07178;"> (</span><span style="color:#C792EA;">const</span><span style="color:#BABED8;"> effect</span><span style="color:#89DDFF;"> of</span><span style="color:#BABED8;"> effects</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // æ‰§è¡Œè®¡ç®—å±æ€§</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">    if</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">effect</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">computed</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#82AAFF;">      triggerEffect</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">effect</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> debuggerEventExtraInfo</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">    }</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  // çœç•¥...</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">function</span><span style="color:#82AAFF;"> triggerEffect</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">effect</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> ReactiveEffect</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;font-style:italic;"> debuggerEventExtraInfo</span><span style="color:#89DDFF;">?:</span><span style="color:#FFCB6B;"> DebuggerEventExtraInfo</span><span style="color:#89DDFF;">)</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">  if</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">effect</span><span style="color:#89DDFF;"> !==</span><span style="color:#BABED8;"> activeEffect</span><span style="color:#89DDFF;"> ||</span><span style="color:#BABED8;"> effect</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">allowRecurse</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // æ³¨æ„è¿™ä¸ª scheduler å±æ€§å¾ˆé‡è¦ï¼Œè¿™ä¸ªåœ¨ ComputedRefImpl å®ä¾‹åŒ–æ—¶ä¼šä¼ å…¥</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // æ‰€ä»¥å®ƒä¼šæ‰§è¡Œ schedulerï¼Œè€Œä¸æ˜¯runå‡½æ•°ï¼Œä¹Ÿå°±æ˜¯ä¸ä¼šç«‹é©¬æ‰§è¡Œcomputedå›è°ƒï¼Œç­‰åˆ°renderæ—¶æ‰ä¼šæ‰§è¡Œ</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">    if</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">effect</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">scheduler</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">      effect</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">scheduler</span><span style="color:#F07178;">()</span></span>
<span class="line"><span style="color:#89DDFF;">    }</span><span style="color:#89DDFF;font-style:italic;"> else</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#BABED8;">      effect</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">run</span><span style="color:#F07178;">()</span></span>
<span class="line"><span style="color:#89DDFF;">    }</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#C792EA;"> class</span><span style="color:#FFCB6B;"> ComputedRefImpl</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">T</span><span style="color:#89DDFF;">&gt;</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  // éƒ¨åˆ†çœç•¥...</span></span>
<span class="line"><span style="color:#C792EA;">  constructor</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#BABED8;font-style:italic;">    getter</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> ComputedGetter</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">T</span><span style="color:#89DDFF;">&gt;,</span></span>
<span class="line"><span style="color:#C792EA;">    private</span><span style="color:#C792EA;"> readonly</span><span style="color:#BABED8;font-style:italic;"> _setter</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> ComputedSetter</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">T</span><span style="color:#89DDFF;">&gt;,</span></span>
<span class="line"><span style="color:#BABED8;font-style:italic;">    isReadonly</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> boolean</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#BABED8;font-style:italic;">    isSSR</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> boolean</span></span>
<span class="line"><span style="color:#89DDFF;">  )</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#89DDFF;">    this.</span><span style="color:#BABED8;">effect</span><span style="color:#89DDFF;"> =</span><span style="color:#89DDFF;"> new</span><span style="color:#82AAFF;"> ReactiveEffect</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">getter</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;"> ()</span><span style="color:#C792EA;"> =&gt;</span><span style="color:#89DDFF;"> {</span><span style="color:#676E95;font-style:italic;"> // è¿™ä¸ªå°±æ˜¯ scheduler</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">      if</span><span style="color:#F07178;"> (</span><span style="color:#89DDFF;">!this.</span><span style="color:#BABED8;">_dirty</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">        this.</span><span style="color:#BABED8;">_dirty</span><span style="color:#89DDFF;"> =</span><span style="color:#FF9CAC;"> true</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">        // ä¸Šé¢æ‰§è¡Œè¿™é‡Œæ—¶ï¼Œcomputedé€šçŸ¥è‡ªå·±depä¸­æ”¶é›†çš„æ‰€æœ‰ä¾èµ–è¿›è¡Œæ›´æ–°ï¼Œè¿™æ—¶å°±ä¼šé‡æ–°æ‰§è¡Œrender</span></span>
<span class="line"><span style="color:#82AAFF;">        triggerRefValue</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">this</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">      }</span></span>
<span class="line"><span style="color:#89DDFF;">    }</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><p>ä»¥ä¸Šå°±æ˜¯vue3çš„computedæ•´ä½“è¿‡ç¨‹ï¼Œæ•´ä½“æ¥è¯´vue3çš„å®ç°æ›´åŠ æ¸…æ™°ã€‚vue3ä¸­é€šè¿‡<code>trackã€trigger</code>effectæœºåˆ¶å®Œæˆä¾èµ–æ”¶é›†å’Œæ´¾å‘æ›´æ–°ï¼Œå› æ­¤æ‰€æœ‰å¯¹è±¡éƒ½å¯èƒ½æ˜¯effectï¼Œè€Œæ²¡æœ‰åƒvue2ä¸­é‚£æ ·æ­»æ¿ã€‚å†è€…å°±æ˜¯vue3çš„computedä¾èµ–æ”¶é›†èƒ½çœŸæ­£åæ˜ å‡ºä¾èµ–çš„æ”¶é›†å…³ç³»ï¼Œè€Œä¸åƒvue2ä¸­dataè¿˜éœ€è¦é¢å¤–å¯¹renderæ”¶é›†ä¸€æ¬¡ï¼</p><h2 id="ä¾¦å¬å‡½æ•°" tabindex="-1">ä¾¦å¬å‡½æ•° <a class="header-anchor" href="#ä¾¦å¬å‡½æ•°" aria-label="Permalink to &quot;ä¾¦å¬å‡½æ•°&quot;">â€‹</a></h2><p><u>ä¾¦å¬å‡½æ•°</u>åœ¨vueä¸­å°±æ˜¯æˆ‘ä»¬å¸¸ç”¨çš„watchåˆç§°<code>user watcher</code>ï¼Œä¹‹æ‰€ä»¥è¿™ä¹ˆç§°å‘¼æ˜¯å› ä¸ºå®ƒä¹Ÿæ˜¯ä¸€ä¸ªwatcherå¯¹è±¡å¹¶ä¸”userçš„å€¼ä¸ºtrueã€‚watché€šå¸¸ç”¨æ¥ç›‘å¬å“åº”å¼å¯¹è±¡ï¼Œå½“å“åº”å¼å¯¹è±¡setteræ‰§è¡Œæ—¶ä¼šé€šè¿‡depé€šçŸ¥user watcheræ‰§è¡Œï¼Œå°±ä¼šæ‰§è¡Œæˆ‘ä»¬watchä¸­å®šä¹‰çš„å›è°ƒå‡½æ•°ï¼Œç„¶åå†åšç‚¹ä»€ä¹ˆğŸ‘€</p><h3 id="ç®€å•ä½¿ç”¨-1" tabindex="-1">ç®€å•ä½¿ç”¨ <a class="header-anchor" href="#ç®€å•ä½¿ç”¨-1" aria-label="Permalink to &quot;ç®€å•ä½¿ç”¨&quot;">â€‹</a></h3><div class="language-vue line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">vue</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">template</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">  &lt;</span><span style="color:#F07178;">button</span><span style="color:#89DDFF;"> @</span><span style="color:#C792EA;">click</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#BABED8;">count</span><span style="color:#89DDFF;">++</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">&gt;</span><span style="color:#BABED8;">æ”¹å˜</span><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">button</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">template</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">script</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#89DDFF;font-style:italic;"> default</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#82AAFF;">  data</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> ()</span><span style="color:#C792EA;"> =&gt;</span><span style="color:#BABED8;"> (</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    count</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;"> 0</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span><span style="color:#BABED8;">)</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">  watch</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#F07178;">    count</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> &quot;</span><span style="color:#C3E88D;">watchCount</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#89DDFF;">  },</span></span>
<span class="line"><span style="color:#F07178;">  methods</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#F07178;">    watchCount</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">n</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;font-style:italic;"> o</span><span style="color:#89DDFF;">)</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#BABED8;">      console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">n</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> o</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">    }</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">script</span><span style="color:#89DDFF;">&gt;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>ä½ å¯ä»¥èƒ½æ²¡è§è¿‡ä»¥ä¸Šwatchå½¢å¼ï¼Œ<code>count</code>çš„å€¼ä»…ä»…æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå¹¶ä¸æ˜¯æˆ‘ä»¬å¸¸ç”¨çš„å‡½æ•°æˆ–è€…å¯¹è±¡ï¼Œä½†æ˜¯ä»–ç¡®å®èƒ½ç›‘å¬åˆ°countçš„å˜åŒ–ï¼Œæ‰§è¡Œçš„æ˜¯methodsä¸­å¯¹åº”çš„æ–¹æ³•ï¼Œè¿™ç§å†™æ³•åé¢ä½ å°±ä¼šæ˜ç™½ <img src="https://ihengshuai-demo1.oss-cn-beijing.aliyuncs.com/image-20230520181916845.png" alt=""></p><h3 id="åˆå§‹åŒ–è¿‡ç¨‹" tabindex="-1">åˆå§‹åŒ–è¿‡ç¨‹ <a class="header-anchor" href="#åˆå§‹åŒ–è¿‡ç¨‹" aria-label="Permalink to &quot;åˆå§‹åŒ–è¿‡ç¨‹&quot;">â€‹</a></h3><p>å…¶å®user watchå¾ˆç®€å•ï¼Œè¿™é‡Œå°±ç®€å•çš„å•ƒä¸‹æºç ï¼š</p><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#676E95;font-style:italic;">// src/core/instance/state 58è¡Œ</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#C792EA;"> function</span><span style="color:#82AAFF;"> initState</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">vm</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> Component</span><span style="color:#89DDFF;">)</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#C792EA;">  const</span><span style="color:#BABED8;"> opts</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> vm</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">$options</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  // å¦‚æœå®šä¹‰äº†watchï¼Œå°±è¿›è¡Œåˆå§‹åŒ–</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">  if</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">opts</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">watch</span><span style="color:#89DDFF;"> &amp;&amp;</span><span style="color:#BABED8;"> opts</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">watch</span><span style="color:#89DDFF;"> !==</span><span style="color:#BABED8;"> nativeWatch</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#82AAFF;">    initWatch</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">vm</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> opts</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">watch</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// åˆå§‹åŒ–</span></span>
<span class="line"><span style="color:#C792EA;">function</span><span style="color:#82AAFF;"> initWatch</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">vm</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> Component</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;font-style:italic;"> watch</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> Object</span><span style="color:#89DDFF;">)</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">  for</span><span style="color:#F07178;"> (</span><span style="color:#C792EA;">const</span><span style="color:#BABED8;"> key</span><span style="color:#89DDFF;"> in</span><span style="color:#BABED8;"> watch</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#C792EA;">    const</span><span style="color:#BABED8;"> handler</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> watch</span><span style="color:#F07178;">[</span><span style="color:#BABED8;">key</span><span style="color:#F07178;">]</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // watchå±æ€§å€¼ä¸ºæ•°ç»„çš„æƒ…å†µ</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">    if</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">Array</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">isArray</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">handler</span><span style="color:#F07178;">)) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">      for</span><span style="color:#F07178;"> (</span><span style="color:#C792EA;">let</span><span style="color:#BABED8;"> i</span><span style="color:#89DDFF;"> =</span><span style="color:#F78C6C;"> 0</span><span style="color:#89DDFF;">;</span><span style="color:#BABED8;"> i</span><span style="color:#89DDFF;"> &lt;</span><span style="color:#BABED8;"> handler</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">length</span><span style="color:#89DDFF;">;</span><span style="color:#BABED8;"> i</span><span style="color:#89DDFF;">++</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#82AAFF;">        createWatcher</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">vm</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> key</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> handler</span><span style="color:#F07178;">[</span><span style="color:#BABED8;">i</span><span style="color:#F07178;">])</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">      }</span></span>
<span class="line"><span style="color:#89DDFF;">    }</span><span style="color:#89DDFF;font-style:italic;"> else</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    	// watch å±æ€§çš„å€¼ä¸ºæ™®é€šå¯¹è±¡</span></span>
<span class="line"><span style="color:#82AAFF;">      createWatcher</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">vm</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> key</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> handler</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">    }</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// æ¯ä¸ªwatch åˆ›å»ºå¯¹åº”çš„watch</span></span>
<span class="line"><span style="color:#C792EA;">function</span><span style="color:#82AAFF;"> createWatcher</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#BABED8;font-style:italic;">  vm</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> Component</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#BABED8;font-style:italic;">  expOrFn</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> string</span><span style="color:#89DDFF;"> |</span><span style="color:#FFCB6B;"> Function</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#BABED8;font-style:italic;">  handler</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> any</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#BABED8;font-style:italic;">  options</span><span style="color:#89DDFF;">?:</span><span style="color:#FFCB6B;"> Object</span></span>
<span class="line"><span style="color:#89DDFF;">)</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	// è¿™é‡Œä¼šå¯¹handleråšç»Ÿä¸€å¤„ç†ï¼Œhandlerä¹Ÿå°±æ˜¯å›è°ƒå‡½æ•°ï¼Œå¯èƒ½æ˜¯å‡½æ•°ã€å¯¹è±¡ã€å­—ç¬¦ä¸²</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	// å¦‚æœå½“å‰çš„å±æ€§çš„å€¼ï¼ˆhandlerï¼‰ä¸ºå¯¹è±¡ï¼Œé‚£ä¹ˆå›è°ƒå‡½æ•°å°±ä¸º å¯¹è±¡çš„ handler å±æ€§ï¼ˆè¿™ç§æ–¹å¼åº”è¯¥ç”¨è¿‡ï¼‰</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">  if</span><span style="color:#F07178;"> (</span><span style="color:#82AAFF;">isPlainObject</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">handler</span><span style="color:#F07178;">)) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">    options</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> handler</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#BABED8;">    handler</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> handler</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">handler</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  // å½“å‰å±æ€§çš„å€¼ï¼ˆhandlerï¼‰ä¸ºå­—ç¬¦ä¸²ï¼Œå›è°ƒå°±ä»å½“å‰å®ä¾‹ä¸Šå–</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">  if</span><span style="color:#F07178;"> (</span><span style="color:#89DDFF;">typeof</span><span style="color:#BABED8;"> handler</span><span style="color:#89DDFF;"> ===</span><span style="color:#89DDFF;"> &quot;</span><span style="color:#C3E88D;">string</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">    handler</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> vm</span><span style="color:#F07178;">[</span><span style="color:#BABED8;">handler</span><span style="color:#F07178;">]</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  // æœ€åæ‰§è¡Œæ‰§è¡Œ $watch æ–¹æ³•</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">  return</span><span style="color:#BABED8;"> vm</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">$watch</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">expOrFn</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> handler</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> options</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div><p>è¿™é‡Œåˆ—ä¸¾ä¸‹ä»¥ä¸Šwatchçš„ä¸åŒçš„å®šä¹‰å½¢å¼ï¼š</p><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#FFCB6B;">watch</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  // å‡½æ•°</span></span>
<span class="line"><span style="color:#82AAFF;">  count</span><span style="color:#F07178;">() </span><span style="color:#89DDFF;">{},</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  // æ•°ç»„å’Œå­—ç¬¦ä¸²ï¼Œå¾ªç¯æ—¶å°±æ˜¯å­—ç¬¦ä¸²ï¼›å­—ç¬¦ä¸²æ—¶å›è°ƒå‡½æ•°ä¼šä»thisä¸Šæ‹¿ï¼Œä¹Ÿå°±æ˜¯vm[&#39;cb1&#39;]</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  // è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬çš„ä¾‹å­å¯ä»¥å†™æˆå­—ç¬¦ä¸²çš„å½¢å¼ï¼Œå…¶å®é€šè¿‡vm[&#39;watchCount&#39;]ä¼šå–åˆ°methodsä¸Šçš„æ–¹æ³•</span></span>
<span class="line"><span style="color:#FFCB6B;">  count</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> [</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">cb1</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;"> &quot;</span><span style="color:#C3E88D;">cb2</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">]</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#FFCB6B;">  count</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> &quot;</span><span style="color:#C3E88D;">cb1</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  // å¯¹è±¡</span></span>
<span class="line"><span style="color:#FFCB6B;">  count</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#82AAFF;">    handler</span><span style="color:#F07178;">() </span><span style="color:#89DDFF;">{}</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h3 id="watch" tabindex="-1">$watch <a class="header-anchor" href="#watch" aria-label="Permalink to &quot;$watch&quot;">â€‹</a></h3><p>æˆ‘ä»¬å®šä¹‰çš„watchæœ€ç»ˆå†…éƒ¨ä¼šè°ƒç”¨åŸå‹<code>$watch</code>æ–¹æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨$watchè¿›è¡Œå‡½æ•°ä¾¦å¬ï¼š</p><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#C792EA;">const</span><span style="color:#BABED8;"> unwatch </span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;"> this.</span><span style="color:#82AAFF;">$watch</span><span style="color:#BABED8;">(key</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> cb</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> ops)</span><span style="color:#89DDFF;">;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><ol><li>$watchæ˜¯å®ç°ä¾¦å¬å‡½æ•°çš„æ ¸å¿ƒï¼Œé‚£ä¹ˆå°±æ¥çœ‹çœ‹å®ƒå†…éƒ¨å…·ä½“å®ç°ï¼š</li></ol><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#FFCB6B;">Vue</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">prototype</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">$watch</span><span style="color:#89DDFF;"> =</span><span style="color:#C792EA;"> function</span><span style="color:#89DDFF;"> (</span><span style="color:#BABED8;font-style:italic;">expOrFn</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> string</span><span style="color:#89DDFF;"> |</span><span style="color:#FFCB6B;"> Function</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;font-style:italic;"> cb</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> any</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;font-style:italic;"> options</span><span style="color:#89DDFF;">?:</span><span style="color:#FFCB6B;"> Object</span><span style="color:#89DDFF;">):</span><span style="color:#FFCB6B;"> Function</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#C792EA;">  const</span><span style="color:#BABED8;"> vm</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> Component</span><span style="color:#89DDFF;"> =</span><span style="color:#89DDFF;"> this;</span></span>
<span class="line"><span style="color:#BABED8;">  options</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> options</span><span style="color:#89DDFF;"> ||</span><span style="color:#89DDFF;"> {};</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  // è®¾ç½®userä¸ºtrueï¼Œè¿™ä¸ªå¾ˆé‡è¦ç”¨æ¥è¡¨ç¤ºå½“å‰Watcherä¸ºuser watcher</span></span>
<span class="line"><span style="color:#BABED8;">  options</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">user</span><span style="color:#89DDFF;"> =</span><span style="color:#FF9CAC;"> true</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  // åˆ›å»ºuser Watcher</span></span>
<span class="line"><span style="color:#C792EA;">  const</span><span style="color:#BABED8;"> watcher</span><span style="color:#89DDFF;"> =</span><span style="color:#89DDFF;"> new</span><span style="color:#82AAFF;"> Watcher</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">vm</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> expOrFn</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> cb</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> options</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  // å¦‚æœè®¾ç½® immediateï¼Œä¼šç«‹å³æ‰§è¡Œä¸€æ¬¡ cb</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">  if</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">options</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">immediate</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">    cb</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">call</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">vm</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> watcher</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">value</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  // $watch å‡½æ•°ä¼šè¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œæ‰§è¡Œå®ƒ ä¼šæ‰§è¡Œ watcher.teardown</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">  return</span><span style="color:#C792EA;"> function</span><span style="color:#82AAFF;"> unwatchFn</span><span style="color:#89DDFF;">()</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#BABED8;">    watcher</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">teardown</span><span style="color:#F07178;">()</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">  };</span></span>
<span class="line"><span style="color:#89DDFF;">};</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><ol start="2"><li>åˆ›å»ºuserWatcheræ—¶ä¼šæ ‡è¯†å½“å‰watcherä¸ºuser watcher(user = true)ï¼Œå¹¶ä¸”æœ‰cbä¹Ÿå°±æ˜¯watchçš„å›è°ƒå‡½æ•°ã€‚è¿™é‡Œæœ€é‡è¦çš„å°±æ˜¯<code>parsePath</code>å¯¹<code>expOrFn</code>çš„è§£æï¼Œé€šå¸¸watchç”¨æ¥æ£€æµ‹å“åº”å¼å¯¹è±¡ï¼Œä¸€èˆ¬éƒ½ä¼šå†™å¯¹åº”çš„keyä¹Ÿå¯ä»¥åµŒå¥—ï¼ˆå¦‚ï¼š<code>fooã€foo.bar</code>ï¼‰ã€‚parsePathè¿”å›ä¸€ä¸ªå‡½æ•°å¹¶èµ‹å€¼ç»™<code>watcher.getter</code>ï¼Œç„¶åç«‹å³æ‰§è¡Œgetterï¼Œä¹Ÿå°±ä¼šæ‰§è¡ŒparsePathè¿”å›çš„å‡½æ•°ï¼Œæ‰§è¡Œæ—¶ä¼šå°†å½“å‰vmä¼ å…¥ï¼Œç„¶åæ ¹æ®watchç›‘å¬çš„keyå¾ªç¯è·å–åˆ°å¯¹åº”çš„å“åº”å¼å±æ€§çš„å€¼ï¼Œç„¶åè¿”å›ã€‚æ­¤è¿‡ç¨‹å°±ä¼šè§¦å‘æ£€æµ‹çš„keyå¯¹å½“å‰userWatcherçš„æ”¶é›†</li></ol><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#89DDFF;font-style:italic;"> default</span><span style="color:#C792EA;"> class</span><span style="color:#FFCB6B;"> Watcher</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#F07178;">  vm</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> Component</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">  cb</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> Function</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">  user</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> boolean</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">  value</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> any</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">  constructor</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">vm</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> Component</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;font-style:italic;"> expOrFn</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> string</span><span style="color:#89DDFF;"> |</span><span style="color:#FFCB6B;"> Function</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> cb</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> Function</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;font-style:italic;"> options</span><span style="color:#89DDFF;">?:</span><span style="color:#FFCB6B;"> Object</span><span style="color:#89DDFF;">)</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#89DDFF;">    this.</span><span style="color:#BABED8;">vm</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> vm</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // this.user ä¸ºtrue</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">    if</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">options</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span><span style="color:#89DDFF;"> this.</span><span style="color:#BABED8;">user</span><span style="color:#89DDFF;"> =</span><span style="color:#89DDFF;"> !!</span><span style="color:#BABED8;">options</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">user</span><span style="color:#89DDFF;">;}</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // cb å°±æ˜¯ watch çš„å›è°ƒå‡½æ•°</span></span>
<span class="line"><span style="color:#89DDFF;">    this.</span><span style="color:#BABED8;">cb</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> cb</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // è¿™é‡Œéœ€è¦æ³¨æ„ expOrFn é€šå¸¸ä¸º å­—ç¬¦ä¸² å¦‚ï¼šthis.$watch(&quot;a.b.c&quot;, cb, {});</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">    if</span><span style="color:#F07178;"> (</span><span style="color:#89DDFF;">typeof</span><span style="color:#BABED8;"> expOrFn</span><span style="color:#89DDFF;"> ===</span><span style="color:#89DDFF;"> &quot;</span><span style="color:#C3E88D;">function</span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span><span style="color:#89DDFF;"> this.</span><span style="color:#BABED8;">getter</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> expOrFn</span><span style="color:#89DDFF;">;</span><span style="color:#89DDFF;"> }</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // é‚£ä¹ˆå°±ä¼šèµ°è¿™é‡Œï¼Œè¿™é‡Œä¼šé€šè¿‡parsePathå°† ç”¨æˆ·ç›‘å¬çš„ key ä¼ é€’è¿›å»ï¼Œæœ€åè¿”å›</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">    else</span><span style="color:#89DDFF;"> {</span><span style="color:#89DDFF;"> this.</span><span style="color:#BABED8;">getter</span><span style="color:#89DDFF;"> =</span><span style="color:#82AAFF;"> parsePath</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">expOrFn</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span><span style="color:#89DDFF;"> }</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // æœ€åæ‰§è¡Œå¾—åˆ°å€¼</span></span>
<span class="line"><span style="color:#89DDFF;">    this.</span><span style="color:#BABED8;">value</span><span style="color:#89DDFF;"> =</span><span style="color:#89DDFF;"> this.</span><span style="color:#BABED8;">lazy</span><span style="color:#89DDFF;"> ?</span><span style="color:#89DDFF;"> undefined</span><span style="color:#89DDFF;"> :</span><span style="color:#89DDFF;"> this.</span><span style="color:#82AAFF;">get</span><span style="color:#F07178;">()</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// parsePath ä¼šè¿”å›ä¸€ä¸ªå‡½æ•°</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#BABED8;"> bailRE </span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;"> new</span><span style="color:#82AAFF;"> RegExp</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">[^</span><span style="color:#89DDFF;">\${</span><span style="color:#BABED8;">unicodeRegExp</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">source</span><span style="color:#89DDFF;">}</span><span style="color:#C3E88D;">.$_</span><span style="color:#BABED8;">\\\\</span><span style="color:#C3E88D;">d]</span><span style="color:#89DDFF;">\`</span><span style="color:#BABED8;">)</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#C792EA;"> function</span><span style="color:#82AAFF;"> parsePath</span><span style="color:#89DDFF;"> (</span><span style="color:#BABED8;font-style:italic;">path</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> string</span><span style="color:#89DDFF;">):</span><span style="color:#FFCB6B;"> any</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">  if</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">bailRE</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">test</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">path</span><span style="color:#F07178;">)) </span><span style="color:#89DDFF;">{</span><span style="color:#89DDFF;font-style:italic;"> return</span><span style="color:#89DDFF;"> }</span></span>
<span class="line"><span style="color:#C792EA;">  const</span><span style="color:#BABED8;"> segments</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> path</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">split</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">.</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">  return</span><span style="color:#C792EA;"> function</span><span style="color:#89DDFF;"> (</span><span style="color:#BABED8;font-style:italic;">obj</span><span style="color:#89DDFF;">)</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">    for</span><span style="color:#F07178;"> (</span><span style="color:#C792EA;">let</span><span style="color:#BABED8;"> i</span><span style="color:#89DDFF;"> =</span><span style="color:#F78C6C;"> 0</span><span style="color:#89DDFF;">;</span><span style="color:#BABED8;"> i</span><span style="color:#89DDFF;"> &lt;</span><span style="color:#BABED8;"> segments</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">length</span><span style="color:#89DDFF;">;</span><span style="color:#BABED8;"> i</span><span style="color:#89DDFF;">++</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">      if</span><span style="color:#F07178;"> (</span><span style="color:#89DDFF;">!</span><span style="color:#BABED8;">obj</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;font-style:italic;">return</span></span>
<span class="line"><span style="color:#BABED8;">      obj</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> obj</span><span style="color:#F07178;">[</span><span style="color:#BABED8;">segments</span><span style="color:#F07178;">[</span><span style="color:#BABED8;">i</span><span style="color:#F07178;">]]</span></span>
<span class="line"><span style="color:#89DDFF;">    }</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">    return</span><span style="color:#BABED8;"> obj</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><ol start="3"><li>å½“watchç›‘å¬çš„keyå€¼è¢«ä¿®æ”¹åå°±ä¼šè®©depé€šçŸ¥user watcherè¿›è¡Œæ›´æ–°ï¼Œuser watcherå°±ä¼šæ‰§è¡Œupdateæ–¹æ³•ï¼Œç„¶åé€šè¿‡å¼‚æ­¥æ›´æ–°é˜Ÿåˆ—ç­–ç•¥ï¼Œæœ€åæ‰§è¡Œwatcherçš„runæ–¹æ³•ï¼š</li></ol><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#89DDFF;font-style:italic;"> default</span><span style="color:#C792EA;"> class</span><span style="color:#FFCB6B;"> Watcher</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  // depé€šçŸ¥watchæ›´æ–°</span></span>
<span class="line"><span style="color:#F07178;">  update</span><span style="color:#89DDFF;">()</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">    if</span><span style="color:#F07178;"> (</span><span style="color:#89DDFF;">this.</span><span style="color:#BABED8;">lazy</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span><span style="color:#89DDFF;"> this.</span><span style="color:#BABED8;">dirty</span><span style="color:#89DDFF;"> =</span><span style="color:#FF9CAC;"> true</span><span style="color:#89DDFF;">;</span><span style="color:#89DDFF;"> }</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">    else</span><span style="color:#89DDFF;font-style:italic;"> if</span><span style="color:#F07178;"> (</span><span style="color:#89DDFF;">this.</span><span style="color:#BABED8;">sync</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span><span style="color:#89DDFF;"> this.</span><span style="color:#82AAFF;">run</span><span style="color:#F07178;">()</span><span style="color:#89DDFF;">;</span><span style="color:#89DDFF;"> }</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // è¿™é‡Œuser watcheer ä¼šè¿›å…¥æ›´æ–°é˜Ÿåˆ—</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">    else</span><span style="color:#89DDFF;"> {</span><span style="color:#82AAFF;"> queueWatcher</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">this</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span><span style="color:#89DDFF;"> }</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  // æ›´æ–°é˜Ÿåˆ—æ‰§è¡Œæ—¶ä¼šæ‰§è¡Œwatcher.run</span></span>
<span class="line"><span style="color:#F07178;">  run</span><span style="color:#89DDFF;">()</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">    if</span><span style="color:#F07178;"> (</span><span style="color:#89DDFF;">this.</span><span style="color:#BABED8;">active</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">      // æ‹¿åˆ°æœ€æ–°çš„å€¼</span></span>
<span class="line"><span style="color:#C792EA;">      const</span><span style="color:#BABED8;"> value</span><span style="color:#89DDFF;"> =</span><span style="color:#89DDFF;"> this.</span><span style="color:#82AAFF;">get</span><span style="color:#F07178;">()</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">      if</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">value</span><span style="color:#89DDFF;"> !==</span><span style="color:#89DDFF;"> this.</span><span style="color:#BABED8;">value</span><span style="color:#89DDFF;"> ||</span><span style="color:#82AAFF;"> isObject</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">value</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">||</span><span style="color:#89DDFF;"> this.</span><span style="color:#BABED8;">deep</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#C792EA;">        const</span><span style="color:#BABED8;"> oldValue</span><span style="color:#89DDFF;"> =</span><span style="color:#89DDFF;"> this.</span><span style="color:#BABED8;">value</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">        this.</span><span style="color:#BABED8;">value</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> value</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">        // å¦‚æœæ˜¯user watcherï¼Œæ‰§è¡Œcb</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">        if</span><span style="color:#F07178;"> (</span><span style="color:#89DDFF;">this.</span><span style="color:#BABED8;">user</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">          this.</span><span style="color:#BABED8;">cb</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">call</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">this.</span><span style="color:#BABED8;">vm</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> value</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> oldValue</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">        }</span><span style="color:#89DDFF;font-style:italic;"> else</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#89DDFF;">          this.</span><span style="color:#BABED8;">cb</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">call</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">this.</span><span style="color:#BABED8;">vm</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> value</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> oldValue</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">        }</span></span>
<span class="line"><span style="color:#89DDFF;">      }</span></span>
<span class="line"><span style="color:#89DDFF;">    }</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><h3 id="immediate" tabindex="-1">immediate <a class="header-anchor" href="#immediate" aria-label="Permalink to &quot;immediate&quot;">â€‹</a></h3><p>immediateä¼šè®©watchç«‹å³æ‰§è¡Œä¸€æ¬¡ï¼Œæ¥çœ‹å®ƒçš„å®ç°ï¼š</p><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#FFCB6B;">Vue</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">prototype</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">$watch</span><span style="color:#89DDFF;"> =</span><span style="color:#C792EA;"> function</span><span style="color:#89DDFF;"> (</span><span style="color:#BABED8;font-style:italic;">expOrFn</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> string</span><span style="color:#89DDFF;"> |</span><span style="color:#FFCB6B;"> Function</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;font-style:italic;"> cb</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> any</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;font-style:italic;"> options</span><span style="color:#89DDFF;">?:</span><span style="color:#FFCB6B;"> Object</span><span style="color:#89DDFF;">):</span><span style="color:#FFCB6B;"> Function</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  // çœç•¥...</span></span>
<span class="line"><span style="color:#C792EA;">  const</span><span style="color:#BABED8;"> watcher</span><span style="color:#89DDFF;"> =</span><span style="color:#89DDFF;"> new</span><span style="color:#82AAFF;"> Watcher</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">vm</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> expOrFn</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> cb</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> options</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  // å¦‚æœè®¾ç½® immediateï¼Œä¼šç«‹å³æ‰§è¡Œä¸€æ¬¡ cb</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">  if</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">options</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">immediate</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">    cb</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">call</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">vm</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> watcher</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">value</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  //...</span></span>
<span class="line"><span style="color:#89DDFF;">};</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="äº‹ä»¶å¸è½½" tabindex="-1">äº‹ä»¶å¸è½½ <a class="header-anchor" href="#äº‹ä»¶å¸è½½" aria-label="Permalink to &quot;äº‹ä»¶å¸è½½&quot;">â€‹</a></h3><p>watchå¯ä»¥ä¸»åŠ¨è¿›è¡Œç›‘å¬çš„å¸è½½ï¼Œwatchä¼šè¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œæ‰§è¡Œå®ƒå°±ä¼šå¸è½½ç›‘å¬ã€‚åŸç†å°±æ˜¯é€šè¿‡watcherçš„teardownæ–¹æ³•éå†å½“å‰watcherçš„æ‰€æœ‰depæ‰§è¡Œç§»é™¤å½“å‰watcherï¼Œè¿™æ ·dataæ›´æ–°æ—¶å°±ä¸ä¼šå†è¢«é€šçŸ¥æ›´æ–°äº†ï¼š</p><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#FFCB6B;">Vue</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">prototype</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">$watch</span><span style="color:#89DDFF;"> =</span><span style="color:#C792EA;"> function</span><span style="color:#89DDFF;"> (</span><span style="color:#BABED8;font-style:italic;">expOrFn</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> string</span><span style="color:#89DDFF;"> |</span><span style="color:#FFCB6B;"> Function</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;font-style:italic;"> cb</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> any</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;font-style:italic;"> options</span><span style="color:#89DDFF;">?:</span><span style="color:#FFCB6B;"> Object</span><span style="color:#89DDFF;">):</span><span style="color:#FFCB6B;"> Function</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  // çœç•¥...</span></span>
<span class="line"><span style="color:#C792EA;">  const</span><span style="color:#BABED8;"> watcher</span><span style="color:#89DDFF;"> =</span><span style="color:#89DDFF;"> new</span><span style="color:#82AAFF;"> Watcher</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">vm</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> expOrFn</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> cb</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> options</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  // çœç•¥...</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  // $watch å‡½æ•°ä¼šè¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œæ‰§è¡Œå®ƒ ä¼šæ‰§è¡Œ watcher.teardown</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">  return</span><span style="color:#C792EA;"> function</span><span style="color:#82AAFF;"> unwatchFn</span><span style="color:#89DDFF;">()</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#BABED8;">    watcher</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">teardown</span><span style="color:#F07178;">()</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">  };</span></span>
<span class="line"><span style="color:#89DDFF;">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// æ¥çœ‹ä¸‹teardownçš„å®ç°</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#89DDFF;font-style:italic;"> default</span><span style="color:#C792EA;"> class</span><span style="color:#FFCB6B;"> Watcher</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  // éå†å½“å‰user watcheræ‰€æœ‰è¢«æ”¶é›†çš„depï¼Œæ‰§è¡ŒremoveSubè¿™æ ·å°±ä¼šè®©depç§»é™¤å¯¹user watcherçš„æ”¶é›†</span></span>
<span class="line"><span style="color:#F07178;">  teardown</span><span style="color:#89DDFF;">()</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">    if</span><span style="color:#F07178;"> (</span><span style="color:#89DDFF;">this.</span><span style="color:#BABED8;">active</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#C792EA;">      let</span><span style="color:#BABED8;"> i</span><span style="color:#89DDFF;"> =</span><span style="color:#89DDFF;"> this.</span><span style="color:#BABED8;">deps</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">length</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">      while</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">i</span><span style="color:#89DDFF;">--</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">        this.</span><span style="color:#BABED8;">deps</span><span style="color:#F07178;">[</span><span style="color:#BABED8;">i</span><span style="color:#F07178;">]</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">removeSub</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">this</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">      }</span></span>
<span class="line"><span style="color:#89DDFF;">      this.</span><span style="color:#BABED8;">active</span><span style="color:#89DDFF;"> =</span><span style="color:#FF9CAC;"> false</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">    }</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h3 id="deep" tabindex="-1">deep <a class="header-anchor" href="#deep" aria-label="Permalink to &quot;deep&quot;">â€‹</a></h3><p>deepé€‰é¡¹ä¸»è¦ç”¨æ¥æ·±å±‚ç›‘å¬æŸä¸ªå±æ€§ï¼Œæ¯”å¦‚ä¸‹é¢æ·±å±‚ç›‘å¬fooï¼Œé‚£ä¹ˆå½“fooæˆ–è€…baræ”¹å˜æ—¶éƒ½ä¼šè§¦å‘user watcherçš„å›è°ƒå‡½æ•°æ‰§è¡Œï¼š</p><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#C792EA;">const</span><span style="color:#BABED8;"> data </span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#F07178;">  foo</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#F07178;">    bar</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;"> 1</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">this.</span><span style="color:#82AAFF;">$watch</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">foo</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> cb</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;"> {</span><span style="color:#F07178;"> deep</span><span style="color:#89DDFF;">:</span><span style="color:#FF9CAC;"> true</span><span style="color:#89DDFF;"> }</span><span style="color:#BABED8;">)</span><span style="color:#89DDFF;">;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>é‚£ä¹ˆå†…éƒ¨æ˜¯å¦‚ä½•å®ç°deepçš„å‘¢ï¼Ÿå…¶å®é“ç†å¾ˆç®€å•<u>åªè¦è®©æ·±å±‚åµŒå¥—çš„å±æ€§çš„depä¹Ÿéƒ½æ”¶é›†å½“å‰çš„user watcherï¼Œé‚£ä¹ˆæ·±å±‚åµŒå¥—çš„å±æ€§å€¼æ”¹å˜æ—¶ä¹Ÿä¼šé€šçŸ¥user watcherè¿›è¡Œæ›´æ–°</u>ã€‚ä¸»è¦å°±æ˜¯é€šè¿‡<code>traverse</code>æ–¹æ³•æ·±åº¦éå†åµŒå¥—å¯¹è±¡è®¿é—®å¯¹åº”çš„keyå°±ä¼šè§¦å‘depæ”¶é›†å½“å‰watcherï¼Œè¿™æ ·æ·±å±‚åµŒå¥—çš„å±æ€§å€¼æ”¹å˜æ—¶ä¹Ÿä¼šé€šçŸ¥watcherè¿›è¡Œæ›´æ–°ï¼š</p><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#89DDFF;font-style:italic;"> default</span><span style="color:#C792EA;"> class</span><span style="color:#FFCB6B;"> Watcher</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	// çœç•¥</span></span>
<span class="line"><span style="color:#F07178;">  get</span><span style="color:#89DDFF;">()</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#82AAFF;">    pushTarget</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">this</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#C792EA;">    let</span><span style="color:#BABED8;"> value</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#C792EA;">    const</span><span style="color:#BABED8;"> vm</span><span style="color:#89DDFF;"> =</span><span style="color:#89DDFF;"> this.</span><span style="color:#BABED8;">vm</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">    try</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#BABED8;">      value</span><span style="color:#89DDFF;"> =</span><span style="color:#89DDFF;"> this.</span><span style="color:#BABED8;">getter</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">call</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">vm</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> vm</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">    }</span><span style="color:#89DDFF;font-style:italic;"> catch</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">e</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">      if</span><span style="color:#F07178;"> (</span><span style="color:#89DDFF;">this.</span><span style="color:#BABED8;">user</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#82AAFF;">        handleError</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">e</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> vm</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;"> \`</span><span style="color:#C3E88D;">getter for watcher &quot;</span><span style="color:#89DDFF;">\${</span><span style="color:#89DDFF;">this.</span><span style="color:#BABED8;">expression</span><span style="color:#89DDFF;">}</span><span style="color:#C3E88D;">&quot;</span><span style="color:#89DDFF;">\`</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">      }</span></span>
<span class="line"><span style="color:#89DDFF;">    }</span><span style="color:#89DDFF;font-style:italic;"> finally</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    	// å½“æ‰§è¡Œå½“å‰getæ–¹æ³•è·å–åˆ°å“åº”å¼å¯¹åº”çš„valueæ—¶ï¼Œå¦‚æœç”¨æˆ·è®¾ç½®äº†deep</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    	// é‚£ä¹ˆå°±å¯¹å½“å‰å€¼æ‰§è¡Œ traverse æ–¹æ³•ï¼Œå†…éƒ¨ä¼šå¾ªç¯éå†keyï¼Œè§¦å‘å®ƒä»¬çš„get</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">      if</span><span style="color:#F07178;"> (</span><span style="color:#89DDFF;">this.</span><span style="color:#BABED8;">deep</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line highlighted"><span style="color:#82AAFF;">        traverse</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">value</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">      }</span></span>
<span class="line"><span style="color:#89DDFF;">    }</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">    return</span><span style="color:#BABED8;"> value</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// src/core/observer/traverse </span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#C792EA;"> function</span><span style="color:#82AAFF;"> traverse</span><span style="color:#89DDFF;"> (</span><span style="color:#BABED8;font-style:italic;">val</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> any</span><span style="color:#89DDFF;">)</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#82AAFF;">  _traverse</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">val</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> seenObjects</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#BABED8;">  seenObjects</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">clear</span><span style="color:#F07178;">()</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">function</span><span style="color:#82AAFF;"> _traverse</span><span style="color:#89DDFF;"> (</span><span style="color:#BABED8;font-style:italic;">val</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> any</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;font-style:italic;"> seen</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> SimpleSet</span><span style="color:#89DDFF;">)</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#C792EA;">  let</span><span style="color:#BABED8;"> i</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> keys</span></span>
<span class="line"><span style="color:#C792EA;">  const</span><span style="color:#BABED8;"> isA</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> Array</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">isArray</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">val</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  // ä¸åˆæ³•çš„å€¼ç›´æ¥return</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">  if</span><span style="color:#F07178;"> ((</span><span style="color:#89DDFF;">!</span><span style="color:#BABED8;">isA</span><span style="color:#89DDFF;"> &amp;&amp;</span><span style="color:#89DDFF;"> !</span><span style="color:#82AAFF;">isObject</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">val</span><span style="color:#F07178;">)) </span><span style="color:#89DDFF;">||</span><span style="color:#BABED8;"> Object</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">isFrozen</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">val</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">||</span><span style="color:#BABED8;"> val</span><span style="color:#89DDFF;"> instanceof</span><span style="color:#FFCB6B;"> VNode</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">    return</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">  if</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">val</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">__ob__</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#C792EA;">    const</span><span style="color:#BABED8;"> depId</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> val</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">__ob__</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">dep</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">id</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">    if</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">seen</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">has</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">depId</span><span style="color:#F07178;">)) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">      return</span></span>
<span class="line"><span style="color:#89DDFF;">    }</span></span>
<span class="line"><span style="color:#BABED8;">    seen</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">add</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">depId</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  // å€¼æ˜¯æ•°ç»„æˆ–è€…å¯¹è±¡æ—¶ï¼Œæ·±å±‚éå†å°±ä¼šè§¦å‘æ¯ä¸ªkeyçš„get</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  // ç„¶åè§¦å‘æ¯ä¸ªkeyçš„depæ‰§è¡Œdependï¼Œè¿™æ ·æ·±å±‚åµŒå¥—çš„keyå°±ä¼šæ”¶é›†å½“å‰çš„user watcher</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">  if</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">isA</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">    i</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> val</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">length</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">    while</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">i</span><span style="color:#89DDFF;">--</span><span style="color:#F07178;">) </span><span style="color:#82AAFF;">_traverse</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">val</span><span style="color:#F07178;">[</span><span style="color:#BABED8;">i</span><span style="color:#F07178;">]</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> seen</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span><span style="color:#89DDFF;font-style:italic;"> else</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#BABED8;">    keys</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> Object</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">keys</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">val</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#BABED8;">    i</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> keys</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">length</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">    while</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">i</span><span style="color:#89DDFF;">--</span><span style="color:#F07178;">) </span><span style="color:#82AAFF;">_traverse</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">val</span><span style="color:#F07178;">[</span><span style="color:#BABED8;">keys</span><span style="color:#F07178;">[</span><span style="color:#BABED8;">i</span><span style="color:#F07178;">]]</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> seen</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br></div></div><h3 id="sync" tabindex="-1">sync <a class="header-anchor" href="#sync" aria-label="Permalink to &quot;sync&quot;">â€‹</a></h3><p>è¿™ä¸ªå±æ€§é¡¾åæ€ä¹‰åŒæ­¥æ‰§è¡Œï¼Œé€šå¸¸æƒ…å†µä¸‹user watcherä¼šè¢«pushåˆ°å¼‚æ­¥æ›´æ–°é˜Ÿåˆ—ä¸­å»ï¼Œç„¶åæŒ‰é¡ºåºè¿›è¡Œæ›´æ–°ã€‚å½“è®¾ç½®äº†è¿™ä¸ªå±æ€§åï¼Œæ¯æ¬¡ç›‘å¬å¯¹è±¡å€¼çš„æ›´æ–°ï¼Œéƒ½ä¼šç«‹å³æ‰§è¡Œuser watcherçš„cbï¼Œè€Œä¸ä¼šè¢«æ¨åˆ°å¼‚æ­¥æ›´æ–°é˜Ÿåˆ—ä¸­å»ï¼Œæ‰§è¡Œä¹Ÿå°±ä¼šè¢«æå‰</p><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#89DDFF;font-style:italic;"> default</span><span style="color:#C792EA;"> class</span><span style="color:#FFCB6B;"> Watcher</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	// çœç•¥...</span></span>
<span class="line"><span style="color:#F07178;">  update</span><span style="color:#89DDFF;">()</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">    if</span><span style="color:#F07178;"> (</span><span style="color:#89DDFF;">this.</span><span style="color:#BABED8;">lazy</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">      this.</span><span style="color:#BABED8;">dirty</span><span style="color:#89DDFF;"> =</span><span style="color:#FF9CAC;"> true</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">    }</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // depé€šçŸ¥æ›´æ–°æ—¶ï¼Œç”±äºsyncä½trueï¼Œä¼šç«‹å³æ‰§è¡Œrunå¾—åˆ°æœ€æ–°çš„å€¼ç„¶åæ‰§è¡Œcb</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">    else</span><span style="color:#89DDFF;font-style:italic;"> if</span><span style="color:#F07178;"> (</span><span style="color:#89DDFF;">this.</span><span style="color:#BABED8;">sync</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">      this.</span><span style="color:#82AAFF;">run</span><span style="color:#F07178;">()</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">    }</span><span style="color:#89DDFF;font-style:italic;"> else</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#82AAFF;">      queueWatcher</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">this</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">    }</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="æ³¨æ„äº‹é¡¹" tabindex="-1">æ³¨æ„äº‹é¡¹ <a class="header-anchor" href="#æ³¨æ„äº‹é¡¹" aria-label="Permalink to &quot;æ³¨æ„äº‹é¡¹&quot;">â€‹</a></h3><p>watchçš„ä¾¦å¬å‡½æ•°ä¸­ä¸èƒ½å†å¯¹æ‰€ä¾¦å¬çš„å¯¹è±¡è¿›è¡Œå€¼çš„ä¿®æ”¹ï¼Œè¿™æ ·å°±ä¼šé€ æˆæ­»å¾ªç¯ä¸æ–­æ‰§è¡Œå›è°ƒå‡½æ•°ï¼š</p><div class="language-vue line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">vue</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">template</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">  &lt;</span><span style="color:#F07178;">button</span><span style="color:#89DDFF;"> @</span><span style="color:#C792EA;">click</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#BABED8;">count</span><span style="color:#89DDFF;">++</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">&gt;</span><span style="color:#BABED8;">æ”¹å˜</span><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">button</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">template</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">script</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#89DDFF;font-style:italic;"> default</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#82AAFF;">  data</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> ()</span><span style="color:#C792EA;"> =&gt;</span><span style="color:#BABED8;"> (</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    count</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;"> 0</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span><span style="color:#BABED8;">)</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">  watch</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#F07178;">    count</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> &quot;</span><span style="color:#C3E88D;">watchCount</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#89DDFF;">  },</span></span>
<span class="line"><span style="color:#F07178;">  methods</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#F07178;">    watchCount</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">n</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;font-style:italic;"> o</span><span style="color:#89DDFF;">)</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#89DDFF;">      this.</span><span style="color:#BABED8;">count</span><span style="color:#89DDFF;"> ++;</span></span>
<span class="line"><span style="color:#BABED8;">      console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">n</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> o</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">    }</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">script</span><span style="color:#89DDFF;">&gt;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p><img src="https://ihengshuai-demo1.oss-cn-beijing.aliyuncs.com/image-20230520224222376.png" alt=""></p><h3 id="vue3çš„watch" tabindex="-1">Vue3çš„watch <a class="header-anchor" href="#vue3çš„watch" aria-label="Permalink to &quot;Vue3çš„watch&quot;">â€‹</a></h3><p>vue3ä¸­çš„watchå…¶å®å’Œvue2çš„æ²¡å•¥åŒºåˆ«ï¼Œvue3çš„é€‰é¡¹å¤šäº†ä¸€ä¸ª<code>flush: &#39;pre&#39; | &#39;post&#39; | &#39;sync&#39;</code>å‚æ•°ï¼Œå…¶ç”¨æ¥æ§åˆ¶å›è°ƒå‡½æ•°çš„æ‰§è¡Œæ—¶æœºï¼Œé»˜è®¤å€¼ä¸º<code>pre</code>ä¼šæ¨é€åˆ°<code>queueJob</code>é˜Ÿåˆ—ä¸­ï¼Œåœ¨é¡µé¢æ¸²æŸ“å‰æ‰§è¡Œï¼›å¦‚æœå€¼ä¸º<code>post</code>é‚£ä¹ˆä¼šå°†å›è°ƒæ¨é€åˆ°<code>postFlushCbs</code>ä¸­ï¼Œè¿™ä¼šåœ¨<code>queue</code>æ‰§è¡Œå®Œåå†æ‰§è¡Œ<code>postFlushCbs</code>ä¸­çš„å›è°ƒï¼Œåœ¨é¡µé¢æ¸²æŸ“åæ‰§è¡Œï¼›æœ€åä¸€ä¸ªå€¼<code>sync</code>å’Œvue2ä¸€æ ·ï¼Œå½“watchçš„å¯¹è±¡å€¼æ”¹å˜æ—¶ä¼šç«‹é©¬æ‰§è¡Œä¸éœ€è¦è¿›å…¥é˜Ÿåˆ—å¼‚æ­¥æ›´æ–°</p><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#676E95;font-style:italic;">// packages/runtime-core/src/apiWatch 158è¡Œ</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#C792EA;"> function</span><span style="color:#82AAFF;"> watch</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">T</span><span style="color:#89DDFF;"> =</span><span style="color:#FFCB6B;"> any</span><span style="color:#89DDFF;">,</span><span style="color:#FFCB6B;"> Immediate</span><span style="color:#C792EA;"> extends</span><span style="color:#FFCB6B;"> Readonly</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">boolean</span><span style="color:#89DDFF;">&gt;</span><span style="color:#89DDFF;"> =</span><span style="color:#FFCB6B;"> false</span><span style="color:#89DDFF;">&gt;(</span></span>
<span class="line"><span style="color:#BABED8;font-style:italic;">  source</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> T</span><span style="color:#89DDFF;"> |</span><span style="color:#FFCB6B;"> WatchSource</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">T</span><span style="color:#89DDFF;">&gt;,</span></span>
<span class="line"><span style="color:#BABED8;font-style:italic;">  cb</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> any</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#BABED8;font-style:italic;">  options</span><span style="color:#89DDFF;">?:</span><span style="color:#FFCB6B;"> WatchOptions</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">Immediate</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">):</span><span style="color:#FFCB6B;"> WatchStopHandle</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">  return</span><span style="color:#82AAFF;"> doWatch</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">source</span><span style="color:#89DDFF;font-style:italic;"> as</span><span style="color:#FFCB6B;"> any</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> cb</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> options</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">function</span><span style="color:#82AAFF;"> doWatch</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#BABED8;font-style:italic;">  source</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> WatchSource</span><span style="color:#89DDFF;"> |</span><span style="color:#FFCB6B;"> WatchSource</span><span style="color:#BABED8;">[] </span><span style="color:#89DDFF;">|</span><span style="color:#FFCB6B;"> WatchEffect</span><span style="color:#89DDFF;"> |</span><span style="color:#FFCB6B;"> object</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#BABED8;font-style:italic;">  cb</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> WatchCallback</span><span style="color:#89DDFF;"> |</span><span style="color:#FFCB6B;"> null</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">  {</span><span style="color:#BABED8;font-style:italic;"> immediate</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;font-style:italic;"> deep</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;font-style:italic;"> flush</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;font-style:italic;"> onTrack</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;font-style:italic;"> onTrigger</span><span style="color:#89DDFF;"> }:</span><span style="color:#FFCB6B;"> WatchOptions</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> EMPTY_OBJ</span></span>
<span class="line"><span style="color:#89DDFF;">):</span><span style="color:#FFCB6B;"> WatchStopHandle</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#C792EA;">  const</span><span style="color:#BABED8;"> instance</span><span style="color:#89DDFF;"> =</span></span>
<span class="line"><span style="color:#82AAFF;">    getCurrentScope</span><span style="color:#F07178;">() </span><span style="color:#89DDFF;">===</span><span style="color:#BABED8;"> currentInstance</span><span style="color:#89DDFF;">?.</span><span style="color:#BABED8;">scope</span><span style="color:#89DDFF;"> ?</span><span style="color:#BABED8;"> currentInstance</span><span style="color:#89DDFF;"> :</span><span style="color:#89DDFF;"> null</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  // const instance = currentInstance</span></span>
<span class="line"><span style="color:#C792EA;">  let</span><span style="color:#BABED8;"> getter</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> ()</span><span style="color:#C792EA;"> =&gt;</span><span style="color:#FFCB6B;"> any</span></span>
<span class="line"><span style="color:#C792EA;">  let</span><span style="color:#BABED8;"> forceTrigger</span><span style="color:#89DDFF;"> =</span><span style="color:#FF9CAC;"> false</span></span>
<span class="line"><span style="color:#C792EA;">  let</span><span style="color:#BABED8;"> isMultiSource</span><span style="color:#89DDFF;"> =</span><span style="color:#FF9CAC;"> false</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  // çœç•¥ä»£ç ...</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  // 1. å…ˆå¯¹watchå¯¹è±¡çš„å€¼è¿›è¡Œè§„èŒƒåŒ–ï¼Œå€¼å¯èƒ½æ˜¯ å¯¹è±¡ã€æ•°ç»„ã€å‡½æ•°ç­‰ç­‰</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  // deepæ—¶æ·±åº¦éå†</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">  if</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">cb</span><span style="color:#89DDFF;"> &amp;&amp;</span><span style="color:#BABED8;"> deep</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#C792EA;">    const</span><span style="color:#BABED8;"> baseGetter</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> getter</span></span>
<span class="line"><span style="color:#82AAFF;">    getter</span><span style="color:#89DDFF;"> =</span><span style="color:#89DDFF;"> ()</span><span style="color:#C792EA;"> =&gt;</span><span style="color:#82AAFF;"> traverse</span><span style="color:#F07178;">(</span><span style="color:#82AAFF;">baseGetter</span><span style="color:#F07178;">())</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">  let</span><span style="color:#BABED8;"> cleanup</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> ()</span><span style="color:#C792EA;"> =&gt;</span><span style="color:#FFCB6B;"> void</span></span>
<span class="line"><span style="color:#C792EA;">  let</span><span style="color:#BABED8;"> onCleanup</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> OnCleanup</span><span style="color:#89DDFF;"> =</span><span style="color:#89DDFF;"> (</span><span style="color:#82AAFF;">fn</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> ()</span><span style="color:#C792EA;"> =&gt;</span><span style="color:#FFCB6B;"> void</span><span style="color:#89DDFF;">)</span><span style="color:#C792EA;"> =&gt;</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#BABED8;">    cleanup</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> effect</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">onStop</span><span style="color:#89DDFF;"> =</span><span style="color:#89DDFF;"> ()</span><span style="color:#C792EA;"> =&gt;</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#82AAFF;">      callWithErrorHandling</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">fn</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> instance</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> ErrorCodes</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">WATCH_CLEANUP</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">    }</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">  let</span><span style="color:#BABED8;"> oldValue</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> any</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> isMultiSource</span></span>
<span class="line"><span style="color:#89DDFF;">    ?</span><span style="color:#89DDFF;"> new</span><span style="color:#82AAFF;"> Array</span><span style="color:#F07178;">((</span><span style="color:#BABED8;">source</span><span style="color:#89DDFF;font-style:italic;"> as</span><span style="color:#F07178;"> [])</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">length</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">fill</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">INITIAL_WATCHER_VALUE</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">    :</span><span style="color:#BABED8;"> INITIAL_WATCHER_VALUE</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  // å¯¹å›è°ƒåšä¸€æ¬¡åŒ…è£…</span></span>
<span class="line"><span style="color:#C792EA;">  const</span><span style="color:#BABED8;"> job</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> SchedulerJob</span><span style="color:#89DDFF;"> =</span><span style="color:#89DDFF;"> ()</span><span style="color:#C792EA;"> =&gt;</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">    if</span><span style="color:#F07178;"> (</span><span style="color:#89DDFF;">!</span><span style="color:#BABED8;">effect</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">active</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">      return</span></span>
<span class="line"><span style="color:#89DDFF;">    }</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">    if</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">cb</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">      // çœç•¥...</span></span>
<span class="line"><span style="color:#89DDFF;">    }</span><span style="color:#89DDFF;font-style:italic;"> else</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">      // watchEffect</span></span>
<span class="line"><span style="color:#BABED8;">      effect</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">run</span><span style="color:#F07178;">()</span></span>
<span class="line"><span style="color:#89DDFF;">    }</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  // å¤„ç†flush å‚æ•°ï¼Œç”¨æ¥åŒºåˆ«ä¸åŒçš„æ‰§è¡Œæ—¶æœº</span></span>
<span class="line"><span style="color:#C792EA;">  let</span><span style="color:#BABED8;"> scheduler</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> EffectScheduler</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">  if</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">flush</span><span style="color:#89DDFF;"> ===</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">sync</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">    scheduler</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> job</span><span style="color:#89DDFF;font-style:italic;"> as</span><span style="color:#FFCB6B;"> any</span><span style="color:#676E95;font-style:italic;"> // the scheduler function gets called directly</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span><span style="color:#89DDFF;font-style:italic;"> else</span><span style="color:#89DDFF;font-style:italic;"> if</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">flush</span><span style="color:#89DDFF;"> ===</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">post</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#82AAFF;">    scheduler</span><span style="color:#89DDFF;"> =</span><span style="color:#89DDFF;"> ()</span><span style="color:#C792EA;"> =&gt;</span><span style="color:#82AAFF;"> queuePostRenderEffect</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">job</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> instance</span><span style="color:#89DDFF;"> &amp;&amp;</span><span style="color:#BABED8;"> instance</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">suspense</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span><span style="color:#89DDFF;font-style:italic;"> else</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#BABED8;">    job</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">pre</span><span style="color:#89DDFF;"> =</span><span style="color:#FF9CAC;"> true</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">    if</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">instance</span><span style="color:#F07178;">) </span><span style="color:#BABED8;">job</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">id</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> instance</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">uid</span></span>
<span class="line"><span style="color:#82AAFF;">    scheduler</span><span style="color:#89DDFF;"> =</span><span style="color:#89DDFF;"> ()</span><span style="color:#C792EA;"> =&gt;</span><span style="color:#82AAFF;"> queueJob</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">job</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  // åˆ›å»º ReactiveEffect</span></span>
<span class="line"><span style="color:#C792EA;">  const</span><span style="color:#BABED8;"> effect</span><span style="color:#89DDFF;"> =</span><span style="color:#89DDFF;"> new</span><span style="color:#82AAFF;"> ReactiveEffect</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">getter</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> scheduler</span><span style="color:#F07178;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">  if</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">cb</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // å¤„ç† immediate æƒ…å†µï¼Œç«‹å³æ‰§è¡Œä¸€æ¬¡</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">    if</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">immediate</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#82AAFF;">      job</span><span style="color:#F07178;">()</span></span>
<span class="line"><span style="color:#89DDFF;">    }</span><span style="color:#89DDFF;font-style:italic;"> else</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">      // å¦åˆ™è®¡ç®—ä¸€æ¬¡æ—§çš„å€¼</span></span>
<span class="line"><span style="color:#BABED8;">      oldValue</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> effect</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">run</span><span style="color:#F07178;">()</span></span>
<span class="line"><span style="color:#89DDFF;">    }</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span><span style="color:#89DDFF;font-style:italic;"> else</span><span style="color:#89DDFF;font-style:italic;"> if</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">flush</span><span style="color:#89DDFF;"> ===</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">post</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#82AAFF;">    queuePostRenderEffect</span><span style="color:#F07178;">(</span></span>
<span class="line"><span style="color:#BABED8;">      effect</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">run</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">bind</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">effect</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#BABED8;">      instance</span><span style="color:#89DDFF;"> &amp;&amp;</span><span style="color:#BABED8;"> instance</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">suspense</span></span>
<span class="line"><span style="color:#F07178;">    )</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span><span style="color:#89DDFF;font-style:italic;"> else</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#BABED8;">    effect</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">run</span><span style="color:#F07178;">()</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  // å¸è½½äº‹ä»¶</span></span>
<span class="line"><span style="color:#C792EA;">  const</span><span style="color:#BABED8;"> unwatch</span><span style="color:#89DDFF;"> =</span><span style="color:#89DDFF;"> ()</span><span style="color:#C792EA;"> =&gt;</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#BABED8;">    effect</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">stop</span><span style="color:#F07178;">()</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">    if</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">instance</span><span style="color:#89DDFF;"> &amp;&amp;</span><span style="color:#BABED8;"> instance</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">scope</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#82AAFF;">      remove</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">instance</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">scope</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">effects</span><span style="color:#89DDFF;">!,</span><span style="color:#BABED8;"> effect</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">    }</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">  return</span><span style="color:#BABED8;"> unwatch</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br></div></div><h3 id="watcheffect" tabindex="-1">watchEffect <a class="header-anchor" href="#watcheffect" aria-label="Permalink to &quot;watchEffect&quot;">â€‹</a></h3><p>watchEffectæœ¬è´¨è¿˜æ˜¯watchï¼Œåªä¸è¿‡å‚æ•°è°ƒæ¢äº†ä½ç½®è€Œå·²ï¼Œè¿™é‡Œæ›´åƒReactçš„useEffectï¼Œå†…éƒ¨çš„å›è°ƒä¼šä¸»åŠ¨æ‰§è¡Œï¼Œå¹¶ä¸”å½“å†…éƒ¨çš„ä¾èµ–å‘ç”Ÿæ”¹å˜æ—¶ï¼Œå†æ¬¡è§¦å‘å›è°ƒæ‰§è¡Œï¼š</p><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#82AAFF;">watchEffect</span><span style="color:#BABED8;">(effect: </span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">onCleanup</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> OnCleanup</span><span style="color:#89DDFF;">)</span><span style="color:#C792EA;"> =&gt;</span><span style="color:#89DDFF;"> void,</span><span style="color:#BABED8;"> options</span><span style="color:#89DDFF;">?:</span><span style="color:#89DDFF;"> {</span><span style="color:#BABED8;"> flush?</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">pre</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;"> |</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">post</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;"> |</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">sync</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;"> }</span><span style="color:#BABED8;">)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>watchEffectåŸç†å¾ˆç®€å•å†…éƒ¨ä¸»åŠ¨ä¼šæ‰§è¡Œä¸€æ¬¡å›è°ƒå‡½æ•°ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸­å°±ä¼šè®¿é—®åˆ°å¯¹åº”çš„å“åº”å¼å¯¹è±¡ï¼Œç„¶åè§¦å‘å¯¹å½“å‰å›è°ƒå‡½æ•°çš„æ”¶é›†ï¼ŒåŒç†dataæ›´æ–°æ—¶ä¹Ÿä¼šé€šçŸ¥å›è°ƒå†æ¬¡æ‰§è¡Œã€‚å›è°ƒå‡½æ•°åœ¨å†…éƒ¨ä¼šè¢«å°è£…ä¸€æ¬¡ï¼Œå°†<code>onCleanup</code>ä½œä¸ºå‚æ•°ä¼ å…¥ï¼š</p><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#C792EA;"> function</span><span style="color:#82AAFF;"> watchEffect</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#BABED8;font-style:italic;">  effect</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> WatchEffect</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#BABED8;font-style:italic;">  options</span><span style="color:#89DDFF;">?:</span><span style="color:#FFCB6B;"> WatchOptionsBase</span></span>
<span class="line"><span style="color:#89DDFF;">):</span><span style="color:#FFCB6B;"> WatchStopHandle</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">  return</span><span style="color:#82AAFF;"> doWatch</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">effect</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;"> null,</span><span style="color:#BABED8;"> options</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">function</span><span style="color:#82AAFF;"> doWatch</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#BABED8;font-style:italic;">  source</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> WatchSource</span><span style="color:#89DDFF;"> |</span><span style="color:#FFCB6B;"> WatchSource</span><span style="color:#BABED8;">[] </span><span style="color:#89DDFF;">|</span><span style="color:#FFCB6B;"> WatchEffect</span><span style="color:#89DDFF;"> |</span><span style="color:#FFCB6B;"> object</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#BABED8;font-style:italic;">  cb</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> WatchCallback</span><span style="color:#89DDFF;"> |</span><span style="color:#FFCB6B;"> null</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">  {</span><span style="color:#BABED8;font-style:italic;"> immediate</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;font-style:italic;"> deep</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;font-style:italic;"> flush</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;font-style:italic;"> onTrack</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;font-style:italic;"> onTrigger</span><span style="color:#89DDFF;"> }:</span><span style="color:#FFCB6B;"> WatchOptions</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> EMPTY_OBJ</span></span>
<span class="line"><span style="color:#89DDFF;">):</span><span style="color:#FFCB6B;"> WatchStopHandle</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  // source ä¸ºfunction</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">  if</span><span style="color:#F07178;"> (</span><span style="color:#82AAFF;">isFunction</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">source</span><span style="color:#F07178;">)) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // æ²¡æœ‰cbï¼Œä¸ä¼šèµ°è¿™é‡Œ</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">    if</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">cb</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">      // getter with cb</span></span>
<span class="line"><span style="color:#82AAFF;">      getter</span><span style="color:#89DDFF;"> =</span><span style="color:#89DDFF;"> ()</span><span style="color:#C792EA;"> =&gt;</span></span>
<span class="line"><span style="color:#82AAFF;">        callWithErrorHandling</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">source</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> instance</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> ErrorCodes</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">WATCH_GETTER</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">    }</span><span style="color:#89DDFF;font-style:italic;"> else</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">      // watchEffect å›è°ƒä¼šè¢«å°è£…ä¸€æ¬¡</span></span>
<span class="line"><span style="color:#82AAFF;">      getter</span><span style="color:#89DDFF;"> =</span><span style="color:#89DDFF;"> ()</span><span style="color:#C792EA;"> =&gt;</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">        if</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">instance</span><span style="color:#89DDFF;"> &amp;&amp;</span><span style="color:#BABED8;"> instance</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">isUnmounted</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">          return</span></span>
<span class="line"><span style="color:#89DDFF;">        }</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">        if</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">cleanup</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#82AAFF;">          cleanup</span><span style="color:#F07178;">()</span></span>
<span class="line"><span style="color:#89DDFF;">        }</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">        // è¿™é‡Œå°±ä¼šæŠŠ onCleanup ä½œä¸ºå‚æ•°ä¼ å…¥</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">        return</span><span style="color:#82AAFF;"> callWithAsyncErrorHandling</span><span style="color:#F07178;">(</span></span>
<span class="line"><span style="color:#BABED8;">          source</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#BABED8;">          instance</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#BABED8;">          ErrorCodes</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">WATCH_CALLBACK</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">          [</span><span style="color:#BABED8;">onCleanup</span><span style="color:#F07178;">]</span></span>
<span class="line"><span style="color:#F07178;">        )</span></span>
<span class="line"><span style="color:#89DDFF;">      }</span></span>
<span class="line"><span style="color:#89DDFF;">    }</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  // æ¸…é™¤å‰¯ä½œç”¨</span></span>
<span class="line"><span style="color:#C792EA;">  let</span><span style="color:#BABED8;"> cleanup</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> ()</span><span style="color:#C792EA;"> =&gt;</span><span style="color:#FFCB6B;"> void</span></span>
<span class="line"><span style="color:#C792EA;">  let</span><span style="color:#BABED8;"> onCleanup</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> OnCleanup</span><span style="color:#89DDFF;"> =</span><span style="color:#89DDFF;"> (</span><span style="color:#82AAFF;">fn</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> ()</span><span style="color:#C792EA;"> =&gt;</span><span style="color:#FFCB6B;"> void</span><span style="color:#89DDFF;">)</span><span style="color:#C792EA;"> =&gt;</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#BABED8;">    cleanup</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> effect</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">onStop</span><span style="color:#89DDFF;"> =</span><span style="color:#89DDFF;"> ()</span><span style="color:#C792EA;"> =&gt;</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#82AAFF;">      callWithErrorHandling</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">fn</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> instance</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> ErrorCodes</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">WATCH_CLEANUP</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">    }</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span></span>
<span class="line"><span style="color:#C792EA;">  const</span><span style="color:#BABED8;"> job</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> SchedulerJob</span><span style="color:#89DDFF;"> =</span><span style="color:#89DDFF;"> ()</span><span style="color:#C792EA;"> =&gt;</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">    if</span><span style="color:#F07178;"> (</span><span style="color:#89DDFF;">!</span><span style="color:#BABED8;">effect</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">active</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;font-style:italic;">return</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">    if</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">cb</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span><span style="color:#676E95;font-style:italic;"> /* çœç•¥... */</span><span style="color:#89DDFF;"> }</span><span style="color:#89DDFF;font-style:italic;"> else</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">      // watchEffect</span></span>
<span class="line"><span style="color:#BABED8;">      effect</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">run</span><span style="color:#F07178;">()</span></span>
<span class="line"><span style="color:#89DDFF;">    }</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">  const</span><span style="color:#BABED8;"> effect</span><span style="color:#89DDFF;"> =</span><span style="color:#89DDFF;"> new</span><span style="color:#82AAFF;"> ReactiveEffect</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">getter</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> scheduler</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  // initial run</span></span>
<span class="line"><span style="color:#BABED8;">  effect</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">run</span><span style="color:#F07178;">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">  const</span><span style="color:#BABED8;"> unwatch</span><span style="color:#89DDFF;"> =</span><span style="color:#89DDFF;"> ()</span><span style="color:#C792EA;"> =&gt;</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#BABED8;">    effect</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">stop</span><span style="color:#F07178;">()</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">    if</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">instance</span><span style="color:#89DDFF;"> &amp;&amp;</span><span style="color:#BABED8;"> instance</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">scope</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#82AAFF;">      remove</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">instance</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">scope</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">effects</span><span style="color:#89DDFF;">!,</span><span style="color:#BABED8;"> effect</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">    }</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">  return</span><span style="color:#BABED8;"> unwatch</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br></div></div><p>watchEffectè¿˜æ˜¯å¾ˆå¥½ç†è§£çš„ï¼Œå‰©ä¸‹çš„è¿˜æœ‰<code>watchPostEffect</code>ã€<code>watchSyncEffect</code>éƒ½å’Œè¿™ä¸ªä¸€æ ·ï¼Œè‡ªå·±çœ‹çœ‹å°±è¡Œäº†</p><h2 id="æ€»ç»“" tabindex="-1">æ€»ç»“ <a class="header-anchor" href="#æ€»ç»“" aria-label="Permalink to &quot;æ€»ç»“&quot;">â€‹</a></h2><p>åˆ°è¿™é‡Œå°±æŠŠvueçš„å“åº”å¼åŸç†å…¨éƒ¨è®²è§£å®Œäº†ï¼Œå…¶ä¸­åŒ…æ‹¬vue3çš„ã€‚å“åº”å¼éµå¾ªå‘å¸ƒ/è®¢é˜…æ¨¡å¼ï¼Œé€šè¿‡æ‹¦æˆªå¯¹è±¡çš„getter/setterå®ç°å¯¹å½“å‰çš„effectè¿›è¡Œæ”¶é›†å’Œé€šçŸ¥ï¼Œè¿™æ ·å°±å¯ä»¥ç²¾ç¡®çš„è¿›è¡Œæ›´æ–°ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆvueçš„æ›´æ–°ç²’åº¦å¯ä»¥åšåˆ°ç»„ä»¶çš„åŸå› ã€‚å¦‚æœä½ å¯¹å®ƒçš„å“åº”å¼è¿˜æ˜¯æ¯”è¾ƒæ¨¡ç³Šï¼Œå»ºè®®ä½ ç»“åˆè¿™ä¸¤ç¯‡å“åº”å¼åŸç†æ–‡ç« å°è¯•å†™å‡ ä¸ªä¾‹å­å¹¶è¿›è¡Œæ–­ç‚¹è°ƒè¯•ï¼Œå¯ä»¥å¸®åŠ©ä½ è§£å†³è‡ªå·±çš„ç–‘æƒ‘ï¼Œä½ ä¹Ÿå¯ä»¥åœ¨ä¸‹æ–¹ç•™è¨€æˆ‘ä¼šåŠæ—¶å›å¤ã€‚æ¥ä¸‹æ¥ä¸€èµ·æ¥çœ‹çœ‹<a href="/frontend/vue/template-compiler.html">vueçš„æ¨¡æ¿ç¼–è¯‘</a>è¿‡ç¨‹å§</p>`,119);function F(D,y,i,b,u,B){const a=n("Reward"),l=n("Gitalk");return t(),e("div",null,[r,s(a),s(l)])}const E=p(c,[["render",F]]);export{A as __pageData,E as default};
