import{_ as p,c as e,J as s,V as o,o as c,G as n}from"./chunks/framework.SV1ROkXV.js";const A=JSON.parse('{"title":"谈谈Vue内部的运行机制","description":"Vue核心流程原理解密，一起来窥探vue的内部运行机制","frontmatter":{"title":"谈谈Vue内部的运行机制","description":"Vue核心流程原理解密，一起来窥探vue的内部运行机制","keywords":"Vue源码,vue core,vue核心原理,vue运行机制流程,vue双向绑定原理,模板编译","logo":"https://ihengshuai-demo1.oss-cn-beijing.aliyuncs.com/icon-vue.png"},"headers":[],"relativePath":"article/2021/vue-core-process.md","filePath":"article/2021/vue-core-process.md","lastUpdated":1709440279000}'),r={name:"article/2021/vue-core-process.md"},t=o(`<h1 id="谈谈vue内部的运行机制" tabindex="-1">谈谈Vue内部的运行机制 <a class="header-anchor" href="#谈谈vue内部的运行机制" aria-label="Permalink to &quot;谈谈Vue内部的运行机制&quot;">​</a></h1><h2 id="前言" tabindex="-1">前言 <a class="header-anchor" href="#前言" aria-label="Permalink to &quot;前言&quot;">​</a></h2><p>在使用vue开发时，都是从new Vue() 开始构建的，将state（data、props、methods...）、template、render等做为参数选项传入，vue内部就自动处理最后生成HTML呈现在页面上，那内部到底是怎么个流程呢？</p><p>在网上看到的文章大多都是直接讲双向绑定原理等一些内部实现机制，很少从构建开始讲起，这会对Vue的构建有一些疑惑，带着这份疑惑，接下来就开始进行分析吧</p><h2 id="从构建开始" tabindex="-1">从构建开始 <a class="header-anchor" href="#从构建开始" aria-label="Permalink to &quot;从构建开始&quot;">​</a></h2><p>首先我们得找到Vue的入口，<code>new Vue</code>Vue是在哪里定义的，因为Vue是基于<a href="https://rollupjs.org/guide/zh/" target="_blank" rel="noreferrer"><code>Rollup</code></a>（一个 JavaScript 模块打包器常用于构建库）进行构建的，可以在源码项目中<code>build.js</code>中看到rollup的相关配置，我们在<code>package.json</code>中看到有很多脚本用于vue的构建，</p><p><img src="https://ihengshuai-demo1.oss-cn-beijing.aliyuncs.com/005HV6Avgy1gxc2l0lqp1j31cm0s9twt.jpg" alt=""></p><p>从脚本中可以看出，运行不同脚本用来构建不同版本的文件，我们直接看<code>build</code>，实际运行<code>node scripts/build.js</code>，也就是说打包运行的就是这个文件，接下来看看build.js里面都是些什么内容。</p><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#676E95;font-style:italic;">// scripts/build.js</span></span>
<span class="line"><span style="color:#C792EA;">let</span><span style="color:#BABED8;"> builds </span><span style="color:#89DDFF;">=</span><span style="color:#82AAFF;"> require</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">./config</span><span style="color:#89DDFF;">&#39;</span><span style="color:#BABED8;">)</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getAllBuilds</span><span style="color:#BABED8;">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// ...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#82AAFF;">build</span><span style="color:#BABED8;">(builds)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">function</span><span style="color:#82AAFF;"> build</span><span style="color:#89DDFF;"> (</span><span style="color:#BABED8;font-style:italic;">builds</span><span style="color:#89DDFF;">)</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#C792EA;">  let</span><span style="color:#BABED8;"> built</span><span style="color:#89DDFF;"> =</span><span style="color:#F78C6C;"> 0</span></span>
<span class="line"><span style="color:#C792EA;">  const</span><span style="color:#BABED8;"> total</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> builds</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">length</span></span>
<span class="line"><span style="color:#C792EA;">  const</span><span style="color:#BABED8;"> next</span><span style="color:#89DDFF;"> =</span><span style="color:#89DDFF;"> ()</span><span style="color:#C792EA;"> =&gt;</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#82AAFF;">    buildEntry</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">builds</span><span style="color:#F07178;">[</span><span style="color:#BABED8;">built</span><span style="color:#F07178;">])</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">then</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">()</span><span style="color:#C792EA;"> =&gt;</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#BABED8;">      built</span><span style="color:#89DDFF;">++</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">      if</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">built</span><span style="color:#89DDFF;"> &lt;</span><span style="color:#BABED8;"> total</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#82AAFF;">        next</span><span style="color:#F07178;">()</span></span>
<span class="line"><span style="color:#89DDFF;">      }</span></span>
<span class="line"><span style="color:#89DDFF;">    }</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">catch</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">logError</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#82AAFF;">  next</span><span style="color:#F07178;">()</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">function</span><span style="color:#82AAFF;"> buildEntry</span><span style="color:#89DDFF;"> (</span><span style="color:#BABED8;font-style:italic;">config</span><span style="color:#89DDFF;">)</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#C792EA;">  const</span><span style="color:#BABED8;"> output</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> config</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">output</span></span>
<span class="line"><span style="color:#C792EA;">  const</span><span style="color:#89DDFF;"> {</span><span style="color:#BABED8;"> file</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> banner</span><span style="color:#89DDFF;"> }</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> output</span></span>
<span class="line"><span style="color:#C792EA;">  const</span><span style="color:#BABED8;"> isProd</span><span style="color:#89DDFF;"> =</span><span style="color:#89DDFF;"> /(</span><span style="color:#C3E88D;">min</span><span style="color:#89DDFF;">|</span><span style="color:#C3E88D;">prod</span><span style="color:#89DDFF;">)</span><span style="color:#BABED8;">\\.</span><span style="color:#C3E88D;">js</span><span style="color:#89DDFF;font-style:italic;">$</span><span style="color:#89DDFF;">/</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">test</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">file</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">  return</span><span style="color:#BABED8;"> rollup</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">rollup</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">config</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">    .</span><span style="color:#82AAFF;">then</span><span style="color:#F07178;">(</span><span style="color:#BABED8;font-style:italic;">bundle</span><span style="color:#C792EA;"> =&gt;</span><span style="color:#BABED8;"> bundle</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">generate</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">output</span><span style="color:#F07178;">))</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // ...</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>在<code>build.js</code>中，其实就是执行了<code>build</code>方法，遍历<code>builds</code>将其作为<code>buildEntry</code>方法参数执行，在<code>buildEntry</code>函数中可以看到<code>rollup</code>字眼了，config作为了rollup的参数，进行配置构建 build方法的参数<code>builds</code>，可以猜出就是<code>rollup</code>相关的配置，他是从<code>config.js</code>中的<code>getAllBuilds</code>方法获取的，接下来看看<code>config.js</code></p><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#C792EA;">const</span><span style="color:#BABED8;"> builds </span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  // Runtime only (CommonJS). Used by bundlers e.g. Webpack &amp; Browserify</span></span>
<span class="line"><span style="color:#89DDFF;">  &#39;</span><span style="color:#F07178;">web-runtime-cjs-dev</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#F07178;">    entry</span><span style="color:#89DDFF;">:</span><span style="color:#82AAFF;"> resolve</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">web/entry-runtime.js</span><span style="color:#89DDFF;">&#39;</span><span style="color:#BABED8;">)</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    dest</span><span style="color:#89DDFF;">:</span><span style="color:#82AAFF;"> resolve</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">dist/vue.runtime.common.dev.js</span><span style="color:#89DDFF;">&#39;</span><span style="color:#BABED8;">)</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    format</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">cjs</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    env</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">development</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#BABED8;">    banner</span></span>
<span class="line"><span style="color:#89DDFF;">  },</span></span>
<span class="line"><span style="color:#89DDFF;">  &#39;</span><span style="color:#F07178;">web-runtime-cjs-prod</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#F07178;">    entry</span><span style="color:#89DDFF;">:</span><span style="color:#82AAFF;"> resolve</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">web/entry-runtime.js</span><span style="color:#89DDFF;">&#39;</span><span style="color:#BABED8;">)</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    dest</span><span style="color:#89DDFF;">:</span><span style="color:#82AAFF;"> resolve</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">dist/vue.runtime.common.prod.js</span><span style="color:#89DDFF;">&#39;</span><span style="color:#BABED8;">)</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    format</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">cjs</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    env</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">production</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#BABED8;">    banner</span></span>
<span class="line"><span style="color:#89DDFF;">  },</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  // Runtime+compiler CommonJS build (CommonJS)</span></span>
<span class="line"><span style="color:#89DDFF;">  &#39;</span><span style="color:#F07178;">web-full-cjs-dev</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#F07178;">    entry</span><span style="color:#89DDFF;">:</span><span style="color:#82AAFF;"> resolve</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">web/entry-runtime-with-compiler.js</span><span style="color:#89DDFF;">&#39;</span><span style="color:#BABED8;">)</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    dest</span><span style="color:#89DDFF;">:</span><span style="color:#82AAFF;"> resolve</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">dist/vue.common.dev.js</span><span style="color:#89DDFF;">&#39;</span><span style="color:#BABED8;">)</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    format</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">cjs</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    env</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">development</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    alias</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> {</span><span style="color:#F07178;"> he</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">./entity-decoder</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;"> },</span></span>
<span class="line"><span style="color:#BABED8;">    banner</span></span>
<span class="line"><span style="color:#89DDFF;">  },</span></span>
<span class="line"><span style="color:#89DDFF;">  &#39;</span><span style="color:#F07178;">web-full-cjs-prod</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#F07178;">    entry</span><span style="color:#89DDFF;">:</span><span style="color:#82AAFF;"> resolve</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">web/entry-runtime-with-compiler.js</span><span style="color:#89DDFF;">&#39;</span><span style="color:#BABED8;">)</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    dest</span><span style="color:#89DDFF;">:</span><span style="color:#82AAFF;"> resolve</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">dist/vue.common.prod.js</span><span style="color:#89DDFF;">&#39;</span><span style="color:#BABED8;">)</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    format</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">cjs</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    env</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">production</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    alias</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> {</span><span style="color:#F07178;"> he</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">./entity-decoder</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;"> },</span></span>
<span class="line"><span style="color:#BABED8;">    banner</span></span>
<span class="line"><span style="color:#89DDFF;">  },</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  // Runtime only ES modules build (for bundlers)</span></span>
<span class="line"><span style="color:#89DDFF;">  &#39;</span><span style="color:#F07178;">web-runtime-esm</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#F07178;">    entry</span><span style="color:#89DDFF;">:</span><span style="color:#82AAFF;"> resolve</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">web/entry-runtime.js</span><span style="color:#89DDFF;">&#39;</span><span style="color:#BABED8;">)</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    dest</span><span style="color:#89DDFF;">:</span><span style="color:#82AAFF;"> resolve</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">dist/vue.runtime.esm.js</span><span style="color:#89DDFF;">&#39;</span><span style="color:#BABED8;">)</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    format</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">es</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#BABED8;">    banner</span></span>
<span class="line"><span style="color:#89DDFF;">  },</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  //... 省略部分代码</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">function</span><span style="color:#82AAFF;"> genConfig</span><span style="color:#89DDFF;"> (</span><span style="color:#BABED8;font-style:italic;">name</span><span style="color:#89DDFF;">)</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#C792EA;">  const</span><span style="color:#BABED8;"> opts</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> builds</span><span style="color:#F07178;">[</span><span style="color:#BABED8;">name</span><span style="color:#F07178;">]</span></span>
<span class="line"><span style="color:#C792EA;">  const</span><span style="color:#BABED8;"> config</span><span style="color:#89DDFF;"> =</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#F07178;">    input</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> opts</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">entry</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    external</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> opts</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">external</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    plugins</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> [</span></span>
<span class="line"><span style="color:#82AAFF;">      flow</span><span style="color:#F07178;">()</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#82AAFF;">      alias</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">Object</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">assign</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">{},</span><span style="color:#BABED8;"> aliases</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> opts</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">alias</span><span style="color:#F07178;">))</span></span>
<span class="line"><span style="color:#F07178;">    ]</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">concat</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">opts</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">plugins</span><span style="color:#89DDFF;"> ||</span><span style="color:#F07178;"> [])</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    output</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#F07178;">      file</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> opts</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">dest</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">      format</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> opts</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">format</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">      banner</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> opts</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">banner</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">      name</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> opts</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">moduleName</span><span style="color:#89DDFF;"> ||</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">Vue</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#89DDFF;">    },</span></span>
<span class="line"><span style="color:#82AAFF;">    onwarn</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> (</span><span style="color:#BABED8;font-style:italic;">msg</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;font-style:italic;"> warn</span><span style="color:#89DDFF;">)</span><span style="color:#C792EA;"> =&gt;</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">      if</span><span style="color:#F07178;"> (</span><span style="color:#89DDFF;">!</span><span style="color:#89DDFF;">/</span><span style="color:#C3E88D;">Circular</span><span style="color:#89DDFF;">/</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">test</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">msg</span><span style="color:#F07178;">)) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#82AAFF;">        warn</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">msg</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">      }</span></span>
<span class="line"><span style="color:#89DDFF;">    }</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  //... 省略部分代码</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">  return</span><span style="color:#BABED8;"> config</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">//... 省略部分代码</span></span>
<span class="line"><span style="color:#89DDFF;">exports.</span><span style="color:#82AAFF;">getAllBuilds</span><span style="color:#89DDFF;"> =</span><span style="color:#89DDFF;"> ()</span><span style="color:#C792EA;"> =&gt;</span><span style="color:#BABED8;"> Object</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">keys</span><span style="color:#BABED8;">(builds)</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">map</span><span style="color:#BABED8;">(genConfig)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br></div></div><p>在<code>config</code>文件中，通过<code>getAllBuilds</code>遍历<code>builds</code>，进行<code>getConfig</code>加工，<code>getConfig</code>方法内部，其实就是对<code>builds</code>中的每个属性，进行config改造，可以看出内部的config其实就是<code>rollup</code>的配置，最终返回改造好的<code>config</code> 再看<code>builds</code>其实就是针对构建不同规范、不同平台、不同环境进行的配置，如：web平台、commonJS规范、dev及prod环境、Runtime版本、Runtime+Comiler版、ES Module版等等，这样可以集中处理需要构建的目标版本等等，这里做了很好的区分，也容易管理</p><blockquote><p>知道了打包的入口文件，就可以找到Vue开始的位置了，本篇分析<code>Runtime+Compiler</code>的commonjs版本，关于Runtime和Compiler版本后面再做介绍</p></blockquote><h2 id="入口分析" tabindex="-1">入口分析 <a class="header-anchor" href="#入口分析" aria-label="Permalink to &quot;入口分析&quot;">​</a></h2><p>上部分我们终于找到了Vue打包的入口，可以看到有很多，我们只讲<code>Runtime+Compiler</code>的commonjs版本，可以在源码中找到<code>entry-runtime-with-compiler.js</code>，这就是打包入口。</p><blockquote><p>首先我们要先找到Vue的定义所在</p></blockquote><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#676E95;font-style:italic;">// src/platforms/web/entry-runtime-with-compiler.js</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">//... 省略部分代码</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#BABED8;"> Vue </span><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">./runtime/index</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#BABED8;"> mount </span><span style="color:#89DDFF;">=</span><span style="color:#FFCB6B;"> Vue</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">prototype</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">$mount</span></span>
<span class="line"><span style="color:#FFCB6B;">Vue</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">prototype</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">$mount</span><span style="color:#89DDFF;"> =</span><span style="color:#C792EA;"> function</span><span style="color:#89DDFF;"> (</span></span>
<span class="line"><span style="color:#BABED8;font-style:italic;">  el</span><span style="color:#89DDFF;">?:</span><span style="color:#FFCB6B;"> string</span><span style="color:#89DDFF;"> |</span><span style="color:#FFCB6B;"> Element</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#BABED8;font-style:italic;">  hydrating</span><span style="color:#89DDFF;">?:</span><span style="color:#FFCB6B;"> boolean</span></span>
<span class="line"><span style="color:#89DDFF;">):</span><span style="color:#FFCB6B;"> Component</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  //... 省略部分代码</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">  return</span><span style="color:#BABED8;"> mount</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">call</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">this,</span><span style="color:#BABED8;"> el</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> hydrating</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#89DDFF;font-style:italic;"> default</span><span style="color:#BABED8;"> Vue</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>在上述入口文件中，并没有看到<code>Vue</code>的定义，只是从<code>runtime/index</code>文件中引入了Vue，然后先对Vue的原型方法<code>$mount</code>进行缓存，再重写<code>$mount</code>，最后导出了<code>Vue</code></p><p>接着我们来到<code>src/platforms/web/runtime/index.js</code></p><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#676E95;font-style:italic;">//src/platforms/web/runtime/index.js\`</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#BABED8;"> Vue </span><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">core/index</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#89DDFF;"> {</span><span style="color:#BABED8;"> patch</span><span style="color:#89DDFF;"> }</span><span style="color:#89DDFF;font-style:italic;"> from</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">./patch</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#BABED8;"> platformDirectives </span><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">./directives/index</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#BABED8;"> platformComponents </span><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">./components/index</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// install platform specific utils</span></span>
<span class="line"><span style="color:#BABED8;">Vue</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">config</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">mustUseProp </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> mustUseProp</span></span>
<span class="line"><span style="color:#BABED8;">Vue</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">config</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">isReservedTag </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> isReservedTag</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">//... 省略部分代码</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// install platform runtime directives &amp; components</span></span>
<span class="line"><span style="color:#82AAFF;">extend</span><span style="color:#BABED8;">(Vue</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">options</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">directives</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> platformDirectives)</span></span>
<span class="line"><span style="color:#82AAFF;">extend</span><span style="color:#BABED8;">(Vue</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">options</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">components</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> platformComponents)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// install platform patch function</span></span>
<span class="line"><span style="color:#FFCB6B;">Vue</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">prototype</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">__patch__ </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> inBrowser </span><span style="color:#89DDFF;">?</span><span style="color:#BABED8;"> patch </span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> noop</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// public mount method</span></span>
<span class="line"><span style="color:#FFCB6B;">Vue</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">prototype</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">$mount</span><span style="color:#89DDFF;"> =</span><span style="color:#C792EA;"> function</span><span style="color:#89DDFF;"> (</span></span>
<span class="line"><span style="color:#BABED8;font-style:italic;">  el</span><span style="color:#89DDFF;">?:</span><span style="color:#FFCB6B;"> string</span><span style="color:#89DDFF;"> |</span><span style="color:#FFCB6B;"> Element</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#BABED8;font-style:italic;">  hydrating</span><span style="color:#89DDFF;">?:</span><span style="color:#FFCB6B;"> boolean</span></span>
<span class="line"><span style="color:#89DDFF;">):</span><span style="color:#FFCB6B;"> Component</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#BABED8;">  el</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> el</span><span style="color:#89DDFF;"> &amp;&amp;</span><span style="color:#BABED8;"> inBrowser</span><span style="color:#89DDFF;"> ?</span><span style="color:#82AAFF;"> query</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">el</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> undefined</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">  return</span><span style="color:#82AAFF;"> mountComponent</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">this,</span><span style="color:#BABED8;"> el</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> hydrating</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">//... 省略部分代码</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#89DDFF;font-style:italic;"> default</span><span style="color:#BABED8;"> Vue</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>在上述文件中，也没有找到<code>Vue</code>的定义，只是简单的从<code>core/index</code>文件中导出了<code>Vue</code>。这里为Vue扩展了静态属性<code>config</code>并设置了一些配置属性，然后在其静态属性<code>options</code>上扩展了和平台相关的指令、组件等等；并给Vue原型定义了<code>_patch__</code>方法，然后发现这里找到了<code>$mount</code>方法的位置，内部执行的是<code>mountComponent</code>函数（后面再讲），最后导出Vue</p><blockquote><p>其实这里就是为Vue做不同平台的构建做了一些扩展和准备，如__patch__方法在非浏览器环境下（ssr）就不需要patch，所以是个空函数</p></blockquote><p>接着我们来到了<code>core/index</code></p><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#676E95;font-style:italic;">// src/core/index.js</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#BABED8;"> Vue </span><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">./instance/index</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#89DDFF;"> {</span><span style="color:#BABED8;"> initGlobalAPI</span><span style="color:#89DDFF;"> }</span><span style="color:#89DDFF;font-style:italic;"> from</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">./global-api/index</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#89DDFF;"> {</span><span style="color:#BABED8;"> isServerRendering</span><span style="color:#89DDFF;"> }</span><span style="color:#89DDFF;font-style:italic;"> from</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">core/util/env</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#89DDFF;"> {</span><span style="color:#BABED8;"> FunctionalRenderContext</span><span style="color:#89DDFF;"> }</span><span style="color:#89DDFF;font-style:italic;"> from</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">core/vdom/create-functional-component</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// 初始化全局API</span></span>
<span class="line"><span style="color:#82AAFF;">initGlobalAPI</span><span style="color:#BABED8;">(Vue)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">Object</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">defineProperty</span><span style="color:#BABED8;">(</span><span style="color:#FFCB6B;">Vue</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">prototype</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">$isServer</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#F07178;">  get</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> isServerRendering</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#BABED8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">Object</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">defineProperty</span><span style="color:#BABED8;">(</span><span style="color:#FFCB6B;">Vue</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">prototype</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">$ssrContext</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#F07178;">  get</span><span style="color:#89DDFF;"> ()</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    /* istanbul ignore next */</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">    return</span><span style="color:#89DDFF;"> this.</span><span style="color:#BABED8;">$vnode</span><span style="color:#89DDFF;"> &amp;&amp;</span><span style="color:#89DDFF;"> this.</span><span style="color:#BABED8;">$vnode</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">ssrContext</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#BABED8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// expose FunctionalRenderContext for ssr runtime helper installation</span></span>
<span class="line"><span style="color:#BABED8;">Object</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">defineProperty</span><span style="color:#BABED8;">(Vue</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">FunctionalRenderContext</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#F07178;">  value</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> FunctionalRenderContext</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#BABED8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">Vue</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">version </span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">__VERSION__</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#89DDFF;font-style:italic;"> default</span><span style="color:#BABED8;"> Vue</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>这里也没有找到<code>Vue</code>定义，而是从<code>core/instance/index</code>中引入了Vue，<code>initGlobalAPI</code>是对Vue挂载了全局静态属性及方法，如：<code>nextTick</code>、<code>set</code>...等等，直接看<code>instance/index</code>文件</p><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#676E95;font-style:italic;">// src/core/instance/index</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#89DDFF;"> {</span><span style="color:#BABED8;"> initMixin</span><span style="color:#89DDFF;"> }</span><span style="color:#89DDFF;font-style:italic;"> from</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">./init</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#89DDFF;"> {</span><span style="color:#BABED8;"> stateMixin</span><span style="color:#89DDFF;"> }</span><span style="color:#89DDFF;font-style:italic;"> from</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">./state</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#89DDFF;"> {</span><span style="color:#BABED8;"> renderMixin</span><span style="color:#89DDFF;"> }</span><span style="color:#89DDFF;font-style:italic;"> from</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">./render</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#89DDFF;"> {</span><span style="color:#BABED8;"> eventsMixin</span><span style="color:#89DDFF;"> }</span><span style="color:#89DDFF;font-style:italic;"> from</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">./events</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#89DDFF;"> {</span><span style="color:#BABED8;"> lifecycleMixin</span><span style="color:#89DDFF;"> }</span><span style="color:#89DDFF;font-style:italic;"> from</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">./lifecycle</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#89DDFF;"> {</span><span style="color:#BABED8;"> warn</span><span style="color:#89DDFF;"> }</span><span style="color:#89DDFF;font-style:italic;"> from</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">../util/index</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">function</span><span style="color:#82AAFF;"> Vue</span><span style="color:#89DDFF;"> (</span><span style="color:#BABED8;font-style:italic;">options</span><span style="color:#89DDFF;">)</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">  if</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">process</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">env</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">NODE_ENV</span><span style="color:#89DDFF;"> !==</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">production</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;"> &amp;&amp;</span></span>
<span class="line"><span style="color:#89DDFF;">    !</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">this</span><span style="color:#89DDFF;"> instanceof</span><span style="color:#FFCB6B;"> Vue</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">  ) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#82AAFF;">    warn</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">Vue is a constructor and should be called with the \`new\` keyword</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span></span>
<span class="line"><span style="color:#89DDFF;">  this.</span><span style="color:#82AAFF;">_init</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">options</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#82AAFF;">initMixin</span><span style="color:#BABED8;">(Vue)</span></span>
<span class="line"><span style="color:#82AAFF;">stateMixin</span><span style="color:#BABED8;">(Vue)</span></span>
<span class="line"><span style="color:#82AAFF;">eventsMixin</span><span style="color:#BABED8;">(Vue)</span></span>
<span class="line"><span style="color:#82AAFF;">lifecycleMixin</span><span style="color:#BABED8;">(Vue)</span></span>
<span class="line"><span style="color:#82AAFF;">renderMixin</span><span style="color:#BABED8;">(Vue)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#89DDFF;font-style:italic;"> default</span><span style="color:#BABED8;"> Vue</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>终于找到了Vue定义，原来就是一个函数</p><h2 id="new-vue发生了什么" tabindex="-1">new Vue发生了什么 <a class="header-anchor" href="#new-vue发生了什么" aria-label="Permalink to &quot;new Vue发生了什么&quot;">​</a></h2><p>上个章节终于找到了vue的定义所在，就是一个普通函数，找到Vue接下来就可以对其进行下一步的分析了</p><p>通常我们都要new一个Vue，如下：</p><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#89DDFF;">new</span><span style="color:#82AAFF;"> Vue</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  template</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> \`</span><span style="color:#C3E88D;">&lt;div&gt;{{title}}&lt;/div&gt;</span><span style="color:#89DDFF;">\`</span></span>
<span class="line"><span style="color:#BABED8;">  data: </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> title</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">emmm...</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;"> },</span></span>
<span class="line"><span style="color:#F07178;">  methods</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> {}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#BABED8;">)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>在执行new操作后，就会执行内部方法<code>_init</code>，在源码中</p><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#C792EA;">function</span><span style="color:#82AAFF;"> Vue</span><span style="color:#89DDFF;"> (</span><span style="color:#BABED8;font-style:italic;">options</span><span style="color:#89DDFF;">)</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#89DDFF;">  this.</span><span style="color:#82AAFF;">_init</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">options</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#82AAFF;">initMixin</span><span style="color:#BABED8;">(Vue)</span></span>
<span class="line"><span style="color:#82AAFF;">stateMixin</span><span style="color:#BABED8;">(Vue)</span></span>
<span class="line"><span style="color:#82AAFF;">eventsMixin</span><span style="color:#BABED8;">(Vue)</span></span>
<span class="line"><span style="color:#82AAFF;">lifecycleMixin</span><span style="color:#BABED8;">(Vue)</span></span>
<span class="line"><span style="color:#82AAFF;">renderMixin</span><span style="color:#BABED8;">(Vue)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>那么<code>_init</code>方法又是从哪来的，首先肯定会想到是在Vue原型上定义的方法，接着再看下面给Vue进行了多个mixin，我们先看<code>initMixin</code>，initMixin在<code>init.js</code>中：</p><div class="language-js line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#676E95;font-style:italic;">// src/core/instance/init.js</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">let</span><span style="color:#BABED8;"> uid </span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;"> 0</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#C792EA;"> function</span><span style="color:#82AAFF;"> initMixin</span><span style="color:#89DDFF;"> (</span><span style="color:#BABED8;font-style:italic;">Vue</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> Class</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">Component</span><span style="color:#89DDFF;">&gt;)</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#FFCB6B;">  Vue</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">prototype</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">_init</span><span style="color:#89DDFF;"> =</span><span style="color:#C792EA;"> function</span><span style="color:#89DDFF;"> (</span><span style="color:#BABED8;font-style:italic;">options</span><span style="color:#89DDFF;">?:</span><span style="color:#FFCB6B;"> Object</span><span style="color:#89DDFF;">)</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#C792EA;">    const</span><span style="color:#BABED8;"> vm</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> Component</span><span style="color:#89DDFF;"> =</span><span style="color:#89DDFF;"> this</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // a uid</span></span>
<span class="line"><span style="color:#BABED8;">    vm</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">_uid</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> uid</span><span style="color:#89DDFF;">++</span></span>
<span class="line"><span style="color:#F07178;">   </span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // a flag to avoid this being observed</span></span>
<span class="line"><span style="color:#BABED8;">    vm</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">_isVue</span><span style="color:#89DDFF;"> =</span><span style="color:#FF9CAC;"> true</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">    if</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">options</span><span style="color:#89DDFF;"> &amp;&amp;</span><span style="color:#BABED8;"> options</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">_isComponent</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#82AAFF;">      initInternalComponent</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">vm</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> options</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">    }</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">    else</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#BABED8;">      vm</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">$options</span><span style="color:#89DDFF;"> =</span><span style="color:#82AAFF;"> mergeOptions</span><span style="color:#F07178;">(</span></span>
<span class="line"><span style="color:#82AAFF;">        resolveConstructorOptions</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">vm</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">constructor</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#BABED8;">        options</span><span style="color:#89DDFF;"> ||</span><span style="color:#89DDFF;"> {},</span></span>
<span class="line"><span style="color:#BABED8;">        vm</span></span>
<span class="line"><span style="color:#F07178;">      )</span></span>
<span class="line"><span style="color:#89DDFF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">    if</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">process</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">env</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">NODE_ENV</span><span style="color:#89DDFF;"> !==</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">production</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#82AAFF;">      initProxy</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">vm</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">    }</span><span style="color:#89DDFF;font-style:italic;"> else</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#BABED8;">      vm</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">_renderProxy</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> vm</span></span>
<span class="line"><span style="color:#89DDFF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // expose real self</span></span>
<span class="line"><span style="color:#BABED8;">    vm</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">_self</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> vm</span></span>
<span class="line"></span>
<span class="line"><span style="color:#82AAFF;">    initLifecycle</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">vm</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#82AAFF;">    initEvents</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">vm</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#82AAFF;">    initRender</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">vm</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#82AAFF;">    callHook</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">vm</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">beforeCreate</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#82AAFF;">    initInjections</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">vm</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#82AAFF;">    initState</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">vm</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#82AAFF;">    initProvide</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">vm</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#82AAFF;">    callHook</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">vm</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">created</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">    if</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">vm</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">$options</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">el</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">      vm</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">$mount</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">vm</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">$options</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">el</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">    }</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">//...省略部分代码</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br></div></div><p>在init中，可以看到为Vue原型挂载了<code>_init</code>方法，因此当new Vue的时候，执行的就是这个<code>_init</code>方法。 在<code>_init</code>函数内部首先对传入的options进行了合并，<code>mergeOptions</code></p><p>由于工作原因，后续会不断补充...(感谢理解）</p>`,37);function F(D,i,y,b,u,m){const a=n("Reward"),l=n("Gitalk");return c(),e("div",null,[t,s(a),s(l)])}const d=p(r,[["render",F]]);export{A as __pageData,d as default};
