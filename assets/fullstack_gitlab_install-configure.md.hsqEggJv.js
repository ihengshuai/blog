import{_ as p,c as e,J as s,V as o,o as c,G as n}from"./chunks/framework.SV1ROkXV.js";const C=JSON.parse('{"title":"GitLab安装与配置","description":"一篇gitlab完整的安装教程教你玩转gitlab","frontmatter":{"title":"GitLab安装与配置","description":"一篇gitlab完整的安装教程教你玩转gitlab","keywords":"gitlab,流水线,CI/CD,自动化构建","logo":"https://ihengshuai-demo1.oss-cn-beijing.aliyuncs.com/icon-gitlab.png"},"headers":[],"relativePath":"fullstack/gitlab/install-configure.md","filePath":"fullstack/gitlab/install-configure.md","lastUpdated":1709440279000}'),r={name:"fullstack/gitlab/install-configure.md"},t=o(`<h1 id="gitlab安装与配置" tabindex="-1">GitLab安装与配置 <a class="header-anchor" href="#gitlab安装与配置" aria-label="Permalink to &quot;GitLab安装与配置&quot;">​</a></h1><div class="tip custom-block"><p class="custom-block-title">提示</p><p>本篇以gitlab 14.16.0 版本为教程，其它版本大同小异，官方文档：<a href="https://docs.gitlab.com/ee" target="_blank" rel="noreferrer">https://docs.gitlab.com/ee</a></p></div><h2 id="docker安装" tabindex="-1">docker安装 <a class="header-anchor" href="#docker安装" aria-label="Permalink to &quot;docker安装&quot;">​</a></h2><blockquote><p>对于gitlab的安装本人都是在arm架构Centos7.9虚拟机上进行的，请悉知本人安装环境，或者与本人的环境保持一致，以便产生不必要的疑惑。</p></blockquote><p>这里使用docker安装，机器上需要先安装docker，此处不再赘述。</p><p><a href="https://docs.gitlab.com/ee/install/docker.html" target="_blank" rel="noreferrer">https://docs.gitlab.com/ee/install/docker.html</a></p><p><a href="https://docs.gitlab.com/runner/install/docker.html" target="_blank" rel="noreferrer">https://docs.gitlab.com/runner/install/docker.html</a></p><div class="language-sh line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#676E95;font-style:italic;"># arm架构镜像(如果你也是arm架构，可以使用此镜像)</span></span>
<span class="line"><span style="color:#FFCB6B;">docker</span><span style="color:#C3E88D;"> pull yrzr/gitlab-ce-arm64v8</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 最新版amd架构(非arm架构)</span></span>
<span class="line"><span style="color:#FFCB6B;">docker</span><span style="color:#C3E88D;"> pull gitlab/gitlab-ee</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>配置并启动</p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#676E95;font-style:italic;"># 下载好后使用docker engine 运行gitlab</span></span>
<span class="line"><span style="color:#FFCB6B;">sudo</span><span style="color:#C3E88D;"> docker run -d </span><span style="color:#BABED8;">\\</span></span>
<span class="line"><span style="color:#C3E88D;">  --hostname</span><span style="color:#C3E88D;"> gitlab.ihengshuai.com </span><span style="color:#BABED8;">\\</span></span>
<span class="line"><span style="color:#C3E88D;">  --publish</span><span style="color:#F78C6C;"> 443</span><span style="color:#C3E88D;">:443 --publish </span><span style="color:#F78C6C;">80</span><span style="color:#C3E88D;">:80 --publish </span><span style="color:#F78C6C;">8422</span><span style="color:#C3E88D;">:22 </span><span style="color:#BABED8;">\\</span></span>
<span class="line"><span style="color:#C3E88D;">  --name</span><span style="color:#C3E88D;"> gitlab </span><span style="color:#BABED8;">\\</span></span>
<span class="line"><span style="color:#C3E88D;">	--restart</span><span style="color:#C3E88D;"> always </span><span style="color:#BABED8;">\\</span></span>
<span class="line"><span style="color:#C3E88D;">  -v</span><span style="color:#C3E88D;"> /srv/gitlab/config:/etc/gitlab </span><span style="color:#BABED8;">\\</span></span>
<span class="line"><span style="color:#C3E88D;">  -v</span><span style="color:#C3E88D;"> /srv/gitlab/logs:/var/log/gitlab </span><span style="color:#BABED8;">\\</span></span>
<span class="line"><span style="color:#C3E88D;">  -v</span><span style="color:#C3E88D;"> /srv/gitlab/data:/var/opt/gitlab </span><span style="color:#BABED8;">\\</span></span>
<span class="line"><span style="color:#C3E88D;">  --shm-size</span><span style="color:#F78C6C;"> 512</span><span style="color:#C3E88D;">m </span><span style="color:#BABED8;">\\</span></span>
<span class="line"><span style="color:#C3E88D;">  yrzr/gitlab-ce-arm64v8</span></span>
<span class="line"><span style="color:#BABED8;">  </span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># IP</span></span>
<span class="line"><span style="color:#FFCB6B;">sudo</span><span style="color:#C3E88D;"> docker run -d </span><span style="color:#BABED8;">\\</span></span>
<span class="line"><span style="color:#C3E88D;">  --hostname</span><span style="color:#F78C6C;"> 192.168</span><span style="color:#C3E88D;">.10.10 </span><span style="color:#BABED8;">\\</span></span>
<span class="line"><span style="color:#C3E88D;">  --publish</span><span style="color:#F78C6C;"> 443</span><span style="color:#C3E88D;">:443 --publish </span><span style="color:#F78C6C;">80</span><span style="color:#C3E88D;">:80 --publish </span><span style="color:#F78C6C;">8422</span><span style="color:#C3E88D;">:22 </span><span style="color:#BABED8;">\\</span></span>
<span class="line"><span style="color:#C3E88D;">  --name</span><span style="color:#C3E88D;"> gitlab </span><span style="color:#BABED8;">\\</span></span>
<span class="line"><span style="color:#C3E88D;">	--restart</span><span style="color:#C3E88D;"> always </span><span style="color:#BABED8;">\\</span></span>
<span class="line"><span style="color:#C3E88D;">  -v</span><span style="color:#C3E88D;"> /srv/gitlab/config:/etc/gitlab </span><span style="color:#BABED8;">\\</span></span>
<span class="line"><span style="color:#C3E88D;">  -v</span><span style="color:#C3E88D;"> /srv/gitlab/logs:/var/log/gitlab </span><span style="color:#BABED8;">\\</span></span>
<span class="line"><span style="color:#C3E88D;">  -v</span><span style="color:#C3E88D;"> /srv/gitlab/data:/var/opt/gitlab </span><span style="color:#BABED8;">\\</span></span>
<span class="line"><span style="color:#C3E88D;">  --shm-size</span><span style="color:#F78C6C;"> 512</span><span style="color:#C3E88D;">m </span><span style="color:#BABED8;">\\</span></span>
<span class="line"><span style="color:#C3E88D;">  yrzr/gitlab-ce-arm64v8</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h3 id="命令式" tabindex="-1">命令式 <a class="header-anchor" href="#命令式" aria-label="Permalink to &quot;命令式&quot;">​</a></h3><ol><li><p>首先创建挂载卷</p><div class="language-sh line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#FFCB6B;">mkdir</span><span style="color:#C3E88D;"> -p</span><span style="color:#C3E88D;"> /srv/gitlab</span></span>
<span class="line"><span style="color:#82AAFF;">cd</span><span style="color:#C3E88D;"> /srv/gitlab </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#FFCB6B;"> mkdir</span><span style="color:#C3E88D;"> config data logs</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li><li><p>运行gitlab容器</p><div class="language-sh line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#FFCB6B;">sudo</span><span style="color:#C3E88D;"> docker run -d </span><span style="color:#BABED8;">\\</span></span>
<span class="line"><span style="color:#C3E88D;">  --hostname</span><span style="color:#F78C6C;"> 192.168</span><span style="color:#C3E88D;">.10.10 </span><span style="color:#BABED8;">\\</span></span>
<span class="line"><span style="color:#C3E88D;">  -p</span><span style="color:#F78C6C;"> 443</span><span style="color:#C3E88D;">:443 --publish </span><span style="color:#F78C6C;">80</span><span style="color:#C3E88D;">:80 --publish </span><span style="color:#F78C6C;">8422</span><span style="color:#C3E88D;">:22 </span><span style="color:#BABED8;">\\</span></span>
<span class="line"><span style="color:#C3E88D;">  --name</span><span style="color:#C3E88D;"> gitlab </span><span style="color:#BABED8;">\\</span></span>
<span class="line"><span style="color:#C3E88D;">	--restart</span><span style="color:#C3E88D;"> always </span><span style="color:#BABED8;">\\</span></span>
<span class="line"><span style="color:#C3E88D;">  -v</span><span style="color:#C3E88D;"> /srv/gitlab/config:/etc/gitlab </span><span style="color:#BABED8;">\\</span></span>
<span class="line"><span style="color:#C3E88D;">  -v</span><span style="color:#C3E88D;"> /srv/gitlab/logs:/var/log/gitlab </span><span style="color:#BABED8;">\\</span></span>
<span class="line"><span style="color:#C3E88D;">  -v</span><span style="color:#C3E88D;"> /srv/gitlab/data:/var/opt/gitlab </span><span style="color:#BABED8;">\\</span></span>
<span class="line"><span style="color:#C3E88D;">  --shm-size</span><span style="color:#F78C6C;"> 512</span><span style="color:#C3E88D;">m </span><span style="color:#BABED8;">\\</span></span>
<span class="line"><span style="color:#C3E88D;">  yrzr/gitlab-ce-arm64v8</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div></li></ol><p>相关参数说明：</p><ul><li><code>hostname</code>：指定gitlab的ip地址，用于浏览器的访问（域名访问看后面），这里指定虚拟的ip<code>192.168.10.10</code></li><li><code>-p</code>：暴露gitlab的<code>http</code>、<code>https</code>、<code>ssh</code>端口，这里http使用主机的80端口，需要注意主机是否占用80端口；https使用主机443端口，同样注意端口占用；由于虚拟机占用了ssh端口22，这里使用8422端口作为gitlab的ssh端口</li><li><code>-v</code>：挂载gitlab的相关配置到主机，方便修改配置</li></ul><p>当执行上面命令后，根据自己机器的配置等待一段时间，便会启动成功，你可以查看启动日志：</p><div class="language-sh line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#FFCB6B;">docker</span><span style="color:#C3E88D;"> logs -f gitlab</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>通常出现以下情况启动成功：</p><p><img src="https://ihengshuai-demo1.oss-cn-beijing.aliyuncs.com/image-20230316181606466.png" alt="image-20230316181606466"></p><p>浏览器进行访问：</p><p><img src="https://ihengshuai-demo1.oss-cn-beijing.aliyuncs.com/image-20230319160426583.png" alt="image-20230319160426583"></p><p>默认账户是<code>root</code>，密码可以从下文得知</p><h3 id="配置文件安装" tabindex="-1">配置文件安装 <a class="header-anchor" href="#配置文件安装" aria-label="Permalink to &quot;配置文件安装&quot;">​</a></h3><p>此方式使用<code>docker-compose</code>配置文件安装，你可以根据自己的需求来选择安装方式，相关配置参数此处不做解释。</p><div class="language-yaml line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#F07178;">version</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">3.6</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#F07178;">services</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#F07178;">  web</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#F07178;">    image</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">yrzr/gitlab-ce-arm64v8</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#F07178;">    restart</span><span style="color:#89DDFF;">:</span><span style="color:#C3E88D;"> always</span></span>
<span class="line"><span style="color:#F07178;">    hostname</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">192.168.10.10</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#F07178;">    ports</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#89DDFF;">      -</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">80:80</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#89DDFF;">      -</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">443:443</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#89DDFF;">      -</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">8422:22</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#F07178;">    volumes</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#89DDFF;">      -</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">/srv/gitlab/config:/etc/gitlab</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#89DDFF;">      -</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">/srv/gitlab/logs:/var/log/gitlab</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#89DDFF;">      -</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">/srv/gitlab/data:/var/opt/gitlab</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#F07178;">    shm_size</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">256m</span><span style="color:#89DDFF;">&#39;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>然后运行此配置文件</p><div class="language-sh line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#FFCB6B;">docker</span><span style="color:#C3E88D;"> compose -d up .</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>后续内容同上</p><h3 id="密码" tabindex="-1">密码 <a class="header-anchor" href="#密码" aria-label="Permalink to &quot;密码&quot;">​</a></h3><p>在gitlab搭建好后，需要查看root账户的初始密码，当一些密码忘记后，也可以重置密码</p><ol><li><p>查看root初始</p><div class="language-sh line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#676E95;font-style:italic;"># 查看root初始密码</span></span>
<span class="line"><span style="color:#FFCB6B;">sudo</span><span style="color:#C3E88D;"> docker exec -it gitlab grep </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">Password:</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;"> /etc/gitlab/initial_root_password</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li></ol><p>​ 其实gitlab的初始密码就存储在<code>/etc/gitlab/initial_root_password</code>这个文件里，由于我们挂载了卷，你也可以在宿主机上查看。</p><ol start="2"><li><p>重置密码，这里以root账户为例，修改数据库重置（实际情况对于root账户没忘的话，可以用root账户重置其它账户的密码）</p><div class="language-sh line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#676E95;font-style:italic;"># https://docs.gitlab.cn/jh/security/reset_user_password.html</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 进入gitlab容器中</span></span>
<span class="line"><span style="color:#FFCB6B;">docker</span><span style="color:#C3E88D;"> exec -it gitlab bash</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 使用gitlab-rails</span></span>
<span class="line"><span style="color:#FFCB6B;">gitlab-rails</span><span style="color:#C3E88D;"> console -e production</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># id为1的是root</span></span>
<span class="line"><span style="color:#FFCB6B;">user</span><span style="color:#C3E88D;"> = User.where</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">id:</span><span style="color:#F78C6C;"> 1</span><span style="color:#89DDFF;">)</span><span style="color:#C3E88D;">.first</span></span>
<span class="line"><span style="color:#FFCB6B;">user.password</span><span style="color:#C3E88D;"> = </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">xxxxx</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#FFCB6B;">user.password_confirmation</span><span style="color:#C3E88D;"> = </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">xxxx</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#FFCB6B;">user.save</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 保存退出后，如果登不上，则需要重载配置</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div></li></ol><h3 id="域名与证书" tabindex="-1">域名与证书 <a class="header-anchor" href="#域名与证书" aria-label="Permalink to &quot;域名与证书&quot;">​</a></h3><p>gitlab除了可以使用ip地址外，也可以自定义域名，也可以使用https，并认证自签证书，整个过程主要分为以下步骤：</p><ul><li>添加域名：可以使用本机DNS映射域名</li><li>使用https：可选，如果你需要https</li><li>配置证书：可选，如果你启用了https，需要提供证书，你可以使用自签证书并信任</li><li>重载配置</li></ul><p>以上相关配置都是在gitlab.rb配置文件中修改的，你可以在宿主机的<code> /srv/gitlab/config/gitlab.rb</code>文件中进行修改，或进入容器中修改<code>/etc/gitlab/config/gitlab.rb</code>，二者是等价的。</p><h4 id="配置域名" tabindex="-1">配置域名 <a class="header-anchor" href="#配置域名" aria-label="Permalink to &quot;配置域名&quot;">​</a></h4><div class="language-ruby line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#676E95;font-style:italic;"># vim /srv/gitlab/config/gitlab.rb</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 使用域名 https://gitlab.ihengshuai.com （这里使用了https），域名自行修改</span></span>
<span class="line"><span style="color:#BABED8;">external_url </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">https://gitlab.ihengshuai.com</span><span style="color:#89DDFF;">&#39;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>在你的主机上添加HOST记录，进行映射</p><div class="language-sh line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#676E95;font-style:italic;"># vim /etc/hosts</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">192.168.10.10</span><span style="color:#C3E88D;"> gitlab.ihengshuai.com</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="开启https" tabindex="-1">开启https <a class="header-anchor" href="#开启https" aria-label="Permalink to &quot;开启https&quot;">​</a></h4><div class="language-toml line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">toml</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#676E95;font-style:italic;"># vim /srv/gitlab/config/gitlab.rb</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">nginx[&#39;client_max_body_size&#39;] = &#39;250m&#39;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 强制HTTPS</span></span>
<span class="line"><span style="color:#BABED8;">nginx[&#39;redirect_http_to_https&#39;] = true</span></span>
<span class="line"><span style="color:#BABED8;">nginx[&#39;redirect_http_to_https_port&#39;] = 80</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h4 id="ssl证书配置" tabindex="-1">ssl证书配置 <a class="header-anchor" href="#ssl证书配置" aria-label="Permalink to &quot;ssl证书配置&quot;">​</a></h4><p>当你开启了https需要配置ssl证书（如果没有可以跳过），你可以使用相关云厂商（阿里云、腾讯云...）提供的免费证书，也可以自签证书。</p><ol><li><p>生成证书，下面以<a href="https://docs.azure.cn/zh-cn/articles/azure-operations-guide/application-gateway/aog-application-gateway-howto-create-self-signed-cert-via-openssl" target="_blank" rel="noreferrer">OpenSSL</a>自签证书为例：</p><div class="language-sh line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#676E95;font-style:italic;"># 使用OpenSSL签发证书</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 1. 生成服务器私钥 (domain.com.key)  domain.com 随便起的名字</span></span>
<span class="line"><span style="color:#FFCB6B;">openssl</span><span style="color:#C3E88D;"> genrsa -out domain.key </span><span style="color:#F78C6C;">4096</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 2.生成证书签名请求(CSR) domain.com.csr</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 生成 CSR 的过程中，会提示输入一些信息，其中一个提示是 Common Name (e.g. YOUR name)，</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 这个非常重要，这一项应填入 FQDN(Fully Qualified Domain Name)完全合格域名/全称域名，</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 如果您使用 SSL 加密保护网络服务器和客户端之间的数据流，</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 举例被保护的网站是 https://test.chinacloudsites.cn，</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 那么此处 Common Name 应输入 test.chinacloudsites.cn</span></span>
<span class="line"><span style="color:#FFCB6B;">openssl</span><span style="color:#C3E88D;"> req -new -key domain.key -out domain.csr</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 3.使用上一步的证书签名请求签发证书</span></span>
<span class="line"><span style="color:#FFCB6B;">openssl</span><span style="color:#C3E88D;"> x509 -req -days </span><span style="color:#F78C6C;">365</span><span style="color:#C3E88D;"> -in domain.csr -signkey domain.key -out domain.crt</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>将以上的domain替换成你想都要的域名如：gitlab.example.com</p><p>这里我写成了一个脚本：</p><div class="language-sh line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#676E95;font-style:italic;"># auto-cetificate.sh</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">#!/bin/bash</span></span>
<span class="line"><span style="color:#82AAFF;">echo</span><span style="color:#89DDFF;"> &quot;</span><span style="color:#C3E88D;">请使用sudo运行以获取系统权限!</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#82AAFF;">echo</span><span style="color:#89DDFF;"> &quot;</span><span style="color:#C3E88D;">请输入域名：</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#82AAFF;">read</span><span style="color:#C3E88D;"> userdomain</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 啥都不输退出</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#89DDFF;"> [</span><span style="color:#89DDFF;"> !</span><span style="color:#89DDFF;"> &quot;</span><span style="color:#BABED8;">$userdomain</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> ];</span><span style="color:#89DDFF;font-style:italic;"> then</span></span>
<span class="line"><span style="color:#82AAFF;">    exit</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">openssl</span><span style="color:#C3E88D;"> genrsa -out </span><span style="color:#BABED8;">$userdomain</span><span style="color:#C3E88D;">.key </span><span style="color:#F78C6C;">4096</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">openssl</span><span style="color:#C3E88D;"> req -new -key </span><span style="color:#BABED8;">$userdomain</span><span style="color:#C3E88D;">.key -out </span><span style="color:#BABED8;">$userdomain</span><span style="color:#C3E88D;">.csr</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">openssl</span><span style="color:#C3E88D;"> x509 -req -days </span><span style="color:#F78C6C;">365</span><span style="color:#C3E88D;"> -in </span><span style="color:#BABED8;">$userdomain</span><span style="color:#C3E88D;">.csr -signkey </span><span style="color:#BABED8;">$userdomain</span><span style="color:#C3E88D;">.key -out </span><span style="color:#BABED8;">$userdomain</span><span style="color:#C3E88D;">.crt</span></span>
<span class="line"></span>
<span class="line"><span style="color:#82AAFF;">echo</span></span>
<span class="line"><span style="color:#82AAFF;">echo</span><span style="color:#89DDFF;"> &quot;</span><span style="color:#C3E88D;">Generate success!</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#82AAFF;">echo</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 将本地域名写入host</span></span>
<span class="line"><span style="color:#82AAFF;">echo</span><span style="color:#C3E88D;"> 需要将域名写入host吗[yes/no]?</span></span>
<span class="line"><span style="color:#82AAFF;">read</span><span style="color:#C3E88D;"> confirm_read_host</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#89DDFF;"> [</span><span style="color:#89DDFF;"> &quot;</span><span style="color:#BABED8;">$confirm_read_host</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> !=</span><span style="color:#89DDFF;"> &quot;</span><span style="color:#C3E88D;">yes</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> ];</span><span style="color:#89DDFF;font-style:italic;"> then</span></span>
<span class="line"><span style="color:#82AAFF;">    exit</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#82AAFF;">echo</span><span style="color:#C3E88D;"> 需要保持和证书域名相同不[yes/no]?</span></span>
<span class="line"><span style="color:#82AAFF;">read</span><span style="color:#C3E88D;"> confirm_write_host</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#89DDFF;"> [</span><span style="color:#89DDFF;"> &quot;</span><span style="color:#BABED8;">$confirm_write_host</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> ==</span><span style="color:#89DDFF;"> &quot;</span><span style="color:#C3E88D;">no</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> ];</span><span style="color:#89DDFF;font-style:italic;"> then</span></span>
<span class="line"><span style="color:#82AAFF;">    echo</span><span style="color:#C3E88D;"> 请填写待写入host的域名</span></span>
<span class="line"><span style="color:#82AAFF;">    read</span><span style="color:#C3E88D;"> custom_host_domain</span></span>
<span class="line"><span style="color:#FFCB6B;">    cp</span><span style="color:#C3E88D;"> /etc/hosts /etc/hosts.old</span></span>
<span class="line"><span style="color:#82AAFF;">    echo</span><span style="color:#89DDFF;"> &quot;</span><span style="color:#C3E88D;">127.0.0.1 </span><span style="color:#BABED8;">$custom_host_domain</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> &gt;&gt;</span><span style="color:#C3E88D;">/etc/hosts</span></span>
<span class="line"><span style="color:#82AAFF;">    exit</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">cp</span><span style="color:#C3E88D;"> /etc/hosts /etc/hosts.old</span></span>
<span class="line"><span style="color:#82AAFF;">echo</span><span style="color:#89DDFF;"> &quot;</span><span style="color:#C3E88D;">127.0.0.1 </span><span style="color:#BABED8;">$userdomain</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> &gt;&gt;</span><span style="color:#C3E88D;">/etc/hosts</span></span>
<span class="line"><span style="color:#82AAFF;">echo</span><span style="color:#89DDFF;"> &quot;</span><span style="color:#C3E88D;">Write success!</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#FFCB6B;">sleep</span><span style="color:#F78C6C;"> 1</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><p>当创建完以上文件后，需要将其加权限，然后执行脚本即可：</p><div class="language-sh line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#FFCB6B;">chmod</span><span style="color:#C3E88D;"> +x ./auto-cetificate.sh</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 执行</span></span>
<span class="line"><span style="color:#FFCB6B;">./auto-cetificate.sh</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>执行后根据提示一步一步填写相关内容</p></li><li><p>配置证书</p><div class="language-sh line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#676E95;font-style:italic;"># vim /srv/gitlab/config/gitlab.rb</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># https证书</span></span>
<span class="line"><span style="color:#FFCB6B;">nginx[</span><span style="color:#FFCB6B;">&#39;ssl_certificate&#39;</span><span style="color:#FFCB6B;">]</span><span style="color:#C3E88D;"> = </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">/etc/gitlab/ssl/domain.crt</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#FFCB6B;">nginx[</span><span style="color:#FFCB6B;">&#39;ssl_certificate_key&#39;</span><span style="color:#FFCB6B;">]</span><span style="color:#C3E88D;"> = </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">/etc/gitlab/ssl/domain.key</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 用默认</span></span>
<span class="line"><span style="color:#FFCB6B;">nginx[</span><span style="color:#FFCB6B;">&#39;ssl_ciphers&#39;</span><span style="color:#FFCB6B;">]</span><span style="color:#C3E88D;"> = xxx</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 需要关闭这个</span></span>
<span class="line"><span style="color:#FFCB6B;">letsencrypt[</span><span style="color:#FFCB6B;">&#39;enable&#39;</span><span style="color:#FFCB6B;">]</span><span style="color:#C3E88D;"> = </span><span style="color:#89DDFF;">false</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>这里的<code>domain</code>改为你自己生成的域名，以上需要使用<code>.key和.crt</code>两个文件，你可以把相关文件移至<code>/srv/gitlab/ssl</code>，这里容器中gitlab的位置为<code>/etc/gitlab/ssl</code></p></li></ol><p>当以上工作都做好了，<strong>需要重启加载配置并重新启动便会配置成功</strong>（这里可以看下一小节）</p><p>最后使用https和域名访问，由于自签证书不安全，你需要忽略安全提示即可</p><p><img src="https://ihengshuai-demo1.oss-cn-beijing.aliyuncs.com/image-20230319165605394.png" alt="image-20230319165605394"></p><p><img src="https://ihengshuai-demo1.oss-cn-beijing.aliyuncs.com/image-20230319165636779.png" alt="image-20230319165636779"></p><p>至此https配置成功了</p><h3 id="配置重载" tabindex="-1">配置重载 <a class="header-anchor" href="#配置重载" aria-label="Permalink to &quot;配置重载&quot;">​</a></h3><p>重载配置有两种：在外部直接docker restart和进入容器中使用gitlab-ctl进行重新启动</p><ol><li><p>外部重启</p><div class="language-sh line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#FFCB6B;">docker</span><span style="color:#C3E88D;"> restart gitlab</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div></li><li><p>进入容器中</p><div class="language-sh line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#676E95;font-style:italic;"># 进入容器</span></span>
<span class="line"><span style="color:#FFCB6B;">docker</span><span style="color:#C3E88D;"> exec -it gitlab bash</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 1.使用gitlab-ctl重启加载配置</span></span>
<span class="line"><span style="color:#FFCB6B;">gitlab-ctl</span><span style="color:#C3E88D;"> reconfigure</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">#日志...</span></span>
<span class="line"><span style="color:#89DDFF;">		(</span><span style="color:#FFCB6B;">up</span><span style="color:#C3E88D;"> to date</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#FFCB6B;">Recipe:</span><span style="color:#C3E88D;"> gitlab::gitlab-rails</span></span>
<span class="line"><span style="color:#FFCB6B;">  *</span><span style="color:#C3E88D;"> execute[clear the gitlab-rails cache] action run</span></span>
<span class="line"><span style="color:#FFCB6B;">    -</span><span style="color:#C3E88D;"> execute /opt/gitlab/bin/gitlab-rake cache:clear</span></span>
<span class="line"><span style="color:#FFCB6B;">Recipe:</span><span style="color:#C3E88D;"> nginx::enable</span></span>
<span class="line"><span style="color:#FFCB6B;">  *</span><span style="color:#C3E88D;"> runit_service[nginx] action restart </span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">up</span><span style="color:#C3E88D;"> to date</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#FFCB6B;">Recipe:</span><span style="color:#C3E88D;"> monitoring::grafana</span></span>
<span class="line"><span style="color:#FFCB6B;">  *</span><span style="color:#C3E88D;"> runit_service[grafana] action restart </span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">up</span><span style="color:#C3E88D;"> to date</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">Running</span><span style="color:#C3E88D;"> handlers:</span></span>
<span class="line"><span style="color:#FFCB6B;">Running</span><span style="color:#C3E88D;"> handlers complete</span></span>
<span class="line"><span style="color:#FFCB6B;">Chef</span><span style="color:#C3E88D;"> Infra Client finished, </span><span style="color:#F78C6C;">9</span><span style="color:#C3E88D;">/735 resources updated in </span><span style="color:#F78C6C;">20</span><span style="color:#C3E88D;"> seconds</span></span>
<span class="line"><span style="color:#FFCB6B;">gitlab</span><span style="color:#C3E88D;"> Reconfigured!</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 2.重新启动</span></span>
<span class="line"><span style="color:#FFCB6B;">gitlab-ctl</span><span style="color:#C3E88D;"> restart</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div></li></ol><p>这里推荐使用第二种方式</p><h2 id="centos安装" tabindex="-1">Centos安装 <a class="header-anchor" href="#centos安装" aria-label="Permalink to &quot;Centos安装&quot;">​</a></h2><p>这里我的虚拟机为Centos7.9 arm架构系列</p><p>后续更新...</p>`,57);function i(b,y,u,m,d,D){const a=n("Reward"),l=n("Gitalk");return c(),e("div",null,[t,s(a),s(l)])}const h=p(r,[["render",i]]);export{C as __pageData,h as default};
