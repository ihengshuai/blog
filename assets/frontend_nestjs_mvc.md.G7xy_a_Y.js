import{_ as p,c as e,J as s,V as o,o as r,G as n}from"./chunks/framework.SV1ROkXV.js";const d=JSON.parse('{"title":"Nest搭建WEB服务","description":"如何使用NestJS搭建通用的web服务，以及国际化的使用","frontmatter":{"title":"Nest搭建WEB服务","description":"如何使用NestJS搭建通用的web服务，以及国际化的使用","keywords":"NestJS教程,node框架,Ioc架构,spring,NestJS MVC,NestJS优势,NestJS原理,装饰器原理","logo":"https://ihengshuai-demo1.oss-cn-beijing.aliyuncs.com/icon-nestjs.png"},"headers":[],"relativePath":"frontend/nestjs/mvc.md","filePath":"frontend/nestjs/mvc.md","lastUpdated":1709440279000}'),t={name:"frontend/nestjs/mvc.md"},c=o(`<h1 id="nest搭建web服务" tabindex="-1">Nest搭建WEB服务 <a class="header-anchor" href="#nest搭建web服务" aria-label="Permalink to &quot;Nest搭建WEB服务&quot;">​</a></h1><p>我们知道Nest采用模块化架构、提供依赖注入、支持多协议、具备强大的路由和请求处理能力，与现有生态系统兼容，提供完善的测试工具和丰富的文档和社区支持，从而实现了构建可扩展、可维护的 Web 服务的简便性和效率。对于目前前后端分离的模式可能用不上它的所有功能，但对于一个通用的web服务搭建还是有非常重要的意义。本篇介绍如何使用nest搭建通用的web服务，运用nest的强大架构能力让前端服务变得更加简单易用</p><h2 id="起步" tabindex="-1">起步 <a class="header-anchor" href="#起步" aria-label="Permalink to &quot;起步&quot;">​</a></h2><p>如果你对Nest还不是很熟悉，请先阅读<a href="/frontend/nestjs/base.html">「Nest的基础文章」</a>，本篇会简单演示一下Nest作为通用web服务的使用技巧，对于每个模块的专业或详细知识点还请参考基础文章、文档</p><p>使用cli创建空的项目：</p><div class="language-sh line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#FFCB6B;">➜</span><span style="color:#C3E88D;"> nest new nest-web</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p><img src="https://ihengshuai-demo1.oss-cn-beijing.aliyuncs.com/2023-08-05%2009.43.40.gif" alt=""></p><p>生成后的项目目录结构大概长这个样子：</p><div class="language-sh line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#FFCB6B;">nest-web</span></span>
<span class="line"><span style="color:#FFCB6B;">├──</span><span style="color:#C3E88D;"> README.md</span></span>
<span class="line"><span style="color:#FFCB6B;">├──</span><span style="color:#C3E88D;"> nest-cli.json</span></span>
<span class="line"><span style="color:#FFCB6B;">├──</span><span style="color:#C3E88D;"> package.json</span></span>
<span class="line"><span style="color:#FFCB6B;">├──</span><span style="color:#C3E88D;"> src # 业务代码</span></span>
<span class="line"><span style="color:#FFCB6B;">│</span><span style="color:#C3E88D;">	├── app.controller.spec.ts</span></span>
<span class="line"><span style="color:#FFCB6B;">│</span><span style="color:#C3E88D;">	├── app.controller.ts</span></span>
<span class="line"><span style="color:#FFCB6B;">│</span><span style="color:#C3E88D;">	├── app.module.ts</span></span>
<span class="line"><span style="color:#FFCB6B;">│</span><span style="color:#C3E88D;">	├── app.service.ts</span></span>
<span class="line"><span style="color:#FFCB6B;">│</span><span style="color:#C3E88D;">	└── main.ts</span></span>
<span class="line"><span style="color:#FFCB6B;">├──</span><span style="color:#C3E88D;"> test # 测试相关</span></span>
<span class="line"><span style="color:#FFCB6B;">│</span><span style="color:#C3E88D;">	├── app.e2e-spec.ts</span></span>
<span class="line"><span style="color:#FFCB6B;">│</span><span style="color:#C3E88D;">	└── jest-e2e.json</span></span>
<span class="line"><span style="color:#FFCB6B;">├──</span><span style="color:#C3E88D;"> tsconfig.build.json</span></span>
<span class="line"><span style="color:#FFCB6B;">└──</span><span style="color:#C3E88D;"> tsconfig.json</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>这里我们将目录结构过一个简单的整理，以便统一规划管理：</p><div class="language-sh line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#FFCB6B;">├──</span><span style="color:#C3E88D;"> Dockerfile # 应用部署镜像</span></span>
<span class="line"><span style="color:#FFCB6B;">├──</span><span style="color:#C3E88D;"> README.md</span></span>
<span class="line"><span style="color:#FFCB6B;">├──</span><span style="color:#C3E88D;"> nest-cli.json</span></span>
<span class="line"><span style="color:#FFCB6B;">├──</span><span style="color:#C3E88D;"> package.json</span></span>
<span class="line"><span style="color:#FFCB6B;">├──</span><span style="color:#C3E88D;"> pm2.json # pm2部署脚本</span></span>
<span class="line"><span style="color:#FFCB6B;">├──</span><span style="color:#C3E88D;"> public # 静态资源</span></span>
<span class="line"><span style="color:#FFCB6B;">├──</span><span style="color:#C3E88D;"> src</span></span>
<span class="line"><span style="color:#FFCB6B;">│</span><span style="color:#C3E88D;">	├── app.controller.ts # 主控制器</span></span>
<span class="line"><span style="color:#FFCB6B;">│</span><span style="color:#C3E88D;">	├── app.module.ts # 主模块</span></span>
<span class="line"><span style="color:#FFCB6B;">│</span><span style="color:#C3E88D;">	├── app.service.ts # 主服务</span></span>
<span class="line"><span style="color:#FFCB6B;">│</span><span style="color:#C3E88D;">	├── common # 通用的一些配置</span></span>
<span class="line"><span style="color:#FFCB6B;">│</span><span style="color:#C3E88D;">	│	├── decorator</span></span>
<span class="line"><span style="color:#FFCB6B;">│</span><span style="color:#C3E88D;">	│	├── filter</span></span>
<span class="line"><span style="color:#FFCB6B;">│</span><span style="color:#C3E88D;">	│	├── guard</span></span>
<span class="line"><span style="color:#FFCB6B;">│</span><span style="color:#C3E88D;">	│	├── i18n</span></span>
<span class="line"><span style="color:#FFCB6B;">│</span><span style="color:#C3E88D;">	│	├── interceptor</span></span>
<span class="line"><span style="color:#FFCB6B;">│</span><span style="color:#C3E88D;">	│	├── middleware</span></span>
<span class="line"><span style="color:#FFCB6B;">│</span><span style="color:#C3E88D;">	│	└── pipe</span></span>
<span class="line"><span style="color:#FFCB6B;">│</span><span style="color:#C3E88D;">	├── config.ts # 应用配置文件</span></span>
<span class="line"><span style="color:#FFCB6B;">│</span><span style="color:#C3E88D;">	├── constants # 常量</span></span>
<span class="line"><span style="color:#FFCB6B;">│</span><span style="color:#C3E88D;">	├── i18n # 语言包</span></span>
<span class="line"><span style="color:#FFCB6B;">│</span><span style="color:#C3E88D;">	├── main.ts # 程序入口</span></span>
<span class="line"><span style="color:#FFCB6B;">│</span><span style="color:#C3E88D;">	├── modules # 按模块划分</span></span>
<span class="line"><span style="color:#FFCB6B;">│</span><span style="color:#C3E88D;">	│	├── common # 通用的模块，可以将通用的工具放入通用模块里</span></span>
<span class="line"><span style="color:#FFCB6B;">│</span><span style="color:#C3E88D;">	│	└── test # 某个功能模块</span></span>
<span class="line"><span style="color:#FFCB6B;">│</span><span style="color:#C3E88D;">	│	    ├── test.controller.ts</span></span>
<span class="line"><span style="color:#FFCB6B;">│</span><span style="color:#C3E88D;">	│	    ├── test.module.ts</span></span>
<span class="line"><span style="color:#FFCB6B;">│</span><span style="color:#C3E88D;">	│	    └── test.service.ts</span></span>
<span class="line"><span style="color:#FFCB6B;">│</span><span style="color:#C3E88D;">	├── typings # ts类型</span></span>
<span class="line"><span style="color:#FFCB6B;">│</span><span style="color:#C3E88D;">	├── utils # 工具包</span></span>
<span class="line"><span style="color:#FFCB6B;">│</span><span style="color:#C3E88D;">	└── views # 版本引擎</span></span>
<span class="line"><span style="color:#FFCB6B;">├──</span><span style="color:#C3E88D;"> test # 测试</span></span>
<span class="line"><span style="color:#FFCB6B;">├──</span><span style="color:#C3E88D;"> tsconfig.build.json</span></span>
<span class="line"><span style="color:#FFCB6B;">├──</span><span style="color:#C3E88D;"> tsconfig.json</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><h2 id="路由配置" tabindex="-1">路由配置 <a class="header-anchor" href="#路由配置" aria-label="Permalink to &quot;路由配置&quot;">​</a></h2><p>这里不推荐在<code>main.controller</code>中创建业务相关的路由，除非是一些应用级别的配置之类的，尽量不要污染全局共用的模块，这样对于后续的维护也会大大降低成本</p><p>这里假如我们要创建一个有关用户信息模块的功能，可以将用户相关的功能单独划分一个模块：</p><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#676E95;font-style:italic;">// 用户路由</span></span>
<span class="line"><span style="color:#89DDFF;">@</span><span style="color:#82AAFF;">Controller</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> path</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">user</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;"> }</span><span style="color:#BABED8;">)</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#C792EA;"> class</span><span style="color:#FFCB6B;"> UserController</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#C792EA;">  constructor</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">private</span><span style="color:#C792EA;"> readonly</span><span style="color:#BABED8;font-style:italic;"> userService</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> UserService</span><span style="color:#89DDFF;">)</span><span style="color:#89DDFF;"> {}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  // 获取用户信息</span></span>
<span class="line"><span style="color:#89DDFF;">  @</span><span style="color:#82AAFF;">Get</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">/:id</span><span style="color:#89DDFF;">&#39;</span><span style="color:#BABED8;">)</span></span>
<span class="line"><span style="color:#F07178;">  getUserInfo</span><span style="color:#89DDFF;">()</span><span style="color:#89DDFF;"> {}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><blockquote><p>其他关于Controller中的配置请参考我nest基础文章</p></blockquote><h2 id="服务配置" tabindex="-1">服务配置 <a class="header-anchor" href="#服务配置" aria-label="Permalink to &quot;服务配置&quot;">​</a></h2><p>通常一个功能模块中包含Controller、Service模块，关于service大家应该知道主要是为Controller提供数据的，一般是对数据库的数据进行增删改查然后返回给Controller的。但是对于一个前端来说service通常不会用到，不过在作为BFF的情况下也是可以的，请根据具体场景调整</p><p>假设这里创建一个用户相关的服务：</p><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#89DDFF;">@</span><span style="color:#82AAFF;">Injectable</span><span style="color:#BABED8;">()</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#C792EA;"> class</span><span style="color:#FFCB6B;"> UserService</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#F07178;">  getUserInfo</span><span style="color:#89DDFF;">():</span><span style="color:#FFCB6B;"> string</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">    return</span><span style="color:#89DDFF;"> {</span><span style="color:#F07178;"> id</span><span style="color:#89DDFF;">:</span><span style="color:#F78C6C;"> 1</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> name</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">nestjs</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;"> };</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h2 id="应用配置" tabindex="-1">应用配置 <a class="header-anchor" href="#应用配置" aria-label="Permalink to &quot;应用配置&quot;">​</a></h2><p>有了路由只是程序的基础功能，对于一个便于扩展和健壮的web应用来说配置是少不了的，如：配置文件、异常处理、日志收集、拦截器等等</p><h3 id="配置文件" tabindex="-1">配置文件 <a class="header-anchor" href="#配置文件" aria-label="Permalink to &quot;配置文件&quot;">​</a></h3><p>一般项目中都会有一个配置文件来灵活处理项目，统一配置对于所有的开发者都是透明的，不会有黑箱操作产生奇怪的问题。配置文件是项目共用的，可以将其放入公共模块共享</p><p>通常配置文件都会使用<code>.env</code>文件进行配置，这个已经成了约定的做法，但仅仅env文件是不够的还需要对配置文件进行容错处理，因此还要单独的创建一个配置文件来处理默认的配置</p><p>对于以上观点先创建功能模块存放共享的内容：</p><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#676E95;font-style:italic;">// src/modules/common/common.module</span></span>
<span class="line"><span style="color:#89DDFF;">@</span><span style="color:#82AAFF;">Module</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">  ConfigModule.forRoot(</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#FFCB6B;">    load</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> [</span><span style="color:#BABED8;">GlobalConfiguration</span><span style="color:#F07178;">]</span><span style="color:#89DDFF;">,</span><span style="color:#676E95;font-style:italic;"> // 加载自定义配置文件</span></span>
<span class="line"><span style="color:#FFCB6B;">    validationSchema</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> Joi</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">object</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">      PORT</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> Joi</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">number</span><span style="color:#F07178;">()</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">      NODE_ENV</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> Joi</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">string</span><span style="color:#F07178;">()</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">valid</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">development</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">production</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">testing</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">required</span><span style="color:#F07178;">()</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">    }</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span><span style="color:#BABED8;">)</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#BABED8;">)</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#C792EA;"> class</span><span style="color:#FFCB6B;"> CommonModule</span><span style="color:#C792EA;"> implements</span><span style="color:#FFCB6B;"> NestModule</span><span style="color:#89DDFF;"> {}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>创建配置文件：ConfigModule读取当前文件，此文件我们会进行默认值的处理</p><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#676E95;font-style:italic;">// 全局共享配置</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#C792EA;"> const</span><span style="color:#BABED8;"> GlobalConfiguration </span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;"> ()</span><span style="color:#C792EA;"> =&gt;</span><span style="color:#BABED8;"> (</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  __is_Prod__</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> process</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">env</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">NODE_ENV </span><span style="color:#89DDFF;">===</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">production</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">  __is_Dev__</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> process</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">env</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">NODE_ENV </span><span style="color:#89DDFF;">!==</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">production</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">  NODE_ENV</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> process</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">env</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">NODE_ENV</span><span style="color:#89DDFF;">?.</span><span style="color:#BABED8;">length </span><span style="color:#89DDFF;">?</span><span style="color:#BABED8;"> process</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">env</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">NODE_ENV </span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">development</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">  PORT</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> (process</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">env</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">PORT </span><span style="color:#89DDFF;">||</span><span style="color:#F78C6C;"> 5000</span><span style="color:#BABED8;">) </span><span style="color:#89DDFF;font-style:italic;">as</span><span style="color:#FFCB6B;"> number</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">  DEFAULT_LANGUAGE</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> process</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">env</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">DEFAULT_LANGUAGE </span><span style="color:#89DDFF;">||</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">en</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#BABED8;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// 数据库配置</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#C792EA;"> const</span><span style="color:#BABED8;"> DatabaseConfiguration </span><span style="color:#89DDFF;">=</span><span style="color:#82AAFF;"> registerAs</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">db</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;"> ()</span><span style="color:#C792EA;"> =&gt;</span><span style="color:#BABED8;"> (</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  host</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> process</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">env</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">DB_HOST </span><span style="color:#89DDFF;">||</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">localhost</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#BABED8;">))</span><span style="color:#89DDFF;">;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>除了基本的配置外还可以对配置文件的值进行校验，以便友好的引导开发者修改配置，这里可以使用Joi进行验证，具体的请参考基础文章</p><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#89DDFF;">@</span><span style="color:#82AAFF;">Module</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">  ConfigModule.forRoot(</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#FFCB6B;">    validationSchema</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> Joi</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">object</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">      PORT</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> Joi</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">number</span><span style="color:#F07178;">()</span><span style="color:#89DDFF;">,</span><span style="color:#676E95;font-style:italic;"> // 变成数字</span></span>
<span class="line"><span style="color:#F07178;">      NODE_ENV</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> Joi</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">string</span><span style="color:#F07178;">()</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">valid</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">development</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">production</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">testing</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">required</span><span style="color:#F07178;">()</span><span style="color:#89DDFF;">,</span><span style="color:#676E95;font-style:italic;"> // 限制指定的值</span></span>
<span class="line"><span style="color:#89DDFF;">    }</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span><span style="color:#BABED8;">)</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#BABED8;">)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="内置功能" tabindex="-1">内置功能 <a class="header-anchor" href="#内置功能" aria-label="Permalink to &quot;内置功能&quot;">​</a></h3><p>说完基本的项目配置文件后，接下来就要针对项目做一些健壮性的配置了，如：中间件、日志、过滤器、拦截器、转换器等等，这里已经在<a href="/frontend/nestjs/base.html">「Nest的基础文章」</a> 讲过了，不再赘述</p><h2 id="模板引擎" tabindex="-1">模板引擎 <a class="header-anchor" href="#模板引擎" aria-label="Permalink to &quot;模板引擎&quot;">​</a></h2><p>以上都是将nest作为类似api服务进行使用，但是对于前端来说这种场景很少用到，而用的比较多的还是使用node渲染页面这种场景。其实nest也是支持页面渲染的，类似于以前的jsp、php这种ssr模式，而对于页面渲染不和后端冗余一起对前端更有好点，现在的前后端模式已经和后端分开处理了，之间只以api进行交流</p><p>现在的页面渲染以完全有前端来处理了，相继也出现csr、ssr等多种渲染模式，使用nest可以很好的实现多种渲染模式如：传统的模板、(vue/react)ssr等等，这里只讲模板引擎</p><p>这里我们使用<a href="https://ejs.co" target="_blank" rel="noreferrer">ejs</a>作为页面模板引擎</p><div class="language-sh line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#FFCB6B;">➜</span><span style="color:#C3E88D;"> yarn add ejs</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>配置模板引擎：</p><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#676E95;font-style:italic;">// main</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// 模板引擎文件夹</span></span>
<span class="line"><span style="color:#BABED8;">app</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setBaseViewsDir</span><span style="color:#BABED8;">(</span><span style="color:#82AAFF;">join</span><span style="color:#BABED8;">(__dirname</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">./views</span><span style="color:#89DDFF;">&#39;</span><span style="color:#BABED8;">))</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// ejs视图引擎</span></span>
<span class="line"><span style="color:#BABED8;">app</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setViewEngine</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">ejs</span><span style="color:#89DDFF;">&#39;</span><span style="color:#BABED8;">)</span><span style="color:#89DDFF;">;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>页面模板：</p><div class="language-html line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">html</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#BABED8;">// views/user.ejs</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;!</span><span style="color:#F07178;">DOCTYPE</span><span style="color:#C792EA;"> html</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">html</span><span style="color:#C792EA;"> lang</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">en</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">head</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">  &lt;</span><span style="color:#F07178;">meta</span><span style="color:#C792EA;"> charset</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">UTF-8</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">  &lt;</span><span style="color:#F07178;">meta</span><span style="color:#C792EA;"> name</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">viewport</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C792EA;"> content</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">width=device-width, initial-scale=1.0</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">  &lt;</span><span style="color:#F07178;">title</span><span style="color:#89DDFF;">&gt;</span><span style="color:#BABED8;">&lt;%= data.title %&gt;</span><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">title</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">  &lt;</span><span style="color:#F07178;">link</span><span style="color:#C792EA;"> rel</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">shortcut icon</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C792EA;"> href</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">/favicon.ico</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C792EA;"> type</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">image/x-icon</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">head</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">body</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">	&lt;</span><span style="color:#F07178;">h1</span><span style="color:#89DDFF;">&gt;</span><span style="color:#BABED8;">user页面</span><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">h1</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">	&lt;!-- 一些ejs模版语法 --&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">body</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">html</span><span style="color:#89DDFF;">&gt;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><blockquote><p>关于ejs的模板语法请自行翻阅相关文档</p></blockquote><p>路由渲染：</p><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#676E95;font-style:italic;">// 用户路由</span></span>
<span class="line"><span style="color:#89DDFF;">@</span><span style="color:#82AAFF;">Controller</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> path</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">user</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;"> }</span><span style="color:#BABED8;">)</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#C792EA;"> class</span><span style="color:#FFCB6B;"> UserController</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  // 渲染用户页面</span></span>
<span class="line"><span style="color:#89DDFF;">  @</span><span style="color:#82AAFF;">Get</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">/detail/page</span><span style="color:#89DDFF;">&#39;</span><span style="color:#BABED8;">)</span></span>
<span class="line"><span style="color:#89DDFF;">  @</span><span style="color:#82AAFF;">Render</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">user</span><span style="color:#89DDFF;">&#39;</span><span style="color:#BABED8;">) </span><span style="color:#676E95;font-style:italic;">// 渲染user.ejs，这里对应 模板引擎文件夹下的文件路径</span></span>
<span class="line"><span style="color:#F07178;">  getUserInfo</span><span style="color:#89DDFF;">()</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">  	return</span><span style="color:#89DDFF;"> {};</span><span style="color:#676E95;font-style:italic;"> // 返回的数据可以在模板引擎中拿到</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h2 id="国际化" tabindex="-1">国际化 <a class="header-anchor" href="#国际化" aria-label="Permalink to &quot;国际化&quot;">​</a></h2><p>国际化已经成了现在项目必不可少的功能，在nest中也可以很好的使用i18n的功能，由于官方并没有提供i18n的服务，这里暂时使用了<a href="https://nestjs-i18n.com" target="_blank" rel="noreferrer">第三方的工具包</a></p><div class="language-sh line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#FFCB6B;">➜</span><span style="color:#C3E88D;"> yarn add nestjs-i18n</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h3 id="注册" tabindex="-1">注册 <a class="header-anchor" href="#注册" aria-label="Permalink to &quot;注册&quot;">​</a></h3><p>i18n也属于项目的公共部分，可以将其放入公共模块</p><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#676E95;font-style:italic;">// modules/common/common.module</span></span>
<span class="line"><span style="color:#89DDFF;">@</span><span style="color:#82AAFF;">Module</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  imports</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> [</span></span>
<span class="line"><span style="color:#BABED8;">    I18nModule</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">forRoot</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">      fallbackLanguage</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> globalConfiguration</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">DEFAULT_LANGUAGE</span><span style="color:#89DDFF;">,</span><span style="color:#676E95;font-style:italic;"> // 默认语言</span></span>
<span class="line"><span style="color:#F07178;">      loaderOptions</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> {</span><span style="color:#676E95;font-style:italic;"> // 语言包位置</span></span>
<span class="line"><span style="color:#F07178;">        path</span><span style="color:#89DDFF;">:</span><span style="color:#82AAFF;"> resolve</span><span style="color:#BABED8;">(__dirname</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">../../i18n/</span><span style="color:#89DDFF;">&#39;</span><span style="color:#BABED8;">)</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">        watch</span><span style="color:#89DDFF;">:</span><span style="color:#FF9CAC;"> false</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">      },</span></span>
<span class="line"><span style="color:#F07178;">      fallbacks</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> {</span><span style="color:#676E95;font-style:italic;"> // 对于i18n没有resolve没有匹配到的语言，使用当前集合进行映射处理</span></span>
<span class="line"><span style="color:#89DDFF;">        &#39;</span><span style="color:#F07178;">zh-cn</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">zh</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">        &#39;</span><span style="color:#F07178;">zh-*</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">zh_hk</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">        zh</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">zh_hk</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">        &#39;</span><span style="color:#F07178;">en-*</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">en</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">        &#39;</span><span style="color:#F07178;">ko-*</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">ko</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">        &#39;</span><span style="color:#F07178;">ja-*</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">ja</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">        &#39;</span><span style="color:#F07178;">es-*</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">es</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">      },</span></span>
<span class="line"><span style="color:#F07178;">      resolvers</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> [CustomI18nResolver]</span><span style="color:#89DDFF;">,</span><span style="color:#676E95;font-style:italic;"> // 自定义语言的匹配规则</span></span>
<span class="line"><span style="color:#F07178;">      viewEngine</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">ejs</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#676E95;font-style:italic;"> // 模版引擎用的ejs</span></span>
<span class="line"><span style="color:#89DDFF;">    }</span><span style="color:#BABED8;">)</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#BABED8;">  ]</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#BABED8;">)</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#C792EA;"> class</span><span style="color:#FFCB6B;"> CommonModule</span><span style="color:#89DDFF;"> {}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><h3 id="语言匹配" tabindex="-1">语言匹配 <a class="header-anchor" href="#语言匹配" aria-label="Permalink to &quot;语言匹配&quot;">​</a></h3><p>由于每个项目或者业务的不同语言匹配也需要定制化，这里就来自定义语言的匹配规则</p><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#676E95;font-style:italic;">// src/common/i18n/custom-i18n-resolver.ts</span></span>
<span class="line"><span style="color:#89DDFF;">@</span><span style="color:#82AAFF;">Injectable</span><span style="color:#BABED8;">()</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#C792EA;"> class</span><span style="color:#FFCB6B;"> CustomI18nResolver</span><span style="color:#C792EA;"> implements</span><span style="color:#FFCB6B;"> I18nResolver</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#F07178;">  resolve</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">context</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> ExecutionContext</span><span style="color:#89DDFF;">):</span><span style="color:#FFCB6B;"> string</span><span style="color:#89DDFF;"> |</span><span style="color:#FFCB6B;"> string</span><span style="color:#BABED8;">[] </span><span style="color:#89DDFF;">|</span><span style="color:#FFCB6B;"> Promise</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">string</span><span style="color:#89DDFF;"> |</span><span style="color:#FFCB6B;"> string</span><span style="color:#BABED8;">[]</span><span style="color:#89DDFF;">&gt;</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#C792EA;">    const</span><span style="color:#BABED8;"> ctx</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> context</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">switchToHttp</span><span style="color:#F07178;">()</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#C792EA;">    const</span><span style="color:#BABED8;"> request</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> ctx</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getRequest</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">Request</span><span style="color:#89DDFF;">&gt;</span><span style="color:#F07178;">()</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    // TODO: 这里简单的对语言值进行判断，根据实际业务调整</span></span>
<span class="line"><span style="color:#C792EA;">    let</span><span style="color:#BABED8;"> locale</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> request</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">params</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">locale</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">    if</span><span style="color:#F07178;"> (</span><span style="color:#89DDFF;">!</span><span style="color:#BABED8;">locale</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">      locale</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> request</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">query</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">locale</span><span style="color:#89DDFF;font-style:italic;"> as</span><span style="color:#FFCB6B;"> string</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">    }</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">    if</span><span style="color:#F07178;"> (</span><span style="color:#89DDFF;">!</span><span style="color:#BABED8;">locale</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#C792EA;">      const</span><span style="color:#BABED8;"> acceptLang</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> request</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">headers</span><span style="color:#F07178;">[</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">accept-language</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">]</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#BABED8;">      locale</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> acceptLang</span><span style="color:#89DDFF;">?.</span><span style="color:#82AAFF;">split</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">,</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">?.</span><span style="color:#F07178;">[</span><span style="color:#F78C6C;">0</span><span style="color:#F07178;">] </span><span style="color:#89DDFF;">||</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">en</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">    }</span></span>
<span class="line"><span style="color:#BABED8;">    locale</span><span style="color:#89DDFF;"> =</span><span style="color:#BABED8;"> locale</span><span style="color:#89DDFF;">?.</span><span style="color:#82AAFF;">replace</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">/</span><span style="color:#C3E88D;">-</span><span style="color:#89DDFF;">/</span><span style="color:#F78C6C;">i</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">_</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">    if</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">locale</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">startsWith</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">zh</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">)) </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">zh</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">    return</span><span style="color:#89DDFF;"> &#39;</span><span style="color:#C3E88D;">en</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h3 id="控制器使用" tabindex="-1">控制器使用 <a class="header-anchor" href="#控制器使用" aria-label="Permalink to &quot;控制器使用&quot;">​</a></h3><div class="language-ts line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#89DDFF;">@</span><span style="color:#82AAFF;">Controller</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">user</span><span style="color:#89DDFF;">&#39;</span><span style="color:#BABED8;">)</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#C792EA;"> class</span><span style="color:#FFCB6B;"> UserController</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#89DDFF;">  @</span><span style="color:#82AAFF;">Get</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">page</span><span style="color:#89DDFF;">&#39;</span><span style="color:#BABED8;">)</span></span>
<span class="line"><span style="color:#89DDFF;">  @</span><span style="color:#82AAFF;">Render</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">index</span><span style="color:#89DDFF;">&#39;</span><span style="color:#BABED8;">)</span></span>
<span class="line"><span style="color:#C792EA;">  async</span><span style="color:#F07178;"> renderPage</span><span style="color:#89DDFF;">(@</span><span style="color:#82AAFF;">I18n</span><span style="color:#BABED8;">() </span><span style="color:#BABED8;font-style:italic;">i18n</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;"> I18nContext</span><span style="color:#89DDFF;">)</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">    return</span><span style="color:#89DDFF;"> {</span></span>
<span class="line"><span style="color:#F07178;">      title</span><span style="color:#89DDFF;">:</span><span style="color:#89DDFF;font-style:italic;"> await</span><span style="color:#BABED8;"> i18n</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">t</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">common.title</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">,</span><span style="color:#676E95;font-style:italic;"> // 和前端中使用i18n一样</span></span>
<span class="line"><span style="color:#89DDFF;">    };</span></span>
<span class="line"><span style="color:#89DDFF;">  }</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="语言包" tabindex="-1">语言包 <a class="header-anchor" href="#语言包" aria-label="Permalink to &quot;语言包&quot;">​</a></h3><p>有了i18n还需要语言包，一般都是语言包都是以json的形式按语言划分在不同的文件夹中</p><div class="language-sh line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme-palenight vp-code"><code><span class="line"><span style="color:#FFCB6B;">src/i18n</span></span>
<span class="line"><span style="color:#FFCB6B;">├──</span><span style="color:#C3E88D;"> en // 英文</span></span>
<span class="line"><span style="color:#FFCB6B;">│</span><span style="color:#C3E88D;">	└── common.json # common. 开头的</span></span>
<span class="line"><span style="color:#FFCB6B;">└──</span><span style="color:#C3E88D;"> zh // 中文</span></span>
<span class="line"><span style="color:#FFCB6B;">    └──</span><span style="color:#C3E88D;"> common.json</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><blockquote><p>更多关于i18n的用法请查阅<a href="https://nestjs-i18n.com" target="_blank" rel="noreferrer">相关文档</a></p></blockquote><h2 id="其他" tabindex="-1">其他 <a class="header-anchor" href="#其他" aria-label="Permalink to &quot;其他&quot;">​</a></h2><p>对于一个通用型的传统的前端服务来说以上已经足够用了，可能还有些其他的小配置或性能优化的方面需要处理，你可以参考我的<a href="/frontend/nestjs/useful.html">「Nest的实用技巧」</a>。而比如偏后端的使用如数据库相关、结合vue/react ssr的参考后续文章</p>`,62);function F(D,y,i,b,u,B){const a=n("Reward"),l=n("Gitalk");return r(),e("div",null,[c,s(a),s(l)])}const E=p(t,[["render",F]]);export{d as __pageData,E as default};
